Pràctica 2 - Sessió 1 - Implementar un servei DNS. (Luque Díaz Itiel)


# PROGRAMARI NECESSARI
----------------------

* Editor de textos (Gedit p.exemple)
* nano/pico (opcionalment)
* bind9 (apt-get install bind9)


# FITXER RELACIONATS
--------------------

* /etc/bind/named.conf.local		-->	Configuració general de les zones.
* /etc/bind/db.empty				--> Plantilla de configuració d'una zona.
* /etc/bind/name.conf.options		--> Configuracions del dns bind9.
* /etc/bind/directes-seax.edu		--> Base de dades amb les resolucions directes (nom->ip).
* /etc/bind/inverses-seax.edu		--> Base de dades amb les resolucions inverses (ip->nom).
* /var/cache/bind/named_dump.db		-->	Cache local del servidor DNS


# ESCENARI
----------
* Domini principal		--> seax.edu
* Subdomini				--> classe.seax.edu
* DNS màster 			--> 192.168.56.104/24
* DNS slave				--> 192.168.56.102/24
* DNS delegat màster 	--> 192.168.56.102/24
* DNS delegat slave 	--> 192.168.56.104/24


# DESCRIPCIÓ
------------

Com a persones humanes tenim més facilitat de recordar noms que no pas una ristra de números, per això, es va inventar els servidors DNS 
que ajuden a permetre que a partir d'un nom saber quina direcció ip té assignada un equip/servidor o una xarxa. També ho permet en
sentit contrari, és a dir, a partir d'una ip saber quin nom té associat (ha d'estar configurat).


# CONFIGURACIÓ SERVIDOR DNS
---------------------------

El servidor per defecte no fa forwarding, és a dir, no té cap altre servidor delegat a qui dirigir les peticions que no coneix.
Normalment es solen possar els dns de l'ISP.
Per tant, pregunta al servidors root en quin Top Domain Level trobar-la i comença a fer peticions als encarregats de zona de manera
iterativa.
També per defecte ja fa de memòria cau. 

Les zones inverses i directes s'han d'establir en el fitxer /etc/bind/named.conf.local i es recomanable possar-les fora d'aquest, de manera
que pugui ser mantenible en el temps.
La següent configuració és per a la màquina que farà de màster i que vol transmetre les zones a l'esclau amb les directives pertinents:

	root@monitor:/etc/bind# cat named.conf.local 
	//
	// Do any local configuration here
	//

	// Consider adding the 1918 zones here, if they are not used in your
	// organization
	//include "/etc/bind/zones.rfc1918";

	zone "seax.edu" {
		type master;
		file "/etc/bind/directes-seax.edu";
		allow-transfer {192.168.56.102;};
		also-notify {192.168.56.102;};
	};

	zone "56.168.192.in-addr.arpa" {
		type master;
		file "/etc/bind/inverses-seax.edu";
		allow-transfer {192.168.56.102;};
		also-notify {192.168.56.102;};
	};
	root@monitor:/etc/bind#

Es de bona pràctica indicar que el subdomini dns apunta a la direcció del màster.
Mostreig de la configuració de cada zona:

	root@monitor:/etc/bind# cat directes-seax.edu 
	; BIND reverse data file for empty rfc1918 zone
	;
	; DO NOT EDIT THIS FILE - it is used for multiple zones.
	; Instead, copy it, edit named.conf, and use that copy.
	;
	$TTL	86400
	@	IN	SOA	seax.edu. root.seax.edu. (
					  1		; Serial
				 604800		; Refresh
				  86400		; Retry
				2419200		; Expire
				  86400 )	; Negative Cache TTL
	;
	@	IN	NS	dns.seax.edu.
	@	IN	NS	dns2.seax.edu.

	seax.edu.	IN	A	192.168.56.104
	dns			IN	A	192.168.56.104
	dns2		IN	A	192.168.56.102
	itiel		IN	A	192.168.56.200
	root@monitor:/etc/bind#

	root@monitor:/etc/bind# cat inverses-seax.edu 
	; BIND reverse data file for empty rfc1918 zone
	;
	; DO NOT EDIT THIS FILE - it is used for multiple zones.
	; Instead, copy it, edit named.conf, and use that copy.
	;
	$TTL	86400
	@	IN	SOA	seax.edu. root.seax.edu. (
					  1		; Serial
				 604800		; Refresh
				  86400		; Retry
				2419200		; Expire
				  86400 )	; Negative Cache TTL
	;
	@	IN	NS	dns.seax.edu.

	104	IN	PTR	seax.edu.
	104	IN	PTR	dns
	200	IN	PTR	itiel

	root@monitor:/etc/bind#

Per tal de comprovar la sintaxis dels fitxers, existeixen dues comandes potents que ajuden a averiguar si tot està correcte:

	root@monitor:/etc/bind# named-checkconf named.conf.local 
	root@monitor:/etc/bind#

	root@monitor:/etc/bind# named-checkzone seax.edu directes-seax.edu 
	zone seax.edu/IN: loaded serial 1
	OK
	root@monitor:/etc/bind#

	NOTA: Només serveix per a les zones directes.

En quant a la part del servidor esclau, es configura del mateix mode, però, sense crear les bases de dades, ja que la gràcia és obternir-les
del màster.
S'ha afegit el directori "slave" amb propietari i grup bind per emmagatzemar les zones perquè dona problemes de permissos al escriure la còpia
de la base de dades que s'ha rebut.
Es necessari indicar l'ip del màster per poder obtenir-les:

	root@monitor:/etc/bind# cat named.conf.local 
	//
	// Do any local configuration here
	//

	// Consider adding the 1918 zones here, if they are not used in your
	// organization
	//include "/etc/bind/zones.rfc1918";

	zone "seax.edu" {
		type slave;
		file "/etc/bind/slave/directes-seax.edu";
		masters {192.168.56.104;};	
	};

	zone "56.168.192.in-addr.arpa" {
		type slave;
		file "/etc/bind/slave/inverses-seax.edu";
		masters {192.168.56.104;};
	};
	root@monitor:/etc/bind#

	NOTA: A les inverses tant en el màster com l'esclau se li ha indicat nomès tres octets de les adreces ip perquè la xarxa serà un /24, per tant,
		  indirectament s'està indicant en la zona.

En la següent captura es mostra el resultat de la resolució d'un nom contra el màster, en les següents, una comparativa entre màster i esclau.
El resultat és una diferencia en quant a instant de la petició i l'identificador dels headers, la resta és identic:

	itiel@X550JX:~$ dig @192.168.56.104 itiel.seax.edu

	; <<>> DiG 9.11.3-1ubuntu1.5-Ubuntu <<>> @192.168.56.104 itiel.seax.edu
	; (1 server found)
	;; global options: +cmd
	;; Got answer:
	;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 30423
	;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 2

	;; OPT PSEUDOSECTION:
	; EDNS: version: 0, flags:; udp: 4096
	;; QUESTION SECTION:
	;itiel.seax.edu.			IN	A

	;; ANSWER SECTION:
	itiel.seax.edu.		86400	IN	A	192.168.56.200

	;; AUTHORITY SECTION:
	seax.edu.		86400	IN	NS	dns2.seax.edu.
	seax.edu.		86400	IN	NS	dns.seax.edu.

	;; ADDITIONAL SECTION:
	dns.seax.edu.		86400	IN	A	192.168.56.104
	dns2.seax.edu.		86400	IN	A	192.168.56.102

	;; Query time: 0 msec
	;; SERVER: 192.168.56.104#53(192.168.56.104)
	;; WHEN: Thu Mar 14 14:27:19 CET 2019
	;; MSG SIZE  rcvd: 93

	itiel@X550JX:~$ dig @192.168.56.104 itiel.seax.edu > master.txt
	itiel@X550JX:~$ dig @192.168.56.102 itiel.seax.edu > esclau.txt
	itiel@X550JX:~$ diff master.txt esclau.txt 
	2c2
	< ; <<>> DiG 9.11.3-1ubuntu1.5-Ubuntu <<>> @192.168.56.104 itiel.seax.edu
	---
	> ; <<>> DiG 9.11.3-1ubuntu1.5-Ubuntu <<>> @192.168.56.102 itiel.seax.edu
	6c6
	< ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 14650
	---
	> ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 53087
	24,25c24,25
	< ;; SERVER: 192.168.56.104#53(192.168.56.104)
	< ;; WHEN: Thu Mar 14 14:28:57 CET 2019
	---
	> ;; SERVER: 192.168.56.102#53(192.168.56.102)
	> ;; WHEN: Thu Mar 14 14:28:50 CET 2019
	itiel@X550JX:~$

Prova de la configuració de les inverses:

	itiel@X550JX:~$ dig @192.168.56.104 -x 192.168.56.200 +short
	itiel.56.168.192.in-addr.arpa.
	itiel@X550JX:~$ dig @192.168.56.104 -x 192.168.56.104 +short
	seax.edu.
	dns.56.168.192.in-addr.arpa.
	itiel@X550JX:~$

Cada cop que l'administrador afegeix/modifica/elimina un registre, ha d'incrementar el serial per notificar als
servidors esclaus. Per fer efectuar la notificació és necessari recarregar els fitxers de configuració:

	root@monitor:~# service bind9 reload
	root@monitor:~#

Per evitar problemàtiques és molt important seguir les RFC que diuen que el serial hauría de formar-se per la
combinació de l'any, mes, dia més un número incremental (yyyymmddss).


Per comprovar que el funcionament màster-esclau és el correcte, es pot fer servir l'eina "tcpdump".
En el següent escenari s'ha canviar l'adreça ip del nom "itiel.seax.edu" de 192.168.56.205 a .210, s'ha incrementat el
serial i s'ha tornat a carregar la configuració en el servei.
La captura confirma que s'està produïnt l'intercanvi de la zona afectada del màster cap al esclau, és a dir, l'està
notificant del canvi:

	root@monitor:~# tcpdump -i enp0s9 udp port 53
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on enp0s9, link-type EN10MB (Ethernet), capture size 262144 bytes

	23:31:32.415588 IP X550JX.59182 > 192.168.56.104.domain: 50011+ [1au] A? seax.edu. (49)
	23:31:32.415791 IP 192.168.56.104.domain > X550JX.59182: 50011* 1/1/2 A 192.168.56.104 (87)
	23:32:19.241313 IP X550JX.48162 > 192.168.56.104.domain: 40236+ [1au] A? itiel.seax.edu. (55)
	23:32:19.241572 IP 192.168.56.104.domain > X550JX.48162: 40236* 1/1/2 A 192.168.56.205 (93)
	23:33:07.248432 IP 192.168.56.104.43411 > 192.168.56.102.domain: 45396 notify [b2&3=0x2400] [1a] SOA? seax.edu. (67)
	23:33:07.249029 IP 192.168.56.102.domain > 192.168.56.104.43411: 45396 notify* 0/0/0 (26)
	23:33:07.249198 IP 192.168.56.102.49512 > 192.168.56.104.domain: 35812 [1au] SOA? seax.edu. (37)
	23:33:07.249281 IP 192.168.56.104.domain > 192.168.56.102.49512: 35812* 1/1/2 SOA (112)
	23:33:07.252052 IP 192.168.56.102.42067 > 192.168.56.104.domain: 10818 notify [b2&3=0x2400] [1a] SOA? seax.edu. (67)
	23:33:07.252435 IP 192.168.56.104.domain > 192.168.56.102.42067: 10818 notify* 0/0/0 (26)
	23:33:39.784901 IP X550JX.42735 > 192.168.56.104.domain: 19348+ [1au] A? itiel.seax.edu. (55)
	23:33:39.785206 IP 192.168.56.104.domain > X550JX.42735: 19348* 1/1/2 A 192.168.56.210 (93)
	23:33:47.829056 IP X550JX.35296 > 192.168.56.104.domain: 8370+ [1au] A? itiel.seax.edu. (55)
	23:33:47.829304 IP 192.168.56.104.domain > X550JX.35296: 8370* 1/1/2 A 192.168.56.210 (93)

	^C
	14 packets captured
	14 packets received by filter
	0 packets dropped by kernel
	root@monitor:~#

Per comprovar si s'han efectuat bé els canvis, es disposa a fer la resolució contra el màster i posteriorment contra l'esclau.
S'observa que el canvi s'ha fet correctament:

	itiel@X550JX:~$ dig @192.168.56.104 itiel.seax.edu +short
	192.168.56.210
	itiel@X550JX:~$

	itiel@X550JX:~$ dig @192.168.56.102 itiel.seax.edu +short
	192.168.56.210
	itiel@X550JX:~$

En el següent escenari es disposa a comprovar si realment està funcionant correctament la cache del servidor DNS. S'ha dividit 
en tres peticions, que està reflexat en la captura amb espais.
En primer lloc, es demana la resolució d'un nom de la pròpia zona que manté el servidor.
En segon lloc, es vol resoldre el domini "cocacola.es". Com es pot veure, ha estat necessari fer peticions als servidors arrels
per tractar de trobar qui és l'encarregat de mantindre-ho i finalment arribar al màster de zona.
Per últim, es comprova que s'hagi emmagatzemat localment i es disposa a tornar a fer la consulta. Com mostra el tcpdump, la
resolució es directa i no és necessari sortir a fora:

	root@monitor:~# tcpdump -i any udp port 53
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
	17:31:53.000552 IP X550JX.47754 > 192.168.56.104.domain: 33529+ [1au] A? itiel.seax.edu. (55)
	17:31:53.000743 IP 192.168.56.104.domain > X550JX.47754: 33529* 1/1/2 A 192.168.56.210 (93)
	17:31:53.001209 IP 10.0.2.15.56567 > 10.0.2.3.domain: 3491+ PTR? 104.56.168.192.in-addr.arpa. (45)
	17:31:53.101026 IP 10.0.2.3.domain > 10.0.2.15.56567: 3491 NXDomain 0/0/0 (45)
	17:31:53.101424 IP 10.0.2.15.44669 > 10.0.2.3.domain: 42212+ PTR? 1.56.168.192.in-addr.arpa. (43)
	17:31:53.120736 IP 10.0.2.3.domain > 10.0.2.15.44669: 42212 2/0/0 PTR X550JX., PTR X550JX.local. (89)
	17:31:53.121895 IP 10.0.2.15.49308 > 10.0.2.3.domain: 27639+ PTR? 3.2.0.10.in-addr.arpa. (39)
	17:31:53.179378 IP 10.0.2.3.domain > 10.0.2.15.49308: 27639 NXDomain 0/0/0 (39)
	17:31:53.179731 IP 10.0.2.15.33206 > 10.0.2.3.domain: 32488+ PTR? 15.2.0.10.in-addr.arpa. (40)

	17:32:00.975340 IP X550JX.57374 > 192.168.56.104.domain: 56928+ [1au] A? cocacola.es. (52)
	17:32:00.975864 IP 10.0.2.15.41602 > l.root-servers.net.domain: 52688 [1au] A? cocacola.es. (40)
	17:32:00.975984 IP 10.0.2.15.48720 > l.root-servers.net.domain: 41365 [1au] NS? . (28)
	17:32:00.976075 IP 10.0.2.15.38167 > l.root-servers.net.domain: 62147% [1au] AAAA? E.ROOT-SERVERS.NET. (47)
	17:32:00.976157 IP 10.0.2.15.39400 > l.root-servers.net.domain: 16959% [1au] AAAA? G.ROOT-SERVERS.NET. (47)
	17:32:00.976495 IP 10.0.2.15.43848 > 10.0.2.3.domain: 45135+ PTR? 42.83.7.199.in-addr.arpa. (42)
	17:32:01.025456 IP l.root-servers.net.domain > 10.0.2.15.41602: 52688-| 0/9/1 (281)
	17:32:01.026677 IP l.root-servers.net.domain > 10.0.2.15.38167: 62147*- 1/0/1 AAAA 2001:500:a8::e (75)
	17:32:01.186801 IP 10.0.2.15.33231 > c.root-servers.net.domain: 25216% [1au] A? ns4.ko.com. (39)
	17:32:01.187157 IP 10.0.2.15.60611 > c.root-servers.net.domain: 26326% [1au] AAAA? ns4.ko.com. (39)
	17:32:01.187444 IP 10.0.2.15.48304 > c.root-servers.net.domain: 3683 [1au] NS? . (28)
	17:32:01.187876 IP 10.0.2.15.33055 > c.root-servers.net.domain: 11305% [1au] A? ns3.ko.com. (39)
	17:32:01.188153 IP 10.0.2.15.35069 > c.root-servers.net.domain: 28099% [1au] AAAA? ns3.ko.com. (39)
	17:32:01.188486 IP 10.0.2.15.42618 > c.root-servers.net.domain: 8668% [1au] A? ns2.ko.com. (39)
	17:32:01.188817 IP 10.0.2.15.44492 > c.root-servers.net.domain: 2935% [1au] AAAA? ns2.ko.com. (39)
	17:32:01.378243 IP 10.0.2.15.46308 > ns3.ko.com.domain: 11451% [1au] A? ns4.ko.com. (39)
	17:32:01.378611 IP 10.0.2.15.51299 > 10.0.2.3.domain: 24256+ PTR? 154.84.162.161.in-addr.arpa. (45)
	17:32:01.381794 IP 10.0.2.15.45927 > ns3.ko.com.domain: 57968% [1au] A? ns2.ko.com. (39)
	17:32:01.384126 IP 10.0.2.15.38562 > ns3.ko.com.domain: 34594% [1au] AAAA? ns2.ko.com. (39)
	17:32:01.384898 IP 10.0.2.15.43323 > ns3.ko.com.domain: 47678% [1au] AAAA? ns3.ko.com. (39)
	17:32:01.393108 IP 10.0.2.15.52345 > ns3.ko.com.domain: 37639% [1au] AAAA? ns4.ko.com. (39)
	17:32:01.393466 IP 10.0.2.15.44300 > ns3.ko.com.domain: 61136% [1au] A? ns3.ko.com. (39)
	17:32:01.643794 IP ns4.ko.com.domain > 10.0.2.15.40617: 47684*- 1/0/1 A 52.14.144.171 (56)
	17:32:01.644154 IP 10.0.2.15.59054 > 10.0.2.3.domain: 38675+ PTR? 151.92.162.161.in-addr.arpa. (45)
	17:32:01.645949 IP 10.0.2.15.58767 > i.root-servers.net.domain: 10509 [1au] DS? es. (31)
	17:32:01.698907 IP i.root-servers.net.domain > 10.0.2.15.58767: 10509*- 3/0/1 DS, DS, RRSIG (402)
	17:32:01.699950 IP 10.0.2.15.56905 > g.nic.es.domain: 16174 [1au] DS? cocacola.es. (40)
	17:32:01.705794 IP g.nic.es.domain > 10.0.2.15.56905: 16174*-| 0/0/1 (40)
	17:32:01.717950 IP 10.0.2.15.35944 > fnic.rediris.es.domain: 33694 [1au] DNSKEY? es. (31)
	17:32:01.793932 IP 10.0.2.15.44414 > 10.0.2.3.domain: 17069+ PTR? 17.148.36.192.in-addr.arpa. (44)
	17:32:01.948494 IP 10.0.2.3.domain > 10.0.2.15.44414: 17069 1/0/0 PTR i.root-servers.net. (76)
	17:32:01.948912 IP 10.0.2.15.33244 > 10.0.2.3.domain: 54600+ PTR? 1.217.61.204.in-addr.arpa. (43)
	17:32:01.954600 IP 10.0.2.3.domain > 10.0.2.15.33244: 54600 1/0/0 PTR g.nic.es. (65)
	17:32:01.955106 IP 10.0.2.15.43201 > 10.0.2.3.domain: 18564+ PTR? 7.1.206.130.in-addr.arpa. (42)
	17:32:01.961267 IP 10.0.2.3.domain > 10.0.2.15.43201: 18564 1/0/0 PTR fnic.rediris.es. (71)
	17:32:05.976286 IP X550JX.57374 > 192.168.56.104.domain: 56928+ [1au] A? cocacola.es. (52)
	17:32:08.150072 IP 10.0.2.15.59330 > ns1.nic.es.domain: 15061 [1au] DNSKEY? es. (31)
	17:32:08.150564 IP 10.0.2.15.44330 > 10.0.2.3.domain: 42886+ PTR? 1.254.69.194.in-addr.arpa. (43)
	17:32:08.233597 IP ns1.nic.es.domain > 10.0.2.15.59330: 15061*-| 0/0/1 (31)
	17:32:08.237490 IP 10.0.2.3.domain > 10.0.2.15.44330: 42886 1/0/0 PTR ns1.nic.es. (67)
	17:32:08.269864 IP 192.168.56.104.domain > X550JX.57374: 56928 1/3/4 A 52.14.144.171 (164)

	17:32:15.818476 IP X550JX.54139 > 192.168.56.104.domain: 17855+ [1au] A? cocacola.es. (52)
	17:32:15.818737 IP 192.168.56.104.domain > X550JX.54139: 17855 1/3/4 A 52.14.144.171 (164)
	^C
	52 packets captured
	89 packets received by filter
	37 packets dropped by kernel
	root@monitor:~#

Per controlar les peticions recursives en el servidor DNS es fa configurant-ho en els fitxers de configuració,
concretament en el "named.conf.options", afegint la directiva "recursion" a no si no es vol acceptar cap ni una.
La política per defect és fer-les.
D'altre banda, es pot delimitar només a un conjunt que es qui podrà fer consultes recursives.

Exemple, on <xarxa> pot ser una sola xarxa, un conjunt d'ips, el paràmetre any o el paràmetre none:

	allow-recursion { <xarxa>; };

Fitxer de configuració denegant tot tipus de peticions recursives:

	root@monitor:/etc/bind# cat named.conf.options 
	options {
		.
		.
		.
		recursion no;
	};

	root@monitor:/etc/bind#

Exemple de petició:

	itiel@X550JX:~$ dig @192.168.56.104 google.es

	; <<>> DiG 9.11.3-1ubuntu1.5-Ubuntu <<>> @192.168.56.104 google.es
	; (1 server found)
	;; global options: +cmd
	;; Got answer:
	;; ->>HEADER<<- opcode: QUERY, status: REFUSED, id: 55509
	;; flags: qr rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1
	;; WARNING: recursion requested but not available

	;; OPT PSEUDOSECTION:
	; EDNS: version: 0, flags:; udp: 4096
	;; QUESTION SECTION:
	;google.es.			IN	A

	;; Query time: 0 msec
	;; SERVER: 192.168.56.104#53(192.168.56.104)
	;; WHEN: Mon Mar 18 18:05:57 CET 2019
	;; MSG SIZE  rcvd: 38

	itiel@X550JX:~$


# DELEGACIÓ D'UN SUBDOMINI
--------------------------

La configuració s'ha de realitzar en el mateix fitxer ("named.conf.local") afegint la nova zona respectiva,
en el cas del servidor mestre per a la zona "classe.seax.edu" s'afegira en el fitxer i s'establirà com a servidor
màster. A més notificarà al servidor màster per a la zona "seax.edu" que farà d'esclau per al subdomini:

	root@monitor:/etc/bind# cat named.conf.local

	.
	.
	.

	zone "classe.seax.edu" {
		type master;
		file "/etc/bind/directes-classe.seax.edu";	
		allow-transfer {192.168.56.104;};
		also-notify {192.168.56.104;};
	};

	root@monitor:/etc/bind#

	NOTA: S'ha aprofitat per fer d'esclau al servidor 192.168.56.104. No és prescindible.

Configuració de la base de dades per a la zona "classe.seax.edu" subdomini de "seax.edu":

	root@monitor:/etc/bind# cat directes-classe.seax.edu 
	; BIND reverse data file for empty rfc1918 zone
	;
	; DO NOT EDIT THIS FILE - it is used for multiple zones.
	; Instead, copy it, edit named.conf, and use that copy.
	;
	$TTL	86400
	@	IN	SOA	classe.seax.edu. root.classe.seax.edu. (
				      1		; Serial
				 604800		; Refresh
				  86400		; Retry
				2419200		; Expire
				  86400 )	; Negative Cache TTL
	;
	@	IN	NS	dns.classe.seax.edu.
	@	IN	NS	dns2.classe.seax.edu.

	classe.seax.edu.	IN	A	192.168.56.102
	dns					IN	A	192.168.56.102
	dns2				IN	A	192.168.56.104
	itiel				IN	A	192.168.56.29
	root@monitor:/etc/bind#


Configuració de la zona "classe.seax.edu" en el servidor esclau:

	root@monitor:/etc/bind# cat named.conf.local

	.
	.
	.

	zone "classe.seax.edu" {
		type slave;
		file "/etc/bind/slave/directes-classe.seax.edu";
		masters {192.168.56.102;};
	};

	root@monitor:/etc/bind#

Configuració de la zona directa del servidor que serà esclau de la zona "classe.seax.edu" 
per a redirigir les peticions cap al servidor mestre de la zona previament esmentada:

	root@monitor:/etc/bind# cat directes-seax.edu 
	; BIND reverse data file for empty rfc1918 zone
	;
	; DO NOT EDIT THIS FILE - it is used for multiple zones.
	; Instead, copy it, edit named.conf, and use that copy.
	;
	$TTL	86400
	@	IN	SOA	seax.edu. root.seax.edu. (
				2019031500	; Serial YYYYMMDDnn
				 604800		; Refresh
				  86400		; Retry
				2419200		; Expire
				  86400 )	; Negative Cache TTL
	;
	@	IN	NS	dns.seax.edu.
	@	IN	NS	dns2.seax.edu.

	seax.edu.	IN	A	192.168.56.104
	dns			IN	A	192.168.56.104
	dns2		IN	A	192.168.56.102
	itiel		IN	A	192.168.56.205
	classe		IN	A	192.168.56.102

	$ORIGIN classe.seax.edu.
	$TTL	86400
	@	IN	NS	dns.classe.seax.edu.

	dns		IN	A	192.168.56.102
	dns2	IN	A	192.168.56.104
	root@monitor:/etc/bind#

Configuració de la zona directa "classe.seax.edu":

	root@monitor:/etc/bind# cat directes-classe.seax.edu 
	; BIND reverse data file for empty rfc1918 zone
	;
	; DO NOT EDIT THIS FILE - it is used for multiple zones.
	; Instead, copy it, edit named.conf, and use that copy.
	;
	$TTL	86400
	@	IN	SOA	classe.seax.edu. root.classe.seax.edu. (
					  1		; Serial
				 604800		; Refresh
				  86400		; Retry
				2419200		; Expire
				  86400 )	; Negative Cache TTL
	;
	@	IN	NS	dns.classe.seax.edu.
	@	IN	NS	dns2.classe.seax.edu.

	classe.seax.edu.	IN	A	192.168.56.102
	dns					IN	A	192.168.56.102
	dns2				IN	A	192.168.56.104
	itiel				IN	A	192.168.56.29
	root@monitor:/etc/bind#

Resolució del nom "itiel.classe.seax.edu" contra el servidor mestre 192.168.56.104 encarregat del domini "seax.edu":

	itiel@X550JX:~$ dig @192.168.56.104 itiel.classe.seax.edu +nocmd +nocomments +nostats

	; <<>> DiG 9.11.3-1ubuntu1.5-Ubuntu <<>> @192.168.56.104 itiel.classe.seax.edu +nocmd +nocomments +nostats
	; (1 server found)
	;; global options: +cmd
	;itiel.classe.seax.edu.			IN	A
	itiel.classe.seax.edu.	86400	IN	A	192.168.56.29
	classe.seax.edu.		86400	IN	NS	dns.classe.seax.edu.
	dns.classe.seax.edu.	86400	IN	A	192.168.56.102
	itiel@X550JX:~$

	Es mostra qui és l'encarregat del domini ("dns.classe.seax.edu" amb ip 192.168.56.102) per al subdomini demanat.

Petició del SOA del subdomini delegat:

	itiel@X550JX:~$ dig @192.168.56.104 SOA classe.seax.edu +nocmd +nocomments +nostats

	; <<>> DiG 9.11.3-1ubuntu1.5-Ubuntu <<>> @192.168.56.104 SOA classe.seax.edu +nocmd +nocomments +nostats
	; (1 server found)
	;; global options: +cmd
	;classe.seax.edu.				IN	SOA
	classe.seax.edu.		86400	IN	SOA	classe.seax.edu. root.classe.seax.edu. 1 604800 86400 2419200 86400
	classe.seax.edu.		86400	IN	NS	dns.classe.seax.edu.
	dns.classe.seax.edu.	86400	IN	A	192.168.56.102
	itiel@X550JX:~$


# MOSTREIG CACHE LOCAL
----------------------

Per poder veure la cache local del servidor DNS es necessari fer servir una comanda. El motiu és que l'informació s'emmagatzema
en la memòria RAM de la màquina.
La comanda encarregada de fer-ho possible és:

	root@monitor:/var/cache/bind# rndc dumpdb -cache
	root@monitor:/var/cache/bind#

Es generarà el fitxer "named_dump.db" en el directori "/var/cache/bind" i el seu contingut sería una cosa semblant a això:

	root@monitor:/var/cache/bind# cat named_dump.db

	.
	.
	.

	; glue
	cocacola.es.		86396	NS	ns2.ko.com.
						86396	NS	ns3.ko.com.
						86396	NS	ns4.ko.com.

	.
	.
	.

	$DATE 20190317220124
	;
	; Address database dump
	;
	; [edns success/4096 timeout/1432 timeout/1232 timeout/512 timeout]
	; [plain success/timeout]
	;
	;
	; Unassociated entries
	;
	;
	; Bad cache
	;
	; Dump complete
	root@monitor:/var/cache/bind#


# COORDINACIÓ DHCP I DNS
------------------------

Es pot configurar de manera dinàmica per a què cada cop que el dhcp entrega paràmetres a un client automàticament el dns
emmagatzemi el nom d'aquest.


# SCRIPT
--------

L'script treu la informació del correu de l'administrador de la zona demanada, el servidor màster, els seus esclaus, els servidor de correu MX i
per últim resol cada un dels noms obtinguts.

Per usar-ho cal indicar quin és el domini de zona a resoldre i contra quin nameserver.

Exemples:

	root@monitor:~# ./nameserver.sh seax.edu localhost
	Inici 2019-03-20 17:06:42
	Trobant correu de l'administrador FET
	Trobant el servidor màster FET
	Trobant els servidors esclaus FET
	Trobant els servidors de correu FET
	Resolent els dominis FET
	Fi 2019-03-20 17:06:42
	---------------- Data inici: 2019-03-20 17:06:42 ----------------

	Correu administrador	root@seax.edu.

	Servidor màster 	seax.edu.

	Servidors esclaus	dns2.seax.edu.
				dns.seax.edu.

	Servidors de correu	Dada no trobada

	Registres A		seax.edu. --> 192.168.56.104
				seax.edu. --> 192.168.56.104
				


	---------------- Data fi: 2019-03-20 17:06:42 ----------------
	root@monitor:~#

	root@monitor:~# ./nameserver.sh google.com localhost
	Inici 2019-03-20 17:11:51
	Trobant correu de l'administrador FET
	Trobant el servidor màster FET
	Trobant els servidors esclaus FET
	Trobant els servidors de correu FET
	Resolent els dominis FET
	Fi 2019-03-20 17:11:51
	---------------- Data inici: 2019-03-20 17:11:51 ----------------

	Correu administrador	dns-admin@google.com.

	Servidor màster 	ns1.google.com.

	Servidors esclaus	ns2.google.com.
				ns3.google.com.
				ns4.google.com.

	Servidors de correu	aspmx.l.google.com. amb prioritat 10
				alt1.aspmx.l.google.com. amb prioritat 20
				alt2.aspmx.l.google.com. amb prioritat 30
				alt3.aspmx.l.google.com. amb prioritat 40
				alt4.aspmx.l.google.com. amb prioritat 50

	Registres A		google.com. --> 216.58.211.46
				ns1.google.com. --> 216.239.32.10
				aspmx.l.google.com. --> 74.125.71.26
				alt1.aspmx.l.google.com. --> 74.125.205.26
				alt2.aspmx.l.google.com. --> 74.125.130.26
				alt3.aspmx.l.google.com. --> 74.125.204.26
				alt4.aspmx.l.google.com. --> 74.125.195.26
				


	---------------- Data fi: 2019-03-20 17:11:51 ----------------
	root@monitor:~#

	root@monitor:~# ./nameserver.sh cocacola.es 8.8.8.8
	Inici 2019-03-20 17:16:11
	Trobant correu de l'administrador FET
	Trobant el servidor màster FET
	Trobant els servidors esclaus FET
	Trobant els servidors de correu FET
	Resolent els dominis FET
	Fi 2019-03-20 17:16:12
	---------------- Data inici: 2019-03-20 17:16:11 ----------------

	Correu administrador	ipnam@coca-cola.com.

	Servidor màster 	ns3.ko.com.

	Servidors esclaus	ns2.ko.com.
				ns4.ko.com.

	Servidors de correu	antispam.genetsis.com. amb prioritat 10

	Registres A		cocacola.es. --> 52.14.144.171
				ns3.ko.com. --> 161.162.84.154
				antispam.genetsis.com. --> 82.144.102.243
				


	---------------- Data fi: 2019-03-20 17:16:12 ----------------
	root@monitor:~#
