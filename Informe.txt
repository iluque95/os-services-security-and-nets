# Pràctica 3 - Avaluació. (Luque Díaz Itiel)
--------------------------------------------

# INDEX
-------

(*) Pràctica 3 - Avaluació. (Luque Díaz Itiel)...............................................................................79
	(*) REQUERIMENTS.........................................................................................................88
	(*) ESCENARI............................................................................................................119
	(*) PROGRAMARI NECESSARI................................................................................................146
	(*) FITXERS MODIFICATS..................................................................................................154
	(*) CANVIS EN LA MÀQUINA................................................................................................177
	(*) DEDUCCIONS..........................................................................................................211
	(*) CONSIDERACIONS......................................................................................................233
	(*) CREACIÓ D'UN RAID Z2 AMB ZFS........................................................................................270
	(*) CONFIGURACIÓ DISCOS SPARE...........................................................................................325
	(*) AFEGIR USUARIS ENTEL I SEAX.........................................................................................362
	(*) ENGABIAMENT SFTP....................................................................................................388
	(*) COMPROVACIONS SFTP..................................................................................................426
	(*) AUTOMUNTATGE SFTP...................................................................................................550
	(*) CONFIGURACIÓ SMB....................................................................................................609
	(*) COMPROVACIÓ DE FUNCIONAMENT SMB.....................................................................................683
	(*) AUTOMUNTAGE SMB.....................................................................................................825
	(*) CONFIGURACIÓ VHOSTS I WEBDAV APACHE2................................................................................898
	(*) COMPROVACIÓ WEBDAV.................................................................................................1071
	(*) AUTOMUNTATGE WEBDAV................................................................................................1364
	(*) CONFIGURACIÓ SERVIDOR OPENVPN......................................................................................1533
	(*) CONFIGURACIÓ CLIENT OPENVPN........................................................................................1561
	(*) COMPROVACIÓ CLIENT OPENVPN.........................................................................................1617
	(*) ESTRUCTURA DE FITXERS, PERMISOS I PROVES (FIREWALL ACTIVAT)........................................................1658
	(*) CAPTURA DE PAQUETS DELS SERVEIS AMB FIREWALL I NAT.................................................................1913
(*) Pràctica 3 - Sessió 1 - Accés al servidor mitjançant SFTP i SAMBA. (Luque Díaz Itiel)..................................2817
	(*) PROGRAMARI NECESSARI...............................................................................................2820
	(*) FITXER RELACIONATS.................................................................................................2833
	(*) DESCRIPCIÓ.........................................................................................................2841
	(*) CONFIGURACIÓ SFTP..................................................................................................2849
	(*) MUNTATGE RECURS SFTP...............................................................................................2920
	(*) COMPARTICIÓ D'UN RECURS SFTP.......................................................................................3035
	(*) CONFIGURACIÓ SMB...................................................................................................3054
	(*) COMPARTICIÓ RECURSOS SMB...........................................................................................3098
	(*) CLIENT I MUNTATGE SMB..............................................................................................3139
	(*) SEGURETAT..........................................................................................................3279
	(*) BACKUPS............................................................................................................3322
	(*) AUTOMATITZACIÓ AMB CRON............................................................................................3512
(*) Pràctica 3 - Sessió 2 - Crear un raid/cluster de discs en xarxa. (Luque Díaz Itiel)....................................3552
	(*) PROGRAMARI NECESSARI...............................................................................................3555
	(*) FITXER RELACIONATS.................................................................................................3564
	(*) DESCRIPCIÓ.........................................................................................................3577
	(*) CREACIÓ D'UN RAID AMB MDADM........................................................................................3585
	(*) ADMINISTRACIÓ D'UN RAID AMB MDADM..................................................................................4488
	(*) CREACIÓ D'UN RAID Z AMB ZFS........................................................................................4583
	(*) RECUPERACIÓ RAIDZ..................................................................................................4688
	(*) CREACIÓ DE CLUSTER DE DISCOS AMB DRBD..............................................................................4868
	(*) RECUPERACIÓ CLUSTER DE DISCOS......................................................................................5077
	(*) COMPARTICIÓ RAID SMB...............................................................................................5266
	(*) SEGURETAT..........................................................................................................5354
	(*) PROGRAMARI NECESSARI...............................................................................................5384
	(*) FITXER RELACIONATS.................................................................................................5394
	(*) COMANDES APACHE2...................................................................................................5404
	(*) CONSIDERACIONS.....................................................................................................5412
	(*) DESCRIPCIÓ.........................................................................................................5419
	(*) CONFIGURACIÓ D'UN VIRTUALHOST APACHE2..............................................................................5429
	(*) CONFIGURACIÓ VIRTUALHOST SEGUR (SSL) APACHE2.......................................................................5545
	(*) CONFIGURACIÓ WEBDAV APACHE2........................................................................................5683
	(*) WEBMIN.............................................................................................................5890
	(*) SEGURETAT..........................................................................................................5934
(*) Pràctica 3 - Sessió 4 - Implementar un servei de xarxa privada virtual. (Luque Díaz Itiel).............................5958
	(*) PROGRAMARI NECESSARI...............................................................................................5961
	(*) FITXER RELACIONATS.................................................................................................5970
	(*) ESCENARI...........................................................................................................5977
	(*) COMANDES OPENVPN...................................................................................................5990
	(*) CONSIDERACIONS.....................................................................................................6000
	(*) DESCRIPCIÓ.........................................................................................................6008
	(*) CREACIÓ I CONFIGURACIÓ CA..........................................................................................6021
	(*) CONFIGURACIÓ SERVIDOR OPENVPN......................................................................................6155
	(*) GENERACIÓ FITXER DE CONFIGURACIÓ .OVPN.............................................................................6255
	(*) CONFIGURACIÓ CLIENT LINUX OPENVPN..................................................................................6496
	(*) SEGURETAT..........................................................................................................6551
(*) REFERÈNCIES BIBLIOGRÀFIQUES............................................................................................6605


Enllaç de descàrrega: https://cloud.catac.upc.edu/owncloud/index.php/s/GSeONbcQINw77bN
Clau: toor

*NOTA: Aquest informe ha estat redactat amb amplada de tabulació 4 en editor de textos gedit.


# REQUERIMENTS
--------------

- Condicions inicials.
    - Cal seguir les directrius detallades als enunciats de les sessions de la pràctica 3.
    - En aquesta document es modifiquen, o amplien, els detalls de configuració per establir l'escenari d'avaluació.
   
- Es vol preparar un servidor d'emmagatzematge en xarxa (NAS, Network Attached Storage).
    - L'equip es connecta en mode adaptador pont del VirtualBox i es configura per DHCP.
    - El nom de l'equip és: NAS-SEAX.
    - En el servidor existeixen 2 usuaris que comparteixen fitxers (entel:letne i seax:xaes) i l'administrador (root:toor).
    - El servidor disposarà d'un RAID-Z2, de 128MB de capacitat, per als fitxers dels usuaris del sistema (/home).
   
- Es podrà accedir al servidor mitjançant SFTP, SAMBA i WEBBAV
    - Els recursos compartits han de ser visibles i accessibles des de la xarxa.
    - Els usuaris entel i seax han de poder accedir als seus fitxers amb els protocols SFTP, SAMBA i WEBDAV.
    - Els equips clients han de poder muntar els recursos tant manualment com automàticament.
    - Cal verificar el funcionament amb entorns Debian 9 i Windows 10.
    - Cal documentar les proves que acreditin el correcte funcionament.

- El servidor s'haurà de poder administrar mitjançant SSH i WEBMIN.
    - L'usuari administrador ha de poder accedir i administrar remòtament el servidor.
    - Cal verificar el funcionament amb entorns Debian 9 i Windows 10.
    - Cal documentar les proves que acreditin el correcte funcionament.
   
- El servidor permetrà accedir-hi mitjançant una xarxa privada virtual amb OPENVPN.
    - Els usuaris root, entel i seax han de poder accedir al servidor mitjançant OPENVPN.
    - Cal verificar el funcionament amb entorns Debian 9 i Windows 10.
    - Cal documentar les proves que acreditin el correcte funcionament.


# ESCENARI
----------

* CLIENT

	- Interfícies 		* Adaptador pont		-->	192.168.1.38 (192.168.1.0/24)
	 					* vboxnet0 (fixada)		--> 192.168.56.117 (192.168.56.0/24)

	- Serveis			* SFTP
						* Samba
						* WebDAV
						* OpenVPN				--> 10.10.10.1 (10.10.10.0/24)

* SERVIDOR

	- Interfícies 		* Adaptador pont		-->	192.168.1.34 (192.168.1.0/24)
	 					* vboxnet0 (fixada)		--> 192.168.56.116 (192.168.56.0/24)

	- Serveis			* SFTP
						* Samba
						* WebDAV
						* OpenVPN

	- Firewall			* Maximitzar seguretat
						* NAT


# PROGRAMARI NECESSARI
----------------------

* Editor de textos (Gedit p.exemple)
* nano/pico (opcionalment)
* davfs2 (apt-get install davfs2)


# FITXERS MODIFICATS
--------------------

* SERVIDOR

	* /etc/apt/sources.list			--> Llista dels programaris de Linux.
	* /etc/zfs/zed.d/zed.rc			--> Configuració de zfs.
	* /etc/ssh/sshd_config			--> Configuració del servidor ssh/sftp.
	* /etc/samba/smb.conf			--> Configuració del servidor samba.
	* /etc/apache2/avaiable-sites/*	--> Configuració dels sites (virtual hosts).
	* /etc/rc.local					--> Script que s'executa al arrencar el sistema operatiu.
	* /etc/network/interfaces		--> Configuració de les interficies.
	* /etc/openvpn/server.conf		--> Configuració del openvpn.
	
*CLIENT

	* /etc/fstab					--> Fitxer d'automuntatge de particions.
	* /etc/hosts					--> Caché local de DNS.
	* /etc/openvpn/openserver.conf	--> Configuració del client openvpn.
	* /etc/network/interfaces		--> Configuració de les interficies.
	* /etc/davfs2/*					--> Configuració del webdav.
	

# CANVIS EN LA MÀQUINA
----------------------

- S'ha canviat el hostname de seax a NAS-SEAX.
- S'ha afegit un certificat a l'usuari root.
- S'han afegit 5 discos de 200 MB cadascún.
- S'han afegit els usuaris entel i seax.
- S'ha afegit el grup filetransfer per sftp.
- S'han afegit als usuaris entel i seax al grup filetranfer.
- S'ha configurat el servidor sftp (/etc/ssh/sshd_config)
- S'ha generat un certificat a l'usuari root de la màquina client.
- S'ha instal·lat dit certificat en els usuaris entel i seax del servidor.
- S'ha configurat el client per automuntar l'sftp en /etc/fstab.
- S'ha instal·lat samba en el servidor.
- S'ha instal·lat en el client samba-client i cifs-utils.
- S'han especificat a entel i seax com usuaris de samba.
- S'han compartit els recursos dels usuaris en samba.
- S'ha instal·lat apache2 i el mòdul de php7.0.
- S'ha afegit en el client els dns de seax.com i entel.com.
- S'han afegit els dos sites; entel i seax.
- S'ha instal·lat cadaver per fer proves de webdav.
- S'ha afegit un home a la pàgina principal del servidor apache2 i un home per a cada usuari amb enllaços a webdav.
- S'ha instal·lat openvpn i configurat. Difereix en el certificat Diffie-Hellman, en la sessió 4 és de 4096 i en l'avaluable 2048 bits.
- S'ha instal·lat el protocol ntp per a sincronitzar les màquines, per culpa de les incongruències no connectava openvpn.
- S'ha obtat per refer tota la màquina client, aquesta no cal ntp, l'anterior tenia un problema amb el protocol de la data/hora.
- S'ha afegit el firewall i nat.
- S'ha instal·lat el servidor i client openvpn.
- S'ha automuntat webdav.
- S'ha instal·lat Webmin.
- S'han fet més proves amb el firewall, la NAT amb diferents escenari i sistemes operatius.
- S'ha establit que s'executi el firewall només arrencar la màquina servidor.
- S'han generat els fitxers de configuració de la openvpn per als clients entel i seax. (Root el té configurat en la màquina client).


# DEDUCCIONS
------------

- S'ha escollit la mida de 200MB per a complir amb el requisit de 128 MB mínims. També s'ha de tenir en compte que el mínim que acepta zfs és 74 MB, ja
  que s'ha de descomptar la quantitat que es perd per el sistema de fitxers i els discos de paritat i per tant el mínim lliure és de 88 MB.
- Per aconseguir exactament el RaidZ2 amb 128MB lliures és necessari 4 discos de 96MB cadascún.
- Un Raid Z2 (Raid 6) com a mínim requereix 4 discos, per tant, s'ha afegit un cinquè com spare.
- El nivell d'aïllament dels usuaris en sftp (ChrootDirectory) és el /home per a poder compartir-se'n fitxers.
- S'ha aprofitat la mateixa carpeta d'sftp per compartirla per samba.
- Els usuaris veuen les carpetes dels altres usuaris, però, només tenen permissos per tractar les de cadascú.
- S'ha preferit aïllar els recursos de cadascú en comptes de compartir directament el /home.
- Els usuaris accediran als seus recursos de webdav amb <nom_usuari>.com/<nom_usuari> i <domini>.com/shared.
- Se li han afegit les rutes per accedir a la resta d'equips de l'escenari de la pràctica 2. La ruta és 10.10.0.0/21 perquè l'últim host
  és el 10.10.7.254 i en la anterior pràctica arribava fins a la subnet 10.10.5.0/28.
- S'ha escollit la xarxa 192.168.56.0 per accedir als recursos, però, es podría haver fet servir la VPN, de fet, hi ha comprovacions en
  l'informe. Per a que s'automuntin amb VPN, caldría fer un mount -a quan ja s'hagi establit la connexió amb aquesta. Passa però. que 
  primerament tracta de muntar i el servei OpenVPN és més lent.
- En aquest escenari, per demostrar que funciona webmin junt amb el firewall, s'ha permés accedir-hi de forma normal, en un entorn real, aquest tipus
  d'eines tant crítiques, sería molt recomanable només poder accedir mitjançant la VPN que s'ha configurat.
- Els homes dels usuaris entel i seax tenen com a grup www-data, aquests no pertanyen al grup, pel qual, mantenen privacitat a nivell de sistema.


# CONSIDERACIONS
----------------

- Afegir una xarxa d'amfitrió 192.168.56.0/24. Aquest tipus de xarxa va molt bé per poder comunicar-se entre les màquines virtuals i la física.
- Per muntar correctament els recursos en el client, consideri's engegar primerament el servidor.
- Canviar en el client en /etc/openvpn/openserver.conf la directiva remote per l'adreça assignada per DHCP en el servidor. També en els fitxers .ovpn d'Entel i Seax.
  Si el fitxer de configuració s'està entregant a un usuari que farà servir una xarxa d'Internet, cal posar la ip pública del router amb el que surt el NAS.
- S'han deixat els fitxers de configuració de la openvpn en el directori /root en un enllaç simbòlic cap /etc/openvpn/clients.
- S'ha obtat per possar dos targetes ethernet per a què el professor hagi de fer els mínims canvis i li resulti més fàcil corretgir.
- Els passos d'instal·lar i/o configurar sftp, samba, webdav, webmin s'obvien en l'avaluació. Ja estan explicats en l'informe.
- Només es detallaran els canvis importants en la consideració anterior o és marcaran com a deduccions si realment ho són.
- També s'explicaran les passes que difereixin.1
- Els discos spares tot i estar configurats no funcionen, probablement és un bug.
- Per poder afegir el grup www-data en el home de l'usuari i no perdre els permissos de webdav a més de poder seguir entrant per ssh/sftp
  sense que demani contrasenya cal canviar la directiva:

		root@NAS-SEAX:/etc/ssh# cat sshd_config | grep AuthorizedKeysFile
		AuthorizedKeysFile	/etc/ssh/authorized_keys/%u#.ssh/authorized_keys .ssh/authorized_keys2
		root@NAS-SEAX:/etc/ssh#

  També calen els permisos següents:

		root@NAS-SEAX:/etc/ssh/authorized_keys# ls -l
		total 8
		-rw------- 1 entel entel 2987 may 27 02:31 entel
		-rw------- 1 seax  seax   782 may 27 02:33 seax
		-rw------- 1 root  root   782 may 27 02:33 root
		root@NAS-SEAX:/etc/ssh/authorized_keys#

- S'ha obviat crear els usuaris entel i seax al sistema de la màquina client, perquè no tenen relació amb les credencials d'autentificació en
  els serveis oferits per el servidor. En tal cas, és necessari afegir les opcions uid=<nom_usuari>, gid=<nom_grup> de l'usuari en l'fstab per a què
  no es munti el recurs com a root:root i pugui tenir permissos l'usuari del sistema client que es vol permetre que accedeixi.
- S'ha fet servir la vboxnet per automuntar els recursos que ofereix el NAS, també s'ha provat i demostrat en l'informe fent servir la VPN. En tal cas que
  es vulgui fer servir altre xarxa que permeti accedir, cal canviar la ip en /etc/fstab i les dns en la caché local /etc/hosts.
- El firewall està comentat linia per linia explicant que fa cada iptables.


# CREACIÓ D'UN RAID Z2 AMB ZFS
------------------------------

Primer s'ha d'instal·lar el paquet tal i com s'especifica en l'informe en la sessió 2 en l'apartat CREACIÓ D'UN RAID Z AMB ZFS.
Seguidament, es mostrarán els discos que hi ha al sistema. Es faran servir el rang [sdb-sdf]:

	root@NAS-SEAX:~# fdisk -l | grep Disco | sort
	Disco /dev/sda: 8 GiB, 8589934592 bytes, 16777216 sectores
	Disco /dev/sdb: 200 MiB, 209715200 bytes, 409600 sectores
	Disco /dev/sdc: 200 MiB, 209715200 bytes, 409600 sectores
	Disco /dev/sdd: 200 MiB, 209715200 bytes, 409600 sectores
	Disco /dev/sde: 200 MiB, 209715200 bytes, 409600 sectores
	Disco /dev/sdf: 200 MiB, 209715200 bytes, 409600 sectores
	root@NAS-SEAX:~# 

Creació del raid z2 amb els 4 discos esmentats i el cinquè com a spare:

	root@NAS-SEAX:~# zpool create itiel raidz2 -m /home /dev/sdb /dev/sdc /dev/sdd /dev/sde spare /dev/sdf -f
	root@NAS-SEAX:~#

Comprovació del raid:

	root@NAS-SEAX:~# zfs list
	NAME    USED  AVAIL  REFER  MOUNTPOINT
	itiel  90,4K   334M  25,4K  /home
	root@NAS-SEAX:~#

	NOTA: Tot i que es demana 128M en total, el raid ofereix un llindar de més del 50%.

	root@NAS-SEAX:~# zpool status
	  pool: itiel
	 state: ONLINE
	  scan: none requested
	config:

		NAME        STATE     READ WRITE CKSUM
		itiel       ONLINE       0     0     0
		  raidz2-0  ONLINE       0     0     0
			sdb     ONLINE       0     0     0
			sdc     ONLINE       0     0     0
			sdd     ONLINE       0     0     0
			sde     ONLINE       0     0     0
		spares
		  sdf       AVAIL   

	errors: No known data errors
	root@NAS-SEAX:~#

	root@NAS-SEAX:~# df -h | grep /home
	itiel            335M      0  335M   0% /home
	root@NAS-SEAX:~#

	NOTA: És curiós com el sistema de fitxer és el nom del pool.


# CONFIGURACIÓ DISCOS SPARE
---------------------------

Per a què el disc spare entri automàticament en acció quan un cau com a fallit s'ha de configurar
el fitxer /etc/zfs/zed.d/zed.rc:

	root@NAS-SEAX:~# cat /etc/zfs/zed.d/zed.rc 
	.
	.
	.	
	##
	# Replace a device with a hot spare after N checksum errors are detected.
	# Disabled by default; uncomment to enable.
	#
	ZED_SPARE_ON_CHECKSUM_ERRORS=10

	##
	# Replace a device with a hot spare after N I/O errors are detected.
	# Disabled by default; uncomment to enable.
	#
	ZED_SPARE_ON_IO_ERRORS=1
	.
	.
	.
	root@NAS-SEAX:~#		
	
També s'ha d'indicar que el raid faci autoreplace:

	root@NAS-SEAX:~# zpool set autoreplace=on itiel
	root@NAS-SEAX:~#

	root@NAS-SEAX:~# zpool get autoreplace itiel
	NAME   PROPERTY     VALUE    SOURCE
	itiel  autoreplace  on       local
	root@NAS-SEAX:~#


# AFEGIR USUARIS ENTEL I SEAX
-----------------------------

Per afegir un usuari s'ha de fer amb la comanda següent, s'ha de tenir curra no escriure-la inversament,
ja que donat el cas, s'hauria d'especificar els paràmetres com el home de l'usuari, etc:

	root@NAS-SEAX:~# adduser entel
	adduser: El usuario `entel' ya existe.
	root@NAS-SEAX:~# 

	root@NAS-SEAX:~# adduser seax
	adduser: El usuario `seax' ya existe.
	root@NAS-SEAX:~# 

	root@NAS-SEAX:~# tail -n 2 /etc/passwd
	entel:x:1000:1000:,,,:/home/entel:/bin/bash
	seax:x:1001:1001:,,,:/home/seax:/bin/bash
	root@NAS-SEAX:~#

	root@NAS-SEAX:~# ls -l /home
	total 1
	drwxr-xr-x 2 entel entel 5 may 24 19:30 entel
	drwxr-xr-x 2 seax  seax  5 may 24 19:30 seax
	root@NAS-SEAX:~#


# ENGABIAMENT SFTP
------------------

Creació d'una carpeta compartida i assignació de grup:

	root@NAS-SEAX:/home# mkdir shared
	root@NAS-SEAX:/home#

	root@NAS-SEAX:/home# chown :filetransfer shared/
	root@NAS-SEAX:/home# ls -l
	total 2
	drwxr-xr-x 2 entel entel        5 may 24 19:30 entel
	drwxr-xr-x 2 seax  seax         5 may 24 19:30 seax
	drwxr-xr-x 2 root  filetransfer 2 may 24 19:58 shared
	root@NAS-SEAX:/home#

Assignació de permisos als directoris per a protegir els homes dels altres usuaris:
	
	root@NAS-SEAX:/home# chmod o-rwx entel/
	root@NAS-SEAX:/home# 

	root@NAS-SEAX:/home# chmod o-rwx seax
	root@NAS-SEAX:/home# 

	root@NAS-SEAX:/home# chmod g+rwx shared/
	root@NAS-SEAX:/home# 

	root@NAS-SEAX:/home# chmod g+s shared/
	root@NAS-SEAX:/home#

	root@NAS-SEAX:/home# ls -l
	total 2
	drwxr-x--- 2 entel entel        5 may 24 19:30 entel
	drwxr-x--- 2 seax  seax         5 may 24 19:30 seax
	drwxrwsr-x 2 root  filetransfer 3 may 24 20:04 shared
	root@NAS-SEAX:/home#


# COMPROVACIONS SFTP
--------------------

Comprovació de permissos des d'un dels usuaris:

	itiel@X550JX:~$ sftp entel@192.168.1.34
	entel@192.168.1.34's password: 
	Connected to 192.168.1.34.
	sftp> ls
	sftp> cd seax
	sftp> ls
	remote readdir("/seax"): Permission denied
	sftp> pwd
	Remote working directory: /seax
	sftp> put test.py 
	Uploading test.py to /seax/test.py
	remote open("/seax/test.py"): Permission denied
	sftp> cd /shared
	sftp> pwd
	Remote working directory: /shared
	sftp> ls
	sftp>
	sftp> put test.py

	Uploading test.py to /shared/test.py
	test.py                                       100%  774   669.5KB/s   00:00    
	sftp> ls
	test.py   
	sftp>
	sftp> cd /
	sftp> pwd
	Remote working directory: /
	sftp> ls
	entel   seax    shared  
	sftp> cd /etc/ssh
	Couldn't canonicalize: No such file or directory
	sftp> pwd
	Remote working directory: /
	sftp> exit
	itiel@X550JX:~$

	NOTA: La configuració és simètrica per ambós usuaris.

Vista des del servidor sftp en la carpeta shared:

	root@NAS-SEAX:/home# cd shared/
	root@NAS-SEAX:/home/shared# ls -l
	total 2
	-rwxr-xr-x 1 entel filetransfer 774 may 24 20:10 test.py
	root@NAS-SEAX:/home/shared#

Comprovació des de l'usuari seax a descarregar el fitxer pujat:

	itiel@X550JX:~$ sftp seax@192.168.1.34
	seax@192.168.1.34's password: 
	Connected to 192.168.1.34.
	sftp> cd shared/
	sftp> get test.py 
	Fetching /shared/test.py to test.py
	/shared/test.py                               100%  774   344.7KB/s   00:00    
	sftp> exit
	itiel@X550JX:~$

Captura de paquets des del client sftp:

	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
	17:09:10.967217 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [S], seq 1712523275, win 29200, options [mss 1460,sackOK,TS val 2158015 ecr 0,nop,wscale 7], length 0
	17:09:10.967256 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [S.], seq 585869884, ack 1712523276, win 28960, options [mss 1460,sackOK,TS val 7985189 ecr 2158015,nop,wscale 7], length 0
	17:09:10.967498 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [.], ack 1, win 229, options [nop,nop,TS val 2158015 ecr 7985189], length 0
	17:09:10.967764 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 1:41, ack 1, win 229, options [nop,nop,TS val 2158015 ecr 7985189], length 40
	17:09:10.967776 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [.], ack 41, win 227, options [nop,nop,TS val 7985189 ecr 2158015], length 0
	17:09:10.974300 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [P.], seq 1:40, ack 41, win 227, options [nop,nop,TS val 7985191 ecr 2158015], length 39
	17:09:10.974615 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [.], ack 40, win 229, options [nop,nop,TS val 2158017 ecr 7985191], length 0
	17:09:10.987550 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 1521:1537, ack 1540, win 262, options [nop,nop,TS val 2158020 ecr 7985193], length 16
	17:09:11.030289 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [.], ack 1537, win 249, options [nop,nop,TS val 7985205 ecr 2158020], length 0
	17:09:11.030562 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 1537:1581, ack 1540, win 262, options [nop,nop,TS val 2158031 ecr 7985205], length 44
	17:09:11.030603 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [.], ack 1581, win 249, options [nop,nop,TS val 7985205 ecr 2158031], length 0
	17:09:11.030692 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [P.], seq 1540:1584, ack 1581, win 249, options [nop,nop,TS val 7985205 ecr 2158031], length 44
	17:09:11.030969 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 1581:1641, ack 1584, win 262, options [nop,nop,TS val 2158031 ecr 7985205], length 60
	17:09:11.031524 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [P.], seq 1584:1636, ack 1641, win 249, options [nop,nop,TS val 7985205 ecr 2158031], length 52
	17:09:11.031742 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 1641:2005, ack 1636, win 262, options [nop,nop,TS val 2158031 ecr 7985205], length 364
	17:09:11.034361 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [P.], seq 1636:1688, ack 2005, win 272, options [nop,nop,TS val 7985206 ecr 2158031], length 52
	17:09:11.078404 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [.], ack 1688, win 262, options [nop,nop,TS val 2158043 ecr 7985206], length 0
	17:09:12.101843 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 2005:2089, ack 1688, win 262, options [nop,nop,TS val 2158298 ecr 7985206], length 84
	17:09:12.113963 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [P.], seq 1688:1716, ack 2089, win 272, options [nop,nop,TS val 7985475 ecr 2158298], length 28
	17:09:12.114262 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [.], ack 1716, win 262, options [nop,nop,TS val 2158302 ecr 7985475], length 0
	17:09:12.114371 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 2089:2201, ack 1716, win 262, options [nop,nop,TS val 2158302 ecr 7985475], length 112
	17:09:12.124410 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [P.], seq 1716:2324, ack 2201, win 272, options [nop,nop,TS val 7985478 ecr 2158302], length 608
	17:09:12.166368 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [.], ack 2324, win 279, options [nop,nop,TS val 2158315 ecr 7985478], length 0
	17:09:12.166404 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [P.], seq 2324:2368, ack 2201, win 272, options [nop,nop,TS val 7985489 ecr 2158315], length 44
	17:09:12.166717 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [.], ack 2368, win 279, options [nop,nop,TS val 2158315 ecr 7985489], length 0
	17:09:12.167026 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 2201:2321, ack 2368, win 279, options [nop,nop,TS val 2158315 ecr 7985489], length 120
	17:09:12.168064 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [P.], seq 2368:2440, ack 2321, win 272, options [nop,nop,TS val 7985489 ecr 2158315], length 72
	17:09:12.168602 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 2321:2365, ack 2440, win 279, options [nop,nop,TS val 2158315 ecr 7985489], length 44
	17:09:12.170785 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [P.], seq 2440:2628, ack 2365, win 272, options [nop,nop,TS val 7985490 ecr 2158315], length 188
	17:09:12.171933 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 2365:2417, ack 2628, win 296, options [nop,nop,TS val 2158316 ecr 7985490], length 52
	17:09:12.172475 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [P.], seq 2628:2696, ack 2417, win 272, options [nop,nop,TS val 7985490 ecr 2158316], length 68
	17:09:12.216310 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [.], ack 2696, win 296, options [nop,nop,TS val 2158327 ecr 7985490], length 0
	17:09:13.259624 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 2417:2469, ack 2696, win 296, options [nop,nop,TS val 2158588 ecr 7985490], length 52
	17:09:13.259862 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [P.], seq 2696:2748, ack 2469, win 272, options [nop,nop,TS val 7985762 ecr 2158588], length 52
	17:09:13.260026 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [.], ack 2748, win 296, options [nop,nop,TS val 2158588 ecr 7985762], length 0
	17:09:13.260130 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 2469:2521, ack 2748, win 296, options [nop,nop,TS val 2158588 ecr 7985762], length 52
	17:09:13.260583 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [P.], seq 2748:3312, ack 2521, win 272, options [nop,nop,TS val 7985762 ecr 2158588], length 564
	17:09:13.260826 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 2521:2573, ack 3312, win 313, options [nop,nop,TS val 2158588 ecr 7985762], length 52
	17:09:13.260968 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [P.], seq 3312:3380, ack 2573, win 272, options [nop,nop,TS val 7985762 ecr 2158588], length 68
	17:09:13.261178 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 2573:2625, ack 3380, win 313, options [nop,nop,TS val 2158588 ecr 7985762], length 52
	17:09:13.261364 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [P.], seq 3380:3448, ack 2625, win 272, options [nop,nop,TS val 7985762 ecr 2158588], length 68
	17:09:13.302196 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [.], ack 3448, win 313, options [nop,nop,TS val 2158599 ecr 7985762], length 0
	17:09:14.158501 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 2625:2661, ack 3448, win 313, options [nop,nop,TS val 2158812 ecr 7985762], length 36
	17:09:14.159601 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [P.], seq 3448:3572, ack 2661, win 272, options [nop,nop,TS val 7985987 ecr 2158812], length 124
	17:09:14.159890 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [.], ack 3572, win 313, options [nop,nop,TS val 2158813 ecr 7985987], length 0
	17:09:14.160070 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [P.], seq 2661:2697, ack 3572, win 313, options [nop,nop,TS val 2158813 ecr 7985987], length 36
	17:09:14.160236 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [FP.], seq 2697:2757, ack 3572, win 313, options [nop,nop,TS val 2158813 ecr 7985987], length 60
	17:09:14.160338 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [.], ack 2758, win 272, options [nop,nop,TS val 7985987 ecr 2158813], length 0
	17:09:14.165248 IP 192.168.56.117.ssh > 192.168.56.116.59170: Flags [F.], seq 3572, ack 2758, win 272, options [nop,nop,TS val 7985988 ecr 2158813], length 0
	17:09:14.165455 IP 192.168.56.116.59170 > 192.168.56.117.ssh: Flags [.], ack 3573, win 313, options [nop,nop,TS val 2158814 ecr 7985988], length 0
	^C
	50 packets captured
	54 packets received by filter
	4 packets dropped by kernel
	root@NAS-SEAX:~#


# AUTOMUNTATGE SFTP
-------------------

Primerament, tal i com s'especifica a l'informe en la sessió 1 en el punt MUNTATGE RECURS SFTP, cal instal·lar el paquet sshfs.

En el servidor s'ha de canviar en el fitxer de configuració el grup de l'sftp. En aquest escenari es va anomenar
filetransfer, es canviarà per nobody i es reiniciarà el servei.

En el costat del client, es generarà un certificat per a l'usuari root:

	$ ssh-keygen -t rsa -b 2048

	NOTA: S'ha escollit una seguretat bona.

Per instal·lar els certificats en el servidor per a cada usuari cal fer:

	$ ssh-copy-id <usuari>@<direcció>

En aquest punt, ja es pot tornar a possar el grup filetransfer en el fitxer de configuració de l'sftp i reiniciar el servei.

Es crearà un directori en el home del root per diferenciar el servei i es diferenciaran els usuaris:

	root@seax:~# mkdir sftp
	root@seax:~#

	root@seax:~# cd sftp
	root@seax:~#

	root@seax:~/sftp# mkdir entel
	root@seax:~#

	root@seax:~/sftp# mkdir seax
	root@seax:~#

Després de fer la comanda mount -a o bé reinicialitzar l'equip es pot comprovar que s'han muntat correctament. En aquest cas
s'han provat els dos casos:

	root@seax:~# df -h | grep 192.168.56.117
	seax@192.168.56.117:/    335M      0  335M   0% /root/sftp/seax
	entel@192.168.56.117:/   335M      0  335M   0% /root/sftp/entel
	root@seax:~#

Comprovació dels fitxers muntants:

	root@seax:~/sftp# ls -l entel/
	total 12
	drwxr-x--- 1 1000 1000 6 may 25 17:41 entel
	drwxr-x--- 1 1001 1001 6 may 25 17:41 seax
	drwxrwsr-x 1 root 1002 3 may 24 20:10 shared
	root@seax:~/sftp#

	root@seax:~/sftp# ls -l seax/
	total 12
	drwxr-x--- 1 1000 1000 6 may 25 17:41 entel
	drwxr-x--- 1 1001 1001 6 may 25 17:41 seax
	drwxrwsr-x 1 root 1002 3 may 24 20:10 shared
	root@seax:~/sftp#


# CONFIGURACIÓ SMB
------------------

Primer es necessari instal·lar els paquets samba, samba-client i cifs-utils com s'especifica en l'informe en la
sessió 1.

Cal assignar a seax i entel com usuaris de samba i habilitar-los:

	root@NAS-SEAX:~# smbpasswd -a entel
	New SMB password:
	Retype new SMB password:
	Added user entel.
	root@NAS-SEAX:~#

	root@NAS-SEAX:~# smbpasswd -e entel
	Enabled user entel.
	root@NAS-SEAX:~# smbpasswd -e seax

	root@NAS-SEAX:~# smbpasswd -a seax
	New SMB password:
	Retype new SMB password:
	Added user seax.
	root@NAS-SEAX:~#

	root@NAS-SEAX:~# smbpasswd -e seax
	Enabled user seax.
	root@NAS-SEAX:~#

Mostreig dels usuaris en la base de dades TDB de samba:

	root@NAS-SEAX:~# pdbedit -w -L
	entel:1000:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:56D556AB81A78A1B243014F03500B163:[U          ]:LCT-5CE96F64:
	seax:1001:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:9E3F3BFA77B3B2DA01BBD992891012B6:[U          ]:LCT-5CE96F76:
	root@NAS-SEAX:~#

Per poder accedir als recursos de cada usuari s'han d'afegir al fitxer de configuració de samba:

	root@NAS-SEAX:~# tail -n23 /etc/samba/smb.conf 
	[shared]
		path = /home/shared
		browseable = yes
		read only = no
		force create mode = 0660
		force directory mode = 2770
		valid users = @filetransfer

	[entel]
		path = /home/entel
		browseable = yes
		read only = no
		force create mode = 0660
		force directory mode = 2770
		valid users = entel

	[seax]
	    path = /home/seax   
	    browseable = yes
	    read only = no
	    force create mode = 0660
	    force directory mode = 2770
	    valid users = seax
	root@NAS-SEAX:~#

Comprovació d'automuntatge després de reinicialitzar la màquina:

	root@seax:~# df -h | grep 192.168.56.117
	seax@192.168.56.117:/     335M   128K  335M   1% /root/sftp/seax
	entel@192.168.56.117:/    335M   128K  335M   1% /root/sftp/entel
	//192.168.56.117/shared   335M   128K  335M   1% /root/samba/compartit
	//192.168.56.117/entel    335M   128K  335M   1% /root/samba/entel
	//192.168.56.117/seax     335M   128K  335M   1% /root/samba/seax
	root@seax:~# 


# COMPROVACIÓ DE FUNCIONAMENT SMB
---------------------------------

Testeig des de la màquina client per comandes:

	root@seax:~# smbclient //192.168.56.117/entel -U entel
	WARNING: The "syslog" option is deprecated
	Enter entel's password: 
	Domain=[WORKGROUP] OS=[Windows 6.1] Server=[Samba 4.5.16-Debian]
	smb: \> ls
	  .                                   D        0  Sat May 25 18:47:15 2019
	  ..                                  D        0  Fri May 24 19:58:30 2019
	  .bashrc                             H     3526  Fri May 24 19:30:32 2019
	  .ssh                               DH        0  Sat May 25 17:41:21 2019
	  judit.txt                           N        6  Sat May 25 18:47:15 2019
	  .bash_logout                        H      220  Fri May 24 19:30:32 2019
	  .profile                            H      675  Fri May 24 19:30:32 2019

			342272 blocks of size 1024. 342272 blocks available
	smb: \> exit
	root@seax:~#

Comprovació des d'un client amb Windows 8.1:

	root@NAS-SEAX:/home/shared# tcpdump -s 0 port 445
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes
	19:18:28.255492 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 3169327376:3169327512, ack 3082106619, win 255, length 136 SMB-over-TCP packet:(raw data or continuation?)

	19:18:28.256286 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 1:157, ack 136, win 626, length 156 SMB-over-TCP packet:(raw data or continuation?)

	19:18:28.258522 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 157, win 254, length 0
	19:18:28.258716 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 136:244, ack 157, win 254, length 108 SMB-over-TCP packet:(raw data or continuation?)

	19:18:28.259008 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 157:257, ack 244, win 626, length 100 SMB-over-TCP packet:(raw data or continuation?)

	19:18:28.260427 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 257, win 254, length 0
	19:18:28.260669 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 244:520, ack 257, win 254, length 276 SMB-over-TCP packet:(raw data or continuation?)

	19:18:28.267107 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 1009, win 251, length 0
	19:18:28.267288 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 861:953, ack 1009, win 251, length 92 SMB-over-TCP packet:(raw data or continuation?)

	19:18:28.267538 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 1009:1137, ack 953, win 645, length 128 SMB-over-TCP packet:(raw data or continuation?)

	19:18:28.269283 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 1137, win 256, length 0
	19:18:29.786790 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 953:1071, ack 1137, win 256, length 118 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.788288 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 1137:1221, ack 1071, win 645, length 84 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.790588 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 1221, win 256, length 0
	19:18:29.790627 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 1071:1229, ack 1221, win 256, length 158 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.791118 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 1221:1361, ack 1229, win 655, length 140 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.792510 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 1361, win 255, length 0
	19:18:29.792730 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 1229:1409, ack 1361, win 255, length 180 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.793532 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 1361:1605, ack 1409, win 664, length 244 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.795329 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 1605, win 254, length 0
	19:18:29.796081 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 1409:1545, ack 1605, win 254, length 136 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.796443 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 1605:1761, ack 1545, win 674, length 156 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.798380 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 1761, win 254, length 0
	19:18:29.798711 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 1545:1653, ack 1761, win 254, length 108 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.798808 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 1761:1861, ack 1653, win 674, length 100 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.800332 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 1861, win 253, length 0
	19:18:29.800700 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 1653:1929, ack 1861, win 253, length 276 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.800817 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 1861:1945, ack 1929, win 683, length 84 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.803370 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 1945, win 253, length 0
	19:18:29.803381 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 1929:2046, ack 1945, win 253, length 117 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.803536 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 1945:2097, ack 2046, win 683, length 152 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.805291 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 2097, win 252, length 0
	19:18:29.805693 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 2046:2270, ack 2097, win 252, length 224 SMB-over-TCP packet:(raw data or continuation?)
	
	19:18:29.806120 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 2097:2305, ack 2270, win 693, length 208 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.807287 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 2305, win 252, length 0
	19:18:29.807632 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 2270:2362, ack 2305, win 252, length 92 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.807860 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 2305:2433, ack 2362, win 693, length 128 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.809307 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 2433, win 251, length 0
	19:18:29.810522 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 2362:2516, ack 2433, win 251, length 154 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.810709 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 2433:2510, ack 2516, win 702, length 77 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.812377 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 2510, win 251, length 0
	19:18:29.837640 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 2516:2792, ack 2510, win 251, length 276 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.838434 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 2510:2754, ack 2792, win 712, length 244 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.839568 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 2754:2831, ack 2792, win 712, length 77 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.840447 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 2754, win 256, length 0
	19:18:29.841329 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 2831, win 256, length 0
	19:18:29.849376 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 2792:3120, ack 2831, win 256, length 328 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.850131 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 2831:2908, ack 3120, win 721, length 77 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.851417 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 2908, win 256, length 0
	19:18:29.852074 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 3120:3558, ack 2908, win 256, length 438 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.853294 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 2908:3888, ack 3558, win 731, length 980 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.855514 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 3888, win 252, length 0
	19:18:29.855837 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 3558:3650, ack 3888, win 252, length 92 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.856075 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 3888:4016, ack 3650, win 731, length 128 SMB-over-TCP packet:(raw data or continuation?)

	19:18:29.857254 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 4016, win 251, length 0
	19:18:31.606907 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [P.], seq 3650:3871, ack 4016, win 251, length 221 SMB-over-TCP packet:(raw data or continuation?)

	19:18:31.607138 IP 192.168.1.34.microsoft-ds > 192.168.1.39.51515: Flags [P.], seq 4016:4220, ack 3871, win 740, length 204 SMB-over-TCP packet:(raw data or continuation?)

	19:18:31.608793 IP 192.168.1.39.51515 > 192.168.1.34.microsoft-ds: Flags [.], ack 4220, win 256, length 0
	^C
	58 packets captured
	65 packets received by filter
	7 packets dropped by kernel
	root@NAS-SEAX:/home/shared

	root@seax:~# ping 10.10.10.1
	PING 10.10.10.1 (10.10.10.1) 56(84) bytes of data.
	64 bytes from 10.10.10.1: icmp_seq=1 ttl=64 time=0.876 ms
	64 bytes from 10.10.10.1: icmp_seq=2 ttl=64 time=1.93 ms
	64 bytes from 10.10.10.1: icmp_seq=3 ttl=64 time=1.17 ms
	64 bytes from 10.10.10.1: icmp_seq=4 ttl=64 time=1.60 ms
	^C
	--- 10.10.10.1 ping statistics ---
	4 packets transmitted, 4 received, 0% packet loss, time 3036ms
	rtt min/avg/max/mdev = 0.876/1.396/1.930/0.401 ms
	root@seax:~#


# AUTOMUNTAGE SMB
-----------------

Primer de tot, es crearà un directori per als recursos de samba i s'especificarà els permissos i credencials necessàries:

	root@seax:~# mkdir samba
	root@seax:~#

	root@seax:~# ls
	samba  sftp
	root@seax:~#

	root@seax:~# cd samba/
	root@seax:~#

	root@seax:~/samba# nano entel.credentials
	root@seax:~#

	root@seax:~/samba# nano seax.credentials
	root@seax:~#

	root@seax:~/samba# chmod 700 *credentials
	root@seax:~#

	root@seax:~/samba# ls -l
	total 8
	-rwx------ 1 root root 6 may 25 19:58 entel.credentials
	-rwx------ 1 root root 5 may 25 19:58 seax.credentials
	root@seax:~/samba#

Es crearà els punts de muntatge per als recursos de samba:

	root@seax:~/samba# mkdir entel
	root@seax:~/samba#

	root@seax:~/samba# mkdir seax
	root@seax:~/samba#

	root@seax:~/samba# mkdir compartit
	root@seax:~/samba#

	root@seax:~/samba# ls -l
	total 8
	drwxrwsr-x 2 root 1002  0 may 25 19:27 compartit
	drwxr-x--- 3 1000 1000  0 may 25 18:47 entel
	-rwx------ 1 root root 30 may 25 20:04 entel.credentials
	drwxr-x--- 3 1001 1001  0 may 25 19:36 seax
	-rwx------ 1 root root 28 may 25 20:05 seax.credentials
	root@seax:~/samba#

	NOTA: Els identificadors d'usuari són els del servidor. En cas d'existir un usuari en el client amb aquest identificador, apareixerà com si fos
	      el propietari. Pot arribar a donar confusions, sobretot si estan creuats en servidor i client.
	      P. ex:

		- Client:
			* entel (1000)
			* seax (1001)
		- Servidor:
			* entel(1001)
			* seax (1000)

Assignació dels punts de muntatge de forma automàtica en l'fstab:

	root@seax:~/samba# tail -n3 /etc/fstab 
	//192.168.56.117/entel /root/samba/entel cifs defaults,credentials=/root/samba/entel.credentials,_netdev,users 0 0
	//192.168.56.117/seax /root/samba/seax cifs defaults,credentials=/root/samba/seax.credentials,_netdev,users 0 0
	//192.168.56.117/shared /root/samba/compartit cifs defaults,credentials=/root/samba/seax.credentials,_netdev,users 0 0
	root@seax:~/samba#

	NOTA: Es podía haver compartit directament el /home, però, s'ha volgut aïllar-los i mantenir un millor control tenint una
		  carpeta amb aquest propòsit.


# CONFIGURACIÓ VHOSTS I WEBDAV APACHE2
--------------------------------------

S'ha instal·lat apache2 i el mòdul de php tal i com s'especifica al programari necessari de la sessió 3.

Primer, com no es disposa d'un servidor de DNS, s'utilitzarà la caché local i es ficaran els dominis:

	root@seax:~# cat /etc/hosts | grep 192.168.56.117
	192.168.56.117	entel.com
	192.168.56.117	seax.com
	root@seax:~#

Es configurarán els dos hosts virtuals especificats en la sessió 3.

Primer, per poder accedir als recursos, és trivial assignar els permissos adients al home de cada usuari:

	root@NAS-SEAX:/home# chmod 770 seax
	root@NAS-SEAX:/home#

	root@NAS-SEAX:/home# chmod 770 entel
	root@NAS-SEAX:/home#

	root@NAS-SEAX:/home# chown :www-data seax
	root@NAS-SEAX:/home#

	root@NAS-SEAX:/home# chown :www-data entel
	root@NAS-SEAX:/home#

	root@NAS-SEAX:/home# ls -l
	total 5
	drwxrwx--- 3 entel www-data     7 may 25 18:47 entel
	drwxrwx--- 3 seax  www-data     7 may 25 19:36 seax
	drwxrwsr-x 2 root  filetransfer 4 may 25 19:27 shared
	root@NAS-SEAX:/home#

Per poder compartir també el directori compartir, es faran alguns canvis necessaris:

	root@NAS-SEAX:/home# chown www-data shared
	root@NAS-SEAX:/home#

	root@NAS-SEAX:/home# ls -l
	total 5
	drwxrwx--- 3 entel www-data     7 may 25 18:47 entel
	drwxrwx--- 3 seax  www-data     7 may 25 19:36 seax
	drwxrwsr-x 2 www-data  filetransfer 4 may 25 19:27 shared
	root@NAS-SEAX:/home#

Es crearà la contrasenya adient per a cada usuari per poder accedir al webdav:

	root@NAS-SEAX:~# htpasswd -c /etc/apache2/.seax.com seax
	New password: 
	Re-type new password: 
	Adding password for user seax
	root@NAS-SEAX:~#

	root@NAS-SEAX:~# htpasswd -c /etc/apache2/.entel.com entel
	New password: 
	Re-type new password: 
	Adding password for user entel
	root@NAS-SEAX:~#

Es crearà un site diferent per al protocol no segur i segur. També es distingirà el home de l'usuari de la carpeta compartida
fent servir la directiva alias i redirigint així a l'usuari al directori del sistema que es vol:

	root@NAS-SEAX:/etc/apache2/sites-available# cat seax.com.conf 
	<VirtualHost *:80>

		ServerName seax.com
		ServerAdmin webmaster@localhost
		DocumentRoot /var/www/seax.com


		ErrorLog ${APACHE_LOG_DIR}/error.log
		CustomLog ${APACHE_LOG_DIR}/access.log combined

		
		Alias /seax /home/seax
		Alias /shared /home/shared
			
		<Location /seax>
			DAV On
			Options None
			AuthType Basic
			AuthName webdav
			AuthUserFile /etc/apache2/.seax.com
			Require valid-user
			Options Includes FollowSymlinks MultiViews
			Options +Indexes
		        	AllowOverride all
		    	Order allow,deny
			Allow from all
		</Location>

		<Location /shared>
			DAV On
			Options None
			AuthType Basic
			AuthName webdav
			AuthUserFile /etc/apache2/.seax.com
			Require valid-user
			Options Includes FollowSymlinks MultiViews
			Options +Indexes
		        	AllowOverride all
		    	Order allow,deny
			Allow from all
		</Location>
		
	</VirtualHost>
	root@NAS-SEAX:/etc/apache2/sites-available#

Per al protocol segur, que previament cal haver habilitat el mòdul ssl com s'especifica a la sessió 2 de l'informe, la configuració
per fer-lo segur, queda així per a ambdós usuaris. Cadascú te la seva propia configuració, però, segueixen el mateix patró per aquest
motiu no cal mostrar tots dos plegats:

	root@NAS-SEAX:/etc/apache2/sites-available# cat seax-ssl.com.conf 
	<IfModule mod_ssl.c>
		<VirtualHost _default_:443>
			ServerName seax.com
			ServerAdmin webmaster@localhost

			DocumentRoot /var/www/seax.com

			ErrorLog ${APACHE_LOG_DIR}/error.log
			CustomLog ${APACHE_LOG_DIR}/access.log combined

			SSLEngine on

			SSLCertificateFile	/etc/ssl/certs/ssl-cert-snakeoil.pem
			SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key

			<FilesMatch "\.(cgi|shtml|phtml|php)$">
					SSLOptions +StdEnvVars
			</FilesMatch>
			<Directory /usr/lib/cgi-bin>
					SSLOptions +StdEnvVars
			</Directory>

		    	Alias /seax /home/seax
		    	Alias /shared /home/shared

		    	<Location /seax>
		           		DAV On
		            	Options None
		            	AuthType Basic
		            	AuthName webdav
		            	AuthUserFile /etc/apache2/.seax.com
		            	Require valid-user
		            	Options Includes FollowSymlinks MultiViews
		            	Options +Indexes
		            	AllowOverride all
		            	Order allow,deny
		            	Allow from all
		    	</Location>

		    	<Location /shared>
		           		DAV On
		            	Options None
		            	AuthType Basic
		            	AuthName webdav
		            	AuthUserFile /etc/apache2/.seax.com
		            	Require valid-user
		            	Options Includes FollowSymlinks MultiViews
		            	Options +Indexes
		            	AllowOverride all
		            	Order allow,deny
		            	Allow from all
		    	</Location>

		</VirtualHost>
	</IfModule>
	root@NAS-SEAX:/etc/apache2/sites-available#


# COMPROVACIÓ WEBDAV
--------------------

Comprovació des de l'aplicació cadaver entrant als dos sites tant de forma no segura com segura:

	* HTTP
	------

		root@seax:~# cadaver http://seax.com/seax
		Autenticación requerida para webdav en el servidor 'seax.com':
		Nombre de usuario: seax
		Contraseña: 
		dav:/seax/> ls
		Listando colección `/seax/': exitoso.
		 Col:   .ssh                                   0  may 25 17:41
				.bash_logout                         220  may 24 19:30
				.bashrc                             3526  may 24 19:30
				.profile                             675  may 24 19:30
			   *Nuevo documento de texto.txt           0  may 25 19:36
		dav:/seax/> exit
		Conexión con 'seax.com' cerrada.
		root@seax:~#

		root@seax:~# cadaver http://seax.com/shared
		Autenticación requerida para webdav en el servidor 'seax.com':
		Nombre de usuario: seax
		Contraseña: 
		dav:/shared/> ls
		Listando colección `/shared/': exitoso.
			   *Uploaded_file                          0  may  3 15:18
			   *test.py                              774  may 24 20:10
		dav:/shared/> exit
		Conexión con 'seax.com' cerrada.
		root@seax:~#

		root@seax:~# cadaver http://entel.com/entel
		Autenticación requerida para webdav en el servidor 'entel.com':
		Nombre de usuario: entel
		Contraseña: 
		dav:/entel/> ls
		Listando colección `/entel/': exitoso.
		 Col:   .ssh                                   0  may 25 17:41
				.bash_logout                         220  may 24 19:30
				.bashrc                             3526  may 24 19:30
				.profile                             675  may 24 19:30
				judit.txt                              6  may 25 18:47
		dav:/entel/> put itiel_prova.txt 
		Transferiendo itiel_prova.txt a '/entel/itiel_prova.txt': exitoso.
		dav:/entel/> exit
		Conexión con 'entel.com' cerrada.
		root@seax:~#

		root@seax:~# cadaver http://entel.com/shared
		Autenticación requerida para webdav en el servidor 'entel.com':
		Nombre de usuario: entel
		Contraseña: 
		dav:/shared/> ls
		Listando colección `/shared/': exitoso.
			   *Uploaded_file                          0  may  3 15:18
			   *test.py                              774  may 24 20:10
		dav:/shared/> put itiel_prova.txt 
		Transferiendo itiel_prova.txt a '/shared/itiel_prova.txt': exitoso.
		dav:/shared/> exit
		Conexión con 'entel.com' cerrada.
		root@seax:~#

	Accedient des del navegador de la màquina real:
		
		Index of /seax
		[ICO]	Name	Last modified	Size	Description
		[PARENTDIR]	Parent Directory	 	- 	 
		[TXT]	Nuevo documento de texto.txt	2019-05-25 19:36 	0 	 
		Apache/2.4.25 (Debian) Server at seax.com Port 80

		Index of /shared
		[ICO]	Name	Last modified	Size	Description
		[PARENTDIR]	Parent Directory	 	- 	 
		[ ]	Uploaded_file	2019-05-03 15:18 	0 	 
		[TXT]	itiel_prova.txt	2019-05-26 16:16 	0 	 
		[TXT]	test.py	2019-05-24 20:10 	774 	 
		Apache/2.4.25 (Debian) Server at seax.com Port 80

		Index of /entel
		[ICO]	Name	Last modified	Size	Description
		[PARENTDIR]	Parent Directory	 	- 	 
		[TXT]	itiel_prova.txt	2019-05-26 16:15 	0 	 
		[TXT]	judit.txt	2019-05-25 18:47 	6 	 
		Apache/2.4.25 (Debian) Server at entel.com Port 80

		Index of /shared
		[ICO]	Name	Last modified	Size	Description
		[PARENTDIR]	Parent Directory	 	- 	 
		[ ]	Uploaded_file	2019-05-03 15:18 	0 	 
		[TXT]	itiel_prova.txt	2019-05-26 16:16 	0 	 
		[TXT]	test.py	2019-05-24 20:10 	774 	 
		Apache/2.4.25 (Debian) Server at entel.com Port 80

	* HTTPS
	-------

		root@seax:~# cadaver https://seax.com/seax
		WARNING: Untrusted server certificate presented for `NAS-SEAX.epsevg.upc.edu':
		Certificate was issued to hostname `NAS-SEAX.epsevg.upc.edu' rather than `seax.com'
		This connection could have been intercepted.
		Issued to: NAS-SEAX.epsevg.upc.edu
		Issued by: NAS-SEAX.epsevg.upc.edu
		Certificate is valid from Sat, 25 May 2019 18:20:27 GMT to Tue, 22 May 2029 18:20:27 GMT
		Do you wish to accept the certificate? (y/n) y
		Autenticación requerida para webdav en el servidor 'seax.com':
		Nombre de usuario: seax
		Contraseña: 
		dav:/seax/> ls
		Listando colección `/seax/': exitoso.
		 Col:   .ssh                                   0  may 25 17:41
				.bash_logout                         220  may 24 19:30
				.bashrc                             3526  may 24 19:30
				.profile                             675  may 24 19:30
			   *Nuevo documento de texto.txt           0  may 25 19:36
		dav:/seax/> exit
		Conexión con 'seax.com' cerrada.
		root@seax:~#

		root@seax:~# cadaver https://seax.com/shared
		WARNING: Untrusted server certificate presented for `NAS-SEAX.epsevg.upc.edu':
		Certificate was issued to hostname `NAS-SEAX.epsevg.upc.edu' rather than `seax.com'
		This connection could have been intercepted.
		Issued to: NAS-SEAX.epsevg.upc.edu
		Issued by: NAS-SEAX.epsevg.upc.edu
		Certificate is valid from Sat, 25 May 2019 18:20:27 GMT to Tue, 22 May 2029 18:20:27 GMT
		Do you wish to accept the certificate? (y/n) y
		Autenticación requerida para webdav en el servidor 'seax.com':
		Nombre de usuario: seax
		Contraseña: 
		dav:/shared/> ls
		Listando colección `/shared/': exitoso.
			   *Uploaded_file                          0  may  3 15:18
			   *test.py                              774  may 24 20:10
		dav:/shared/> exit
		Conexión con 'seax.com' cerrada.
		root@seax:~#

		root@seax:~# cadaver https://entel.com/entel
		WARNING: Untrusted server certificate presented for `NAS-SEAX.epsevg.upc.edu':
		Certificate was issued to hostname `NAS-SEAX.epsevg.upc.edu' rather than `entel.com'
		This connection could have been intercepted.
		Issued to: NAS-SEAX.epsevg.upc.edu
		Issued by: NAS-SEAX.epsevg.upc.edu
		Certificate is valid from Sat, 25 May 2019 18:20:27 GMT to Tue, 22 May 2029 18:20:27 GMT
		Do you wish to accept the certificate? (y/n) y
		Autenticación requerida para webdav en el servidor 'entel.com':
		Nombre de usuario: entel
		Contraseña: 
		dav:/entel/> ls
		Listando colección `/entel/': exitoso.
		 Col:   .ssh                                   0  may 25 17:41
				.bash_logout                         220  may 24 19:30
				.bashrc                             3526  may 24 19:30
				.profile                             675  may 24 19:30
				itiel_prova.txt                        0  may 26  2019
				judit.txt                              6  may 25 18:47
		dav:/entel/> exit
		Conexión con 'entel.com' cerrada.
		root@seax:~#

		root@seax:~# cadaver https://entel.com/shared
		WARNING: Untrusted server certificate presented for `NAS-SEAX.epsevg.upc.edu':
		Certificate was issued to hostname `NAS-SEAX.epsevg.upc.edu' rather than `entel.com'
		This connection could have been intercepted.
		Issued to: NAS-SEAX.epsevg.upc.edu
		Issued by: NAS-SEAX.epsevg.upc.edu
		Certificate is valid from Sat, 25 May 2019 18:20:27 GMT to Tue, 22 May 2029 18:20:27 GMT
		Do you wish to accept the certificate? (y/n) y
		Autenticación requerida para webdav en el servidor 'entel.com':
		Nombre de usuario: entel
		Contraseña: 
		dav:/shared/> ls
		Listando colección `/shared/': exitoso.
			   *Uploaded_file                          0  may  3 15:18
				itiel_prova.txt                        0  may 26  2019
			   *test.py                              774  may 24 20:10
		dav:/shared/> exit
		Conexión con 'entel.com' cerrada.
		root@seax:~#

	Accedient des del navegador de la màquina real:

		Index of /seax
		[ICO]	Name	Last modified	Size	Description
		[PARENTDIR]	Parent Directory	 	- 	 
		[TXT]	Nuevo documento de texto.txt	2019-05-25 19:36 	0 	 
		Apache/2.4.25 (Debian) Server at seax.com Port 443

		Index of /shared
		[ICO]	Name	Last modified	Size	Description
		[PARENTDIR]	Parent Directory	 	- 	 
		[ ]	Uploaded_file	2019-05-03 15:18 	0 	 
		[TXT]	itiel_prova.txt	2019-05-26 16:16 	0 	 
		[TXT]	test.py	2019-05-24 20:10 	774 	 
		Apache/2.4.25 (Debian) Server at seax.com Port 443

		Index of /entel
		[ICO]	Name	Last modified	Size	Description
		[PARENTDIR]	Parent Directory	 	- 	 
		[TXT]	itiel_prova.txt	2019-05-26 16:15 	0 	 
		[TXT]	judit.txt	2019-05-25 18:47 	6 	 
		Apache/2.4.25 (Debian) Server at entel.com Port 443

		Index of /shared
		[ICO]	Name	Last modified	Size	Description
		[PARENTDIR]	Parent Directory	 	- 	 
		[ ]	Uploaded_file	2019-05-03 15:18 	0 	 
		[TXT]	itiel_prova.txt	2019-05-26 16:16 	0 	 
		[TXT]	test.py	2019-05-24 20:10 	774 	 
		Apache/2.4.25 (Debian) Server at entel.com Port 443

Capturant els paquets des del servidor quan el client vol accedir a entel.com/entel amb protocol NO segur:

	root@NAS-SEAX:/etc/apache2/sites-available# tcpdump -s 0 -i any port 80 or port 443
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
	16:26:03.356198 IP 192.168.56.116.43208 > 192.168.56.117.http: Flags [S], seq 2897330432, win 29200, options [mss 1460,sackOK,TS val 1511110 ecr 0,nop,wscale 7], length 0
	16:26:03.356256 IP 192.168.56.117.http > 192.168.56.116.43208: Flags [S.], seq 982228152, ack 2897330433, win 28960, options [mss 1460,sackOK,TS val 7338286 ecr 1511110,nop,wscale 7], length 0
	16:26:03.356691 IP 192.168.56.116.43208 > 192.168.56.117.http: Flags [.], ack 1, win 229, options [nop,nop,TS val 1511112 ecr 7338286], length 0
	16:26:03.356702 IP 192.168.56.116.43208 > 192.168.56.117.http: Flags [P.], seq 1:142, ack 1, win 229, options [nop,nop,TS val 1511112 ecr 7338286], length 141: HTTP: OPTIONS /entel/ HTTP/1.1
	16:26:03.356731 IP 192.168.56.117.http > 192.168.56.116.43208: Flags [.], ack 142, win 235, options [nop,nop,TS val 7338286 ecr 1511112], length 0
	16:26:03.357308 IP 192.168.56.117.http > 192.168.56.116.43208: Flags [P.], seq 1:717, ack 142, win 235, options [nop,nop,TS val 7338286 ecr 1511112], length 716: HTTP: HTTP/1.1 401 Unauthorized
	16:26:03.357676 IP 192.168.56.116.43208 > 192.168.56.117.http: Flags [.], ack 717, win 240, options [nop,nop,TS val 1511112 ecr 7338286], length 0
	16:26:06.599899 IP 192.168.56.116.43208 > 192.168.56.117.http: Flags [P.], seq 142:322, ack 717, win 240, options [nop,nop,TS val 1511923 ecr 7338286], length 180: HTTP: OPTIONS /entel/ HTTP/1.1
	16:26:06.602838 IP 192.168.56.117.http > 192.168.56.116.43208: Flags [P.], seq 717:1072, ack 322, win 243, options [nop,nop,TS val 7339097 ecr 1511923], length 355: HTTP: HTTP/1.1 200 OK
	16:26:06.603304 IP 192.168.56.116.43208 > 192.168.56.117.http: Flags [.], ack 1072, win 251, options [nop,nop,TS val 1511924 ecr 7339097], length 0
	16:26:06.604157 IP 192.168.56.116.43208 > 192.168.56.117.http: Flags [P.], seq 322:539, ack 1072, win 251, options [nop,nop,TS val 1511924 ecr 7339097], length 217: HTTP: PROPFIND /entel/ HTTP/1.1
	16:26:06.604184 IP 192.168.56.116.43208 > 192.168.56.117.http: Flags [P.], seq 539:827, ack 1072, win 251, options [nop,nop,TS val 1511924 ecr 7339097], length 288: HTTP
	16:26:06.604277 IP 192.168.56.117.http > 192.168.56.116.43208: Flags [.], ack 827, win 260, options [nop,nop,TS val 7339098 ecr 1511924], length 0
	16:26:06.610237 IP 192.168.56.117.http > 192.168.56.116.43208: Flags [P.], seq 1072:1917, ack 827, win 260, options [nop,nop,TS val 7339099 ecr 1511924], length 845: HTTP: HTTP/1.1 207 Multi-Status
	16:26:06.714397 IP 192.168.56.116.43208 > 192.168.56.117.http: Flags [.], ack 1917, win 264, options [nop,nop,TS val 1511952 ecr 7339099], length 0
	16:26:07.370104 IP 192.168.56.116.43208 > 192.168.56.117.http: Flags [P.], seq 827:1044, ack 1917, win 264, options [nop,nop,TS val 1512115 ecr 7339099], length 217: HTTP: PROPFIND /entel/ HTTP/1.1
	16:26:07.370162 IP 192.168.56.116.43208 > 192.168.56.117.http: Flags [P.], seq 1044:1332, ack 1917, win 264, options [nop,nop,TS val 1512115 ecr 7339099], length 288: HTTP
	16:26:07.370490 IP 192.168.56.117.http > 192.168.56.116.43208: Flags [.], ack 1332, win 277, options [nop,nop,TS val 7339290 ecr 1512115], length 0
	16:26:07.373821 IP 192.168.56.117.http > 192.168.56.116.43208: Flags [.], seq 1917:4813, ack 1332, win 277, options [nop,nop,TS val 7339290 ecr 1512115], length 2896: HTTP: HTTP/1.1 207 Multi-Status
	16:26:07.373916 IP 192.168.56.117.http > 192.168.56.116.43208: Flags [P.], seq 4813:5911, ack 1332, win 277, options [nop,nop,TS val 7339290 ecr 1512115], length 1098: HTTP
	16:26:07.374493 IP 192.168.56.116.43208 > 192.168.56.117.http: Flags [.], ack 5911, win 327, options [nop,nop,TS val 1512117 ecr 7339290], length 0
	16:26:08.035265 IP 192.168.56.116.43208 > 192.168.56.117.http: Flags [F.], seq 1332, ack 5911, win 327, options [nop,nop,TS val 1512282 ecr 7339290], length 0
	16:26:08.035845 IP 192.168.56.117.http > 192.168.56.116.43208: Flags [F.], seq 5911, ack 1333, win 277, options [nop,nop,TS val 7339456 ecr 1512282], length 0
	16:26:08.036210 IP 192.168.56.116.43208 > 192.168.56.117.http: Flags [.], ack 5912, win 327, options [nop,nop,TS val 1512282 ecr 7339456], length 0
	^C
	24 packets captured
	24 packets received by filter
	0 packets dropped by kernel
	root@NAS-SEAX:/etc/apache2/sites-available#

Capturant els paquets des del servidor quan el client vol accedir a entel.com/entel amb protocol segur:

	root@NAS-SEAX:/etc/apache2/sites-available# tcpdump -s 0 -i any port 80 or port 443
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
	16:24:19.159608 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [S], seq 773501325, win 29200, options [mss 1460,sackOK,TS val 1485063 ecr 0,nop,wscale 7], length 0
	16:24:19.159677 IP 192.168.56.117.https > 192.168.56.116.40040: Flags [S.], seq 3806044668, ack 773501326, win 28960, options [mss 1460,sackOK,TS val 7312237 ecr 1485063,nop,wscale 7], length 0
	16:24:19.159866 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [.], ack 1, win 229, options [nop,nop,TS val 1485063 ecr 7312237], length 0
	16:24:19.161212 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [P.], seq 1:225, ack 1, win 229, options [nop,nop,TS val 1485063 ecr 7312237], length 224
	16:24:19.161244 IP 192.168.56.117.https > 192.168.56.116.40040: Flags [.], ack 225, win 235, options [nop,nop,TS val 7312237 ecr 1485063], length 0
	16:24:19.163589 IP 192.168.56.117.https > 192.168.56.116.40040: Flags [P.], seq 1:1197, ack 225, win 235, options [nop,nop,TS val 7312238 ecr 1485063], length 1196
	16:24:19.163778 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [.], ack 1197, win 251, options [nop,nop,TS val 1485064 ecr 7312238], length 0
	16:24:19.206540 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [.], ack 1471, win 270, options [nop,nop,TS val 1485075 ecr 7312238], length 0
	16:24:20.172667 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [P.], seq 351:521, ack 1471, win 270, options [nop,nop,TS val 1485316 ecr 7312238], length 170
	16:24:20.173388 IP 192.168.56.117.https > 192.168.56.116.40040: Flags [P.], seq 1471:2217, ack 521, win 243, options [nop,nop,TS val 7312490 ecr 1485316], length 746
	16:24:20.173816 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [.], ack 2217, win 289, options [nop,nop,TS val 1485316 ecr 7312490], length 0
	16:24:22.470926 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [P.], seq 521:730, ack 2217, win 289, options [nop,nop,TS val 1485891 ecr 7312490], length 209
	16:24:22.474736 IP 192.168.56.117.https > 192.168.56.116.40040: Flags [P.], seq 2217:2601, ack 730, win 252, options [nop,nop,TS val 7313066 ecr 1485891], length 384
	16:24:22.475257 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [.], ack 2601, win 307, options [nop,nop,TS val 1485892 ecr 7313066], length 0
	16:24:22.475740 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [P.], seq 730:976, ack 2601, win 307, options [nop,nop,TS val 1485892 ecr 7313066], length 246
	16:24:22.476230 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [P.], seq 976:1293, ack 2601, win 307, options [nop,nop,TS val 1485892 ecr 7313066], length 317
	16:24:22.476264 IP 192.168.56.117.https > 192.168.56.116.40040: Flags [.], ack 1293, win 269, options [nop,nop,TS val 7313066 ecr 1485892], length 0
	16:24:22.485887 IP 192.168.56.117.https > 192.168.56.116.40040: Flags [P.], seq 2601:3475, ack 1293, win 269, options [nop,nop,TS val 7313068 ecr 1485892], length 874
	16:24:22.693712 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [.], ack 3475, win 326, options [nop,nop,TS val 1485946 ecr 7313068], length 0
	16:24:24.781295 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [P.], seq 1293:1539, ack 3475, win 326, options [nop,nop,TS val 1486468 ecr 7313068], length 246
	16:24:24.781358 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [P.], seq 1539:1856, ack 3475, win 326, options [nop,nop,TS val 1486468 ecr 7313068], length 317
	16:24:24.781384 IP 192.168.56.117.https > 192.168.56.116.40040: Flags [.], ack 1856, win 285, options [nop,nop,TS val 7313642 ecr 1486468], length 0
	16:24:24.786540 IP 192.168.56.117.https > 192.168.56.116.40040: Flags [.], seq 3475:6371, ack 1856, win 285, options [nop,nop,TS val 7313643 ecr 1486468], length 2896
	16:24:24.786901 IP 192.168.56.117.https > 192.168.56.116.40040: Flags [P.], seq 6371:7527, ack 1856, win 285, options [nop,nop,TS val 7313643 ecr 1486468], length 1156
	16:24:24.787490 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [.], ack 7527, win 389, options [nop,nop,TS val 1486470 ecr 7313643], length 0
	16:24:25.964555 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [P.], seq 1856:1887, ack 7527, win 389, options [nop,nop,TS val 1486764 ecr 7313643], length 31
	16:24:25.964595 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [F.], seq 1887, ack 7527, win 389, options [nop,nop,TS val 1486764 ecr 7313643], length 0
	16:24:25.964949 IP 192.168.56.117.https > 192.168.56.116.40040: Flags [P.], seq 7527:7558, ack 1888, win 285, options [nop,nop,TS val 7313938 ecr 1486764], length 31
	16:24:25.965328 IP 192.168.56.116.40040 > 192.168.56.117.https: Flags [R], seq 773503213, win 0, length 0

	29 packets captured
	31 packets received by filter
	2 packets dropped by kernel
	^Croot@NAS-SEAX:/etc/apache2/sites-available#

	NOTA: A diferència de l'anterior captura de paquets, en aquesta no es pot llegir res ni tampoc interpretar-ne cap cosa.


# AUTOMUNTATGE WEBDAV
---------------------

Primer de tot cal instal·lar el paquet que s'especifica en el programari necessari per a aquesta sessió avaluable.

Tot seguit, es crearà l'estructura de fitxer com s'ha fet amb els altres serveis:

	root@seax:~# mkdir webdav
	root@seax:~#

	root@seax:~# cd webdav
	root@seax:~#

	root@seax:~/webdav# mkdir entel
	root@seax:~#

	root@seax:~/webdav# mkdir seax
	root@seax:~#

	root@seax:~/webdav# mkdir shared
	root@seax:~#

Cal afegir la uri, l'usuari i la clau per a cada recurs que es vol muntar:
	
	root@seax:~# echo "https://seax.com/seax seax xaes" | tee -a /etc/davfs2/secrets
	https://seax.com/seax seax xaes
	root@seax:~#

	root@seax:~# echo "https://seax.com/shared seax xaes" | tee -a /etc/davfs2/secrets
	https://seax.com/shared seax xaes
	root@seax:~#

	root@seax:~# echo "https://entel.com/shared entel letne" | tee -a /etc/davfs2/secrets
	https://entel.com/shared entel letne
	root@seax:~#

	root@seax:~# tail -n3 /etc/davfs2/secrets
	https://seax.com/seax seax xaes
	https://seax.com/shared seax xaes
	https://entel.com/shared entel letne
	root@seax:~#

	NOTA: S'ha muntat un recursos shared perquè és el mateix per a ambdós usuaris.

Per muntar el recurs de forma segura, cal afegir el certificat. Es farà per als dos dominis tot i compartir el mateix certificat:

	root@seax:~# openssl s_client -showcerts -connect seax.com:443 < /dev/null 2> /dev/null | openssl x509 -outform PEM |  tee /etc/davfs2/certs/seax.com
	-----BEGIN CERTIFICATE-----
	MIIC+DCCAeCgAwIBAgIJAOpQ0yUqTZkLMA0GCSqGSIb3DQEBCwUAMCIxIDAeBgNV
	BAMMF05BUy1TRUFYLmVwc2V2Zy51cGMuZWR1MB4XDTE5MDUyNTE4MjAyN1oXDTI5
	MDUyMjE4MjAyN1owIjEgMB4GA1UEAwwXTkFTLVNFQVguZXBzZXZnLnVwYy5lZHUw
	ggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCstSQGPiVKUVV+gdcqrDXP
	i40t6RHJLO75lWTsVjT/M4yhKxI3p8Gn8oRddb+f6bhzEZbLDDqKDHby85JJZ0BQ
	JAyk8PBAuYswJG/Xq49WYli3TzRl7bWad8hEn8o7lE3hzqyMgB2vAMyVPExmu4fV
	jjnmSczoTo3dFy6UhygJLvioKz+/dh/j2VBvjjTW9ZE8LGww3VthhP10iF1eCXkU
	fbjZhKdGdLJ2VuRREk6scDq3LYQRAZ4S30eZQaHRVaw4STUwgebPbk8eMbqruMy9
	EMcfnjXWVgMQBNxEJS9VdvOdKNtEyVafPLYRy8ILzd1A/AECzxfNpeCRyZClDX5V
	AgMBAAGjMTAvMAkGA1UdEwQCMAAwIgYDVR0RBBswGYIXTkFTLVNFQVguZXBzZXZn
	LnVwYy5lZHUwDQYJKoZIhvcNAQELBQADggEBAHo9TkkzMaqS0qwmsdWydZN6wBtE
	qv97P6I/sxZYuZX3L2giDW93q3J4/MWUBc3/71P8eRYR8AiFiwBn+qvVvxz2gy+N
	XE51E2tzypj/lrv47oi8NHB1sa4YTj95iJK+tJja9N3dERlCXyX/G05pgI272Gcu
	MS1+FyihHuesZe+4dYtwEj4MbmNErCgS1NufRUu2zu4CGdGea97Jc7mgJIro1jj3
	3EwU7e34PMzU1m6zqXX0swSIQ7yLSxoxI5D77JCcy3//bm/2GeoUB6hr2b236qsB
	1eUhkoX1p7csZthLv3y3oUB8E0PtwtzBRB7xlz7TCLIx509PHFDInV9ooEY=
	-----END CERTIFICATE-----
	root@seax:~#

	root@seax:~# openssl s_client -showcerts -connect entel.com:443 < /dev/null 2> /dev/null | openssl x509 -outform PEM |  tee /etc/davfs2/certs/entel.com
	-----BEGIN CERTIFICATE-----
	MIIC+DCCAeCgAwIBAgIJAOpQ0yUqTZkLMA0GCSqGSIb3DQEBCwUAMCIxIDAeBgNV
	BAMMF05BUy1TRUFYLmVwc2V2Zy51cGMuZWR1MB4XDTE5MDUyNTE4MjAyN1oXDTI5
	MDUyMjE4MjAyN1owIjEgMB4GA1UEAwwXTkFTLVNFQVguZXBzZXZnLnVwYy5lZHUw
	ggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCstSQGPiVKUVV+gdcqrDXP
	i40t6RHJLO75lWTsVjT/M4yhKxI3p8Gn8oRddb+f6bhzEZbLDDqKDHby85JJZ0BQ
	JAyk8PBAuYswJG/Xq49WYli3TzRl7bWad8hEn8o7lE3hzqyMgB2vAMyVPExmu4fV
	jjnmSczoTo3dFy6UhygJLvioKz+/dh/j2VBvjjTW9ZE8LGww3VthhP10iF1eCXkU
	fbjZhKdGdLJ2VuRREk6scDq3LYQRAZ4S30eZQaHRVaw4STUwgebPbk8eMbqruMy9
	EMcfnjXWVgMQBNxEJS9VdvOdKNtEyVafPLYRy8ILzd1A/AECzxfNpeCRyZClDX5V
	AgMBAAGjMTAvMAkGA1UdEwQCMAAwIgYDVR0RBBswGYIXTkFTLVNFQVguZXBzZXZn
	LnVwYy5lZHUwDQYJKoZIhvcNAQELBQADggEBAHo9TkkzMaqS0qwmsdWydZN6wBtE
	qv97P6I/sxZYuZX3L2giDW93q3J4/MWUBc3/71P8eRYR8AiFiwBn+qvVvxz2gy+N
	XE51E2tzypj/lrv47oi8NHB1sa4YTj95iJK+tJja9N3dERlCXyX/G05pgI272Gcu
	MS1+FyihHuesZe+4dYtwEj4MbmNErCgS1NufRUu2zu4CGdGea97Jc7mgJIro1jj3
	3EwU7e34PMzU1m6zqXX0swSIQ7yLSxoxI5D77JCcy3//bm/2GeoUB6hr2b236qsB
	1eUhkoX1p7csZthLv3y3oUB8E0PtwtzBRB7xlz7TCLIx509PHFDInV9ooEY=
	-----END CERTIFICATE-----
	root@seax:~# 

Cal indicar al demon de quin certificat es vol confiar:

	root@seax:~# echo "trust_server_cert seax.com" | tee -a /etc/davfs2/davfs2.conf
	trust_server_cert seax.com
	root@seax:~#

	root@seax:~# echo "trust_server_cert entel.com" | tee -a /etc/davfs2/davfs2.conf
	trust_server_cert entel.com
	root@seax:~#

	root@seax:~# cat /etc/davfs2/davfs2.conf | grep trust_server_cert
	# trust_server_cert
	trust_server_cert seax.com
	trust_server_cert entel.com
	root@seax:~#

Per últim queda indicar-li al fstab que automunti els recursos en els directoris que es volen:

	root@seax:~# tail -n3 /etc/fstab 
	https://seax.com/seax /root/webdav/seax davfs defaults,_netdev 0 0
	https://seax.com/shared /root/webdav/shared davfs defaults,_netdev 0 0
	https://entel.com/entel /root/webdav/entel davfs defaults,_netdev 0 0
	root@seax:~#

Comprovació d'automuntatge dels recursos sol·licitats:

	root@seax:~# df -h | grep /root
	seax@192.168.56.117:/     334M   128K  334M   1% /root/sftp/seax
	entel@192.168.56.117:/    334M   128K  334M   1% /root/sftp/entel
	https://seax.com/seax     1,3T   763G  509G  61% /root/webdav/seax
	https://entel.com/entel   1,3T   763G  509G  61% /root/webdav/entel
	//192.168.56.117/shared   334M   128K  334M   1% /root/samba/compartit
	//192.168.56.117/entel    334M   128K  334M   1% /root/samba/entel
	https://seax.com/shared   1,3T   763G  509G  61% /root/webdav/shared
	//192.168.56.117/seax     334M   128K  334M   1% /root/samba/seax
	root@seax:~# 

	NOTA: Es poden veure els tres serveis funcionant correctament.

Comprovació d'un directori que tingui els fitxers esperats:

	root@seax:~# ls -l webdav/shared/
	total 1
	-rw-r--r-- 1 root root   0 may 26 16:16 itiel_prova.txt
	drwx------ 2 root root   0 may 28 15:37 lost+found
	-rwxr-xr-x 1 root root 774 may 24 20:10 test.py
	-rwxr-xr-x 1 root root   0 may  3 15:18 Uploaded_file
	root@seax:~#

Comprovació de que el tràfic està xifrat i va per el 443 quan es fa un ls d'un directori webdav:

	root@seax:~# ls -l webdav/entel/
	total 1
	-rw-r--r-- 1 root root 0 may 26 16:15 itiel_prova.txt
	-rw-r--r-- 1 root root 6 may 25 18:47 judit.txt
	drwx------ 2 root root 0 may 28 16:01 lost+found
	root@seax:~# 

	root@NAS-SEAX:/etc# tcpdump -i any port 443
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
	16:18:02.068061 IP 192.168.56.116.57418 > 192.168.56.117.https: Flags [P.], seq 966265957:966266201, ack 2301426276, win 393, options [nop,nop,TS val 4294939594 ecr 2799996], length 244
	16:18:02.068199 IP 192.168.56.117.https > 192.168.56.116.57418: Flags [R], seq 2301426276, win 0, length 0
	16:18:02.068275 IP 192.168.56.116.57418 > 192.168.56.117.https: Flags [P.], seq 244:530, ack 1, win 393, options [nop,nop,TS val 4294939594 ecr 2799996], length 286
	16:18:02.068300 IP 192.168.56.117.https > 192.168.56.116.57418: Flags [R], seq 2301426276, win 0, length 0
	16:18:02.068324 IP 192.168.56.116.57418 > 192.168.56.117.https: Flags [P.], seq 530:561, ack 1, win 393, options [nop,nop,TS val 4294939594 ecr 2799996], length 31
	16:18:02.068343 IP 192.168.56.117.https > 192.168.56.116.57418: Flags [R], seq 2301426276, win 0, length 0
	16:18:02.068750 IP 192.168.56.116.57432 > 192.168.56.117.https: Flags [S], seq 3674186930, win 29200, options [mss 1460,sackOK,TS val 4294939594 ecr 0,nop,wscale 7], length 0
	16:18:07.077435 IP 192.168.56.117.https > 192.168.56.116.57432: Flags [P.], seq 2567308289:2567308320, ack 3674188029, win 252, options [nop,nop,TS val 2846016 ecr 4294939595], length 31
	16:18:07.077808 IP 192.168.56.117.https > 192.168.56.116.57432: Flags [F.], seq 31, ack 1, win 252, options [nop,nop,TS val 2846016 ecr 4294939595], length 0
	16:18:07.093019 IP 192.168.56.117.https > 192.168.56.116.57432: Flags [F.], seq 31, ack 1, win 252, options [nop,nop,TS val 2846020 ecr 4294939595], length 0
	16:18:07.093733 IP 192.168.56.116.57432 > 192.168.56.117.https: Flags [.], ack 32, win 300, options [nop,nop,TS val 4294940850 ecr 2846016,nop,nop,sack 1 {31:32}], length 0
	^C
	11 packets captured
	23 packets received by filter
	12 packets dropped by kernel
	root@NAS-SEAX:/etc#

	NOTA: El firewall està en política per defecte DROP i està deixant passar el tràfic de webdav.


# CONFIGURACIÓ SERVIDOR OPENVPN
-------------------------------

Primer és necessari instal·lar-lo com s'especifica en el programari necessari i configurar-lo, tal i com s'especifica en la sessió 4.

Partint de que aquest servidor hagués estat en l'escenari de la pràctica 2, cal afegir les rutes per poder accedir a la resta de serveis:
	root@NAS-SEAX:/etc/openvpn# cat server.conf
	.
	.
	.
	push "route 10.10.0.0 255.255.248.0"
	.
	.
	.
	root@NAS-SEAX:/etc/openvpn#

Comprovació de que la interficie està activa:

	root@NAS-SEAX:~# ip addr list tun0
	4: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 100
		link/none 
		inet 10.10.10.1 peer 10.10.10.2/32 scope global tun0
		   valid_lft forever preferred_lft forever
		inet6 fe80::64ff:6495:3d0:e20b/64 scope link flags 800 
		   valid_lft forever preferred_lft forever
	root@NAS-SEAX:~#


# CONFIGURACIÓ CLIENT OPENVPN
-----------------------------

IMPORTANT: Si les màquines no estan mínimament sincronitzades temporalment, el client rebutjarà el certificat, encara que
sigui una diferència de poques hores:

	root@seax:~# tail /var/log/syslog 
	May 26 04:42:20 seax ovpn-openvpn[386]: UDP link local: (not bound)
	May 26 04:42:20 seax ovpn-openvpn[386]: UDP link remote: [AF_INET]192.168.56.117:1194
	May 26 04:42:20 seax ovpn-openvpn[386]: TLS: Initial packet from [AF_INET]192.168.56.117:1194, sid=e3494d25 c264315a
	May 26 04:42:20 seax ovpn-openvpn[386]: VERIFY ERROR: depth=1, error=certificate is not yet valid: C=ES, ST=BCN, L=Vilanova i la GeltrÃº, O=Universitat PolitÃ¨cnica de Catalunya, OU=Seguretat i AdministraciÃ³ de Xarxes, CN=Universitat PolitÃ¨cnica de Catalunya CA, name=EasyRSA, emailAddress=itiel@admin.com
	May 26 04:42:20 seax ovpn-openvpn[386]: OpenSSL: error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify failed
	May 26 04:42:20 seax ovpn-openvpn[386]: TLS_ERROR: BIO read tls_read_plaintext error
	May 26 04:42:20 seax ovpn-openvpn[386]: TLS Error: TLS object -> incoming plaintext read error
	May 26 04:42:20 seax ovpn-openvpn[386]: TLS Error: TLS handshake failed
	May 26 04:42:20 seax ovpn-openvpn[386]: SIGUSR1[soft,tls-error] received, process restarting
	May 26 04:42:20 seax ovpn-openvpn[386]: Restart pause, 160 second(s)
	root@seax:~#

S'ha modificat l'script que es va fer en la sessió 4 especificat en l'informe en l'apartat GENERACIÓ FITXER DE CONFIGURACIÓ .OVPN:

	#!/bin/bash

	if [ $# -ne 1 ]; then
	 echo "Usage() ovpn-filler.sh <user_certificate>"
	 exit 0
	fi

	cp template.ovpn "$1.ovpn"
	echo "key-direction 1" >> "$1.ovpn"
	echo "<ca>" >> "$1.ovpn"
	sed -n '/BEGIN CERTIFICATE/,/END CERTIFICATE/p' < ../certs/keys/ca.crt >> "$1.ovpn"
	echo "</ca>" >> "$1.ovpn"
	echo "<cert>" >> "$1.ovpn"
	sed -n '/BEGIN CERTIFICATE/,/END CERTIFICATE/p' < ../certs/keys/$1.crt >> "$1.ovpn"
	echo "</cert>" >> "$1.ovpn"
	echo "<key>" >> "$1.ovpn"
	sed -n '/BEGIN PRIVATE KEY/,/END PRIVATE KEY/p' < ../certs/keys/$1.key >> "$1.ovpn"
	echo "</key>" >> "$1.ovpn"
	echo "<tls-auth>" >> "$1.ovpn"
	sed -n '/-----BEGIN OpenVPN Static key V1-----/,/-----BEGIN OpenVPN Static key V1-----/p' < ../certs/keys/ta.key >> "$1.ovpn"
	echo "</tls-auth>" >> "$1.ovpn"


Després d'instal·lar el client i passar el fitxer de configuració .ovpn per comanda scp i sincronitzar les màquines, es validarà l'interficie:

	root@seax:~# ip addr list tun0
	4: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 100
	    link/none 
	    inet 10.10.10.6 peer 10.10.10.5/32 scope global tun0
	       valid_lft forever preferred_lft forever
	    inet6 fe80::d2d8:9f73:d792:be6/64 scope link flags 800 
	       valid_lft forever preferred_lft forever
	root@seax:~#


# COMPROVACIÓ CLIENT OPENVPN
----------------------------

Ping directament al servidor d'OpenVPN:

	root@seax:~# ping 10.10.10.1
	PING 10.10.10.1 (10.10.10.1) 56(84) bytes of data.
	64 bytes from 10.10.10.1: icmp_seq=1 ttl=64 time=0.876 ms
	64 bytes from 10.10.10.1: icmp_seq=2 ttl=64 time=1.93 ms
	64 bytes from 10.10.10.1: icmp_seq=3 ttl=64 time=1.17 ms
	64 bytes from 10.10.10.1: icmp_seq=4 ttl=64 time=1.60 ms
	^C
	--- 10.10.10.1 ping statistics ---
	4 packets transmitted, 4 received, 0% packet loss, time 3036ms
	rtt min/avg/max/mdev = 0.876/1.396/1.930/0.401 ms
	root@seax:~#

Vista des del servidor OpenVPN en la interficie del tunnel:

	root@NAS-SEAX:/etc/openvpn# tcpdump -i tun0
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on tun0, link-type RAW (Raw IP), capture size 262144 bytes
	00:22:41.883711 IP 10.10.10.10.ntp > ntp.redimadrid.es.ntp: NTPv4, Client, length 48
	00:22:41.887187 IP 10.10.10.10.ntp > i2t15.i2t.ehu.eus.ntp: NTPv4, Client, length 48
	00:22:42.696178 IP 10.10.10.10 > 10.10.10.1: ICMP echo request, id 1201, seq 1, length 64
	00:22:42.696215 IP 10.10.10.1 > 10.10.10.10: ICMP echo reply, id 1201, seq 1, length 64
	00:22:43.723560 IP 10.10.10.10 > 10.10.10.1: ICMP echo request, id 1201, seq 2, length 64
	00:22:43.723647 IP 10.10.10.1 > 10.10.10.10: ICMP echo reply, id 1201, seq 2, length 64
	00:22:43.735490 IP 10.10.10.10.56324 > 254.red-80-58-61.staticip.rima-tde.net.domain: 18905+ A? 3.debian.pool.ntp.org.Home. (44)
	00:22:43.735722 IP 10.10.10.10.56324 > 254.red-80-58-61.staticip.rima-tde.net.domain: 23454+ AAAA? 3.debian.pool.ntp.org.Home. (44)
	00:22:44.731701 IP 10.10.10.10 > 10.10.10.1: ICMP echo request, id 1201, seq 3, length 64
	00:22:44.731753 IP 10.10.10.1 > 10.10.10.10: ICMP echo reply, id 1201, seq 3, length 64
	00:22:45.733077 IP 10.10.10.10 > 10.10.10.1: ICMP echo request, id 1201, seq 4, length 64
	00:22:45.733117 IP 10.10.10.1 > 10.10.10.10: ICMP echo reply, id 1201, seq 4, length 64
	^C
	12 packets captured
	12 packets received by filter
	0 packets dropped by kernel
	root@NAS-SEAX:/etc/openvpn#


# ESTRUCTURA DE FITXERS, PERMISOS I PROVES (FIREWALL ACTIVAT)
-------------------------------------------------------------

Motreig de l'fstab final:

	root@seax:~# tail -n9 /etc/fstab 
	entel@192.168.56.117:/entel /root/sftp/entel fuse.sshfs defaults,idmap=user,reconnect,_netdev,users,IdentityFile=/root/.ssh/id_rsa 0 0
	seax@192.168.56.117:/seax /root/sftp/seax fuse.sshfs defaults,idmap=user,reconnect,_netdev,users,IdentityFile=/root/.ssh/id_rsa 0 0
	seax@192.168.56.117:/shared /root/sftp/shared fuse.sshfs defaults,idmap=user,reconnect,_netdev,users,IdentityFile=/root/.ssh/id_rsa 0 0
	//192.168.56.117/entel /root/samba/entel cifs defaults,credentials=/root/samba/entel.credentials,_netdev,users 0 0
	//192.168.56.117/seax /root/samba/seax cifs defaults,credentials=/root/samba/seax.credentials,_netdev,users 0 0
	//192.168.56.117/shared /root/samba/compartit cifs defaults,credentials=/root/samba/seax.credentials,_netdev,users 0 0
	https://seax.com/seax /root/webdav/seax davfs defaults,_netdev 0 0
	https://seax.com/shared /root/webdav/shared davfs defaults,_netdev 0 0
	https://entel.com/entel /root/webdav/entel davfs defaults,_netdev 0 0
	root@seax:~#

	NOTA: Per muntar el recurs shared, qualsevol dels dos usuaris pot muntar-lo ja que és compartit.

Vista des del costat del servidor:

	root@NAS-SEAX:/home# chmod g+s entel/
	root@NAS-SEAX:/home# chmod g+s seax
	root@NAS-SEAX:/home# ls -l
	total 5
	drwxrws--- 3 entel    www-data     9 may 31 13:16 entel
	drwxrws--- 3 seax     www-data     7 may 26 15:44 seax
	drwxrwsr-x 2 www-data filetransfer 5 may 26 16:16 shared
	root@NAS-SEAX:/home#

	NOTA: S'han afegit els bits sticky per a que quan l'usuari que munti el recurs i afegeixi fitxers/directoris nous, aquests no
		  adquireixin com a grup propietari el de l'usuari en qüestió, sinó, que respecti el propietari del recurs.

Des del costat del client, l'usuari root serà l'encarregat de muntar els serveis. Tindrà tres carpetes per diferenciar els serveis,
que en realitat es tractaran dels mateixos recursos, és a dir, si l'usuari afegeix un fitxer en samba, el veurà en la carpeta també
muntada per sftp i webdav i viceversa en tots el sentits. Aquesta és l'estructura de fitxers en el directori /root:

	root@seax:~# ls -l
	total 12
	drwxr-xr-x 5 root root 4096 may 31 13:15 samba
	drwxr-xr-x 4 root root 4096 may 25 17:52 sftp
	drwxr-xr-x 5 root root 4096 may 28 15:12 webdav
	root@seax:~#

	* SFTP	
	------

		root@seax:~# ls -l sftp/
		total 12
		drwxr-xr-x 2 root root 4096 may 25 17:52 entel
		drwxr-xr-x 2 root root 4096 may 25 17:52 seax
		drwxr-xr-x 2 root root 4096 may 31 13:26 shared
		root@seax:~# 

			root@seax:~# ls -l sftp/entel/
			total 4
			-rw-r--r-- 1 www-data www-data 0 may 26 16:15 itiel_prova.txt
			-rw-r--r-- 1 root     root     6 may 25 18:47 judit.txt
			root@seax:~#

			root@seax:~# ls -l sftp/seax
			total 0
			-rwxrw-r-- 1 1001 1001 0 may 25 19:36 Nuevo documento de texto.txt
			root@seax:~#

			root@seax:~# ls -l sftp/shared/
			total 4
			-rw-r--r-- 1 www-data 1002   0 may 26 16:16 itiel_prova.txt
			-rwxr-xr-x 1     1000 1002 774 may 24 20:10 test.py
			-rwxrw-r-- 1     1000 1002   0 may  3 15:18 Uploaded_file
			root@seax:~# 

	* SAMBA
	-------

		root@seax:~# ls -l samba/
		total 8
		drwxrwsr-x 2 www-data     1002  0 may 26 16:16 compartit
		drwxrws--- 3     1000 www-data  0 may 31 13:16 entel
		-rwx------ 1 root     root     30 may 25 20:04 entel.credentials
		drwxrws--- 3     1001 www-data  0 may 26 15:44 seax
		-rwx------ 1 root     root     28 may 25 20:05 seax.credentials
		root@seax:~#

			root@seax:~# ls -l samba/entel
			total 2
			-rw-r--r-- 1 www-data www-data 0 may 26 16:15 itiel_prova.txt
			-rw-r--r-- 1 root     root     6 may 25 18:47 judit.txt
			root@seax:~#

			root@seax:~# ls -l samba/seax
			total 1
			-rwxrw-r-- 1 1001 1001 0 may 25 19:36 Nuevo documento de texto.txt
			root@seax:~#

			root@seax:~# ls -l samba/compartit/
			total 3
			-rw-r--r-- 1 www-data 1002   0 may 26 16:16 itiel_prova.txt
			-rwxr-xr-x 1     1000 1002 774 may 24 20:10 test.py
			-rwxrw-r-- 1     1000 1002   0 may  3 15:18 Uploaded_file
			root@seax:~#

	* WEBDAV
	--------

		root@seax:~# ls -l webdav/
		total 2
		drwxr-xr-x 4 root root 328 may 31 13:16 entel
		drwxr-xr-x 4 root root 264 may 26 15:44 seax
		drwxr-xr-x 3 root root 184 may 26 16:16 shared
		root@seax:~# 

			root@seax:~# ls -l webdav/entel/
			total 1
			-rw-r--r-- 1 root root 0 may 26 16:15 itiel_prova.txt
			-rw-r--r-- 1 root root 6 may 25 18:47 judit.txt
			drwx------ 2 root root 0 may 28 16:01 lost+found
			root@seax:~# 
	
			root@seax:~# ls -l webdav/seax/
			total 0
			drwx------ 2 root root 0 may 28 15:54 lost+found
			-rwxr-xr-x 1 root root 0 may 25 19:36 Nuevo documento de texto.txt
			root@seax:~#

			root@seax:~# ls -l webdav/shared/
			total 1
			-rw-r--r-- 1 root root   0 may 26 16:16 itiel_prova.txt
			drwx------ 2 root root   0 may 28 15:37 lost+found
			-rwxr-xr-x 1 root root 774 may 24 20:10 test.py
			-rwxr-xr-x 1 root root   0 may  3 15:18 Uploaded_file
			root@seax:~#
	
Creació d'un fitxer des de samba i eliminació del mateix per sftp:

	root@seax:~/samba/entel# touch itiel-proves
	root@seax:~/samba/entel# cd ..
	root@seax:~/samba# cd ..
	root@seax:~# cd sftp/
	root@seax:~/sftp# cd entel/
	root@seax:~/sftp/entel# ls -l
	total 4
	-rw-r--r-- 1 www-data www-data 0 may 26 16:15 itiel_prova.txt
	-rw-rw-r-- 1     1000 www-data 0 may 31 14:56 itiel-proves
	-rw-r--r-- 1 root     root     6 may 25 18:47 judit.txt
	root@seax:~/sftp/entel# rm itiel-proves 
	root@seax:~/sftp/entel#

Creació de fitxer des de webdav i eliminació en samba:

	root@seax:~# cd webdav/
	root@seax:~/webdav# cd seax/
	root@seax:~/webdav/seax# touch itiel-proves
	root@seax:~/webdav/seax# ls -l
	total 0
	-rw-r--r-- 1 root root 0 may 31 14:57 itiel-proves
	drwx------ 2 root root 0 may 28 15:54 lost+found
	-rwxr-xr-x 1 root root 0 may 25 19:36 Nuevo documento de texto.txt
	root@seax:~/webdav/seax# cd ..
	root@seax:~/webdav# cd ..
	root@seax:~# cd samba/
	root@seax:~/samba# cd seax/
	root@seax:~/samba/seax# rm itiel-proves 
	root@seax:~/samba/seax# ls -l
	total 1
	-rwxrw-r-- 1 1001 1001 0 may 25 19:36 Nuevo documento de texto.txt
	root@seax:~/samba/seax#

Creació de fitxer des de sftp i eliminació en webdav:

	root@seax:~# cd sftp/
	root@seax:~/sftp# cd shared/
	root@seax:~/sftp/shared# touch itiel-proves
	root@seax:~/sftp/shared# cd ..
	root@seax:~/sftp# cd ..
	root@seax:~# cd webdav/
	root@seax:~/webdav# cd shared/
	root@seax:~/webdav/shared# rm itiel-proves 
	root@seax:~/webdav/shared# ls -l
	total 1
	-rw-r--r-- 1 root root   0 may 26 16:16 itiel_prova.txt
	drwx------ 2 root root   0 may 28 15:37 lost+found
	-rwxr-xr-x 1 root root 774 may 24 20:10 test.py
	-rwxr-xr-x 1 root root   0 may  3 15:18 Uploaded_file
	root@seax:~/webdav/shared# 

Creació de fitxer des de samba i modificació des de sftp:

	root@seax:~# cd samba/
	root@seax:~/samba# cd seax/
	root@seax:~/samba/seax# echo "testing 1" > itiel-test
	root@seax:~/samba/seax# cd ..
	root@seax:~/samba# cd ..
	root@seax:~# cd sftp/
	root@seax:~/sftp# cd seax/
	root@seax:~/sftp/seax# echo "testing 2" >> itiel-test 
	root@seax:~/sftp/seax# cat itiel-test 
	testing 1
	testing 2
	root@seax:~/sftp/seax#

Creació de fitxer des de webdav i modificació des de samba:

	root@seax:~# cd samba/
	root@seax:~/samba# cd entel/
	root@seax:~/samba/entel# echo "testing 1" > itiel-tests
	root@seax:~/samba/entel# cd ..
	root@seax:~/samba# cd ..
	root@seax:~# cd webdav/entel/
	root@seax:~/webdav/entel# echo "testing 2" >> itiel-tests 
	root@seax:~/webdav/entel# cat itiel-tests 
	testing 1
	testing 2
	root@seax:~/webdav/entel#

Creació de fitxer des de sftp i modificació des de webdav:

	root@seax:~# cd sftp/
	root@seax:~/sftp# cd shared/
	root@seax:~/sftp/shared# echo "testing 1" > itiel-test
	root@seax:~/sftp/shared# cd ..
	root@seax:~/sftp# cd ..
	root@seax:~# cd webdav/
	root@seax:~/webdav# cd shared/
	root@seax:~/webdav/shared# echo "test 2" >> itiel-test 
	root@seax:~/webdav/shared# cat itiel-test 
	testing 1	
	test 2
	root@seax:~/webdav/shared#

Comprovació de les proves des de la vista del servidor:

	root@NAS-SEAX:/home# ls -l
	total 6
	drwxrws--- 3 entel    www-data     10 may 31 15:04 entel
	drwxrws--- 4 seax     www-data      9 may 31 15:01 seax
	drwxrwsr-x 3 www-data filetransfer  7 may 31 15:06 shared
	root@NAS-SEAX:/home# ls -l entel/
	total 3
	-rw-r--r-- 1 www-data www-data  0 may 26 16:15 itiel_prova.txt
	-rw-r--r-- 1 www-data www-data 20 may 31 15:04 itiel-tests
	-rw-r--r-- 1 root     root      6 may 25 18:47 judit.txt
	root@NAS-SEAX:/home# ls -l seax/
	total 2
	-rw-rw-r-- 1 seax www-data 20 may 31 15:02 itiel-test
	-rwxrw-r-- 1 seax seax      0 may 25 19:36 Nuevo documento de texto.txt
	root@NAS-SEAX:/home# ls -l shared/
	total 4
	-rw-r--r-- 1 www-data filetransfer   0 may 26 16:16 itiel_prova.txt
	-rw-r--r-- 1 www-data filetransfer  17 may 31 15:06 itiel-test
	-rwxr-xr-x 1 entel    filetransfer 774 may 24 20:10 test.py
	-rwxrw-r-- 1 entel    filetransfer   0 may  3 15:18 Uploaded_file
	root@NAS-SEAX:/home#


# CAPTURA DE PAQUETS DELS SERVEIS AMB FIREWALL I NAT
----------------------------------------------------

Vista de del servidor en la interficie "física" de la màquina virtual:

	root@NAS-SEAX:/etc/openvpn# tcpdump -i enp0s8 udp port 1194
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on enp0s8, link-type EN10MB (Ethernet), capture size 262144 bytes
	00:26:24.268834 IP 192.168.56.116.46909 > 192.168.56.117.openvpn: UDP, length 91
	00:26:24.268879 IP 192.168.56.116.46909 > 192.168.56.117.openvpn: UDP, length 91
	00:26:24.381389 IP 192.168.56.116.46909 > 192.168.56.117.openvpn: UDP, length 108
	00:26:24.381701 IP 192.168.56.117.openvpn > 192.168.56.116.46909: UDP, length 105
	00:26:25.643525 IP 192.168.56.116.46909 > 192.168.56.117.openvpn: UDP, length 108
	00:26:25.643900 IP 192.168.56.117.openvpn > 192.168.56.116.46909: UDP, length 105
	00:26:26.651273 IP 192.168.56.116.46909 > 192.168.56.117.openvpn: UDP, length 108
	00:26:26.651650 IP 192.168.56.117.openvpn > 192.168.56.116.46909: UDP, length 105
	00:26:28.038397 IP 192.168.56.116.46909 > 192.168.56.117.openvpn: UDP, length 108
	00:26:28.039327 IP 192.168.56.117.openvpn > 192.168.56.116.46909: UDP, length 105
	00:26:29.141617 IP 192.168.56.116.46909 > 192.168.56.117.openvpn: UDP, length 108
	00:26:29.141873 IP 192.168.56.117.openvpn > 192.168.56.116.46909: UDP, length 105
	00:26:29.274507 IP 192.168.56.116.46909 > 192.168.56.117.openvpn: UDP, length 91
	00:26:29.274548 IP 192.168.56.116.46909 > 192.168.56.117.openvpn: UDP, length 91
	^C
	14 packets captured
	14 packets received by filter
	0 packets dropped by kernel
	root@NAS-SEAX:/etc/openvpn# 

	NOTA: Apreciar la quantitat de bytes que té el paquet degut a la encriptació.

Comprovació des d'un client mòbil veient youtube amb el firewall activant amb la política per defecte DROP:

	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on tun0, link-type RAW (Raw IP), capture size 262144 bytes
	00:57:29.203780 IP 10.10.10.6.34718 > 173.194.5.135.https: Flags [S], seq 1782954910, win 65535, options [mss 1361,sackOK,TS val 9791004 ecr 0,nop,wscale 8], length 0
	00:57:29.203897 IP 10.10.10.6.58537 > 74.125.97.166.443: UDP, length 176
	00:57:29.203963 IP 10.10.10.6.58537 > 74.125.97.166.443: UDP, length 176
	00:57:29.215587 IP 74.125.97.166.443 > 10.10.10.6.58537: UDP, length 21
	00:57:29.216141 IP 74.125.97.166.443 > 10.10.10.6.58537: UDP, length 40
	00:57:29.216382 IP 173.194.5.135.https > 10.10.10.6.34718: Flags [S.], seq 138985786, ack 1782954911, win 65535, options [mss 1408,sackOK,TS val 519440012 ecr 9791004,nop,wscale 8], length 0
	00:57:29.219123 IP 10.10.10.6.34718 > 173.194.5.135.https: Flags [.], ack 1, win 343, options [nop,nop,TS val 9791007 ecr 519440012], length 0
	00:57:29.250142 IP 10.10.10.6.34718 > 173.194.5.135.https: Flags [P.], seq 518:611, ack 5010, win 385, options [nop,nop,TS val 9791010 ecr 519440034], length 93
	00:57:32.916150 IP 10.10.10.6.34650 > mad07s09-in-f14.1e100.net.443: UDP, length 84
	00:57:32.916666 IP 10.10.10.6.34650 > mad07s09-in-f14.1e100.net.443: UDP, length 156
	00:57:32.930931 IP mad07s09-in-f14.1e100.net.443 > 10.10.10.6.34650: UDP, length 20
	00:57:32.956239 IP mad07s09-in-f14.1e100.net.443 > 10.10.10.6.34650: UDP, length 184
	00:57:32.956253 IP mad07s09-in-f14.1e100.net.443 > 10.10.10.6.34650: UDP, length 38
	00:57:32.956420 IP mad07s09-in-f14.1e100.net.443 > 10.10.10.6.34650: UDP, length 240
	00:57:32.962290 IP 10.10.10.6.34650 > mad07s09-in-f14.1e100.net.443: UDP, length 28
	00:57:32.989696 IP 10.10.10.6.34650 > mad07s09-in-f14.1e100.net.443: UDP, length 28
	00:57:34.188229 IP 10.10.10.6.55726 > 173.194.139.170.https: Flags [P.], seq 2006131767:2006132209, ack 1441237679, win 3468, options [nop,nop,TS val 9791502 ecr 909525021], length 442
	00:57:34.200325 IP 173.194.139.170.https > 10.10.10.6.55726: Flags [.], ack 442, win 412, options [nop,nop,TS val 909539057 ecr 9791502], length 0
	00:57:34.200360 IP 173.194.139.170.https > 10.10.10.6.55726: Flags [P.], seq 1:293, ack 442, win 412, options [nop,nop,TS val 909539057 ecr 9791502], length 292
	00:57:34.203576 IP 10.10.10.6.55726 > 173.194.139.170.https: Flags [.], ack 293, win 3468, options [nop,nop,TS val 9791505 ecr 909539057], length 0
	00:57:37.927314 IP 10.10.10.6.34650 > mad07s09-in-f14.1e100.net.443: UDP, length 84
	00:57:37.928017 IP 10.10.10.6.34650 > mad07s09-in-f14.1e100.net.443: UDP, length 156
	00:57:37.941806 IP mad07s09-in-f14.1e100.net.443 > 10.10.10.6.34650: UDP, length 20
	00:57:37.966233 IP mad07s09-in-f14.1e100.net.443 > 10.10.10.6.34650: UDP, length 131
	00:57:37.966254 IP mad07s09-in-f14.1e100.net.443 > 10.10.10.6.34650: UDP, length 38
	00:57:37.966468 IP mad07s09-in-f14.1e100.net.443 > 10.10.10.6.34650: UDP, length 199
	00:57:37.968573 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [P.], seq 30841136:30842034, ack 3219571085, win 406, options [nop,nop,TS val 9791882 ecr 4060218686], length 898
	00:57:37.969700 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], seq 898:2247, ack 1, win 406, options [nop,nop,TS val 9791882 ecr 4060218686], length 1349
	00:57:37.969841 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [P.], seq 2247:3082, ack 1, win 406, options [nop,nop,TS val 9791882 ecr 4060218686], length 835
	00:57:37.969966 IP 10.10.10.6.34650 > mad07s09-in-f14.1e100.net.443: UDP, length 28
	00:57:37.983285 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], ack 2247, win 284, options [nop,nop,TS val 4060241433 ecr 9791882], length 0
	00:57:37.983845 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [P.], seq 1:553, ack 3082, win 294, options [nop,nop,TS val 4060241434 ecr 9791882], length 552
	00:57:37.984164 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [P.], seq 553:947, ack 3082, win 294, options [nop,nop,TS val 4060241434 ecr 9791882], length 394
	00:57:38.004372 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], ack 5442, win 469, options [nop,nop,TS val 9791884 ecr 4060241436], length 0
	00:57:38.004785 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], ack 6791, win 480, options [nop,nop,TS val 9791884 ecr 4060241436], length 0
	00:57:38.005072 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], ack 8140, win 490, options [nop,nop,TS val 9791884 ecr 4060241436], length 0
	00:57:38.005697 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], ack 9489, win 501, options [nop,nop,TS val 9791884 ecr 4060241436], length 0
	00:57:38.005965 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], ack 10838, win 511, options [nop,nop,TS val 9791884 ecr 4060241437], length 0
	00:57:38.006306 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], ack 12187, win 522, options [nop,nop,TS val 9791885 ecr 4060241437], length 0
	00:57:38.006673 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], ack 13536, win 532, options [nop,nop,TS val 9791885 ecr 4060241438], length 0
	00:57:38.007156 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], ack 14885, win 543, options [nop,nop,TS val 9791885 ecr 4060241438], length 0
	.
	.
	.
	00:57:38.117919 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 51913:53262, ack 3082, win 294, options [nop,nop,TS val 4060241568 ecr 9791886], length 1349
	00:57:38.117940 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 53262:54611, ack 3082, win 294, options [nop,nop,TS val 4060241568 ecr 9791886], length 1349
	00:57:38.117942 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 54611:55960, ack 3082, win 294, options [nop,nop,TS val 4060241568 ecr 9791886], length 1349
	00:57:38.118136 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 55960:57309, ack 3082, win 294, options [nop,nop,TS val 4060241568 ecr 9791886], length 1349
	00:57:38.118140 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 57309:58658, ack 3082, win 294, options [nop,nop,TS val 4060241568 ecr 9791886], length 1349
	00:57:38.118142 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 58658:60007, ack 3082, win 294, options [nop,nop,TS val 4060241568 ecr 9791886], length 1349
	00:57:38.118889 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [P.], seq 60007:61133, ack 3082, win 294, options [nop,nop,TS val 4060241569 ecr 9791886], length 1126
	00:57:38.123925 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], ack 53262, win 849, options [nop,nop,TS val 9791897 ecr 4060241568], length 0
	00:57:38.125353 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], ack 54611, win 859, options [nop,nop,TS val 9791897 ecr 4060241568], length 0
	00:57:38.126078 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], ack 55960, win 870, options [nop,nop,TS val 9791897 ecr 4060241568], length 0
	00:57:38.126465 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], ack 57309, win 880, options [nop,nop,TS val 9791897 ecr 4060241568], length 0
	00:57:38.126931 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], ack 58658, win 891, options [nop,nop,TS val 9791898 ecr 4060241568], length 0
	00:57:38.127385 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], ack 60007, win 901, options [nop,nop,TS val 9791898 ecr 4060241568], length 0
	00:57:38.127833 IP 10.10.10.6.55002 > 173.194.5.139.https: Flags [.], ack 61133, win 912, options [nop,nop,TS val 9791898 ecr 4060241569], length 0
	00:57:38.170390 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 61133:62482, ack 3082, win 294, options [nop,nop,TS val 4060241620 ecr 9791898], length 1349
	00:57:38.170412 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 62482:63831, ack 3082, win 294, options [nop,nop,TS val 4060241620 ecr 9791898], length 1349
	00:57:38.170414 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 63831:65180, ack 3082, win 294, options [nop,nop,TS val 4060241620 ecr 9791898], length 1349
	00:57:38.170546 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 65180:66529, ack 3082, win 294, options [nop,nop,TS val 4060241621 ecr 9791898], length 1349
	00:57:38.170549 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 66529:67878, ack 3082, win 294, options [nop,nop,TS val 4060241621 ecr 9791898], length 1349
	00:57:38.170551 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 67878:69227, ack 3082, win 294, options [nop,nop,TS val 4060241621 ecr 9791898], length 1349
	00:57:38.171382 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 69227:70576, ack 3082, win 294, options [nop,nop,TS val 4060241622 ecr 9791898], length 1349
	00:57:38.171392 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 70576:71925, ack 3082, win 294, options [nop,nop,TS val 4060241622 ecr 9791898], length 1349
	00:57:38.171394 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 71925:73274, ack 3082, win 294, options [nop,nop,TS val 4060241622 ecr 9791898], length 1349
	00:57:38.172324 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 73274:74623, ack 3082, win 294, options [nop,nop,TS val 4060241622 ecr 9791898], length 1349
	00:57:38.172333 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 74623:75972, ack 3082, win 294, options [nop,nop,TS val 4060241622 ecr 9791898], length 1349
	00:57:38.172335 IP 173.194.5.139.https > 10.10.10.6.55002: Flags [.], seq 75972:77321, ack 3082, win 294, options [nop,nop,TS val 4060241622 ecr 9791898], length 1349
	00:57:38.172680 IP 10.10.10.6.37462 > 173.194.5.139.443: UDP, length 1350
	.
	.
	.
	^C
	729 packets captured
	891 packets received by filter
	162 packets dropped by kernel
	root@NAS-SEAX:~#

Comprovació de samba muntat automàticament per l'fstab amb cifs en el client Debian 9:

	root@NAS-SEAX:~# tcpdump -i any port 445
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
	02:46:05.915550 IP 192.168.56.116.40686 > 192.168.56.117.microsoft-ds: Flags [P.], seq 3092094284:3092094362, ack 2853085577, win 438, options [nop,nop,TS val 4294963953 ecr 680317], length 78 SMB PACKET: SMBtrans2 (REQUEST)

	02:46:05.916159 IP 192.168.56.117.microsoft-ds > 192.168.56.116.40686: Flags [P.], seq 1:165, ack 78, win 277, options [nop,nop,TS val 685167 ecr 4294963953], length 164 SMB PACKET: SMBtrans2 (REPLY)

	02:46:05.916707 IP 192.168.56.116.40686 > 192.168.56.117.microsoft-ds: Flags [.], ack 165, win 446, options [nop,nop,TS val 4294963954 ecr 685167], length 0
	02:46:07.906023 IP 192.168.56.116.40686 > 192.168.56.117.microsoft-ds: Flags [P.], seq 78:156, ack 165, win 446, options [nop,nop,TS val 4294964451 ecr 685167], length 78 SMB PACKET: SMBtrans2 (REQUEST)

	02:46:07.906242 IP 192.168.56.117.microsoft-ds > 192.168.56.116.40686: Flags [P.], seq 165:329, ack 156, win 277, options [nop,nop,TS val 685664 ecr 4294964451], length 164 SMB PACKET: SMBtrans2 (REPLY)

	02:46:07.906547 IP 192.168.56.116.40686 > 192.168.56.117.microsoft-ds: Flags [.], ack 329, win 455, options [nop,nop,TS val 4294964451 ecr 685664], length 0
	02:46:07.906754 IP 192.168.56.116.40686 > 192.168.56.117.microsoft-ds: Flags [P.], seq 156:244, ack 329, win 455, options [nop,nop,TS val 4294964451 ecr 685664], length 88 SMB PACKET: SMBtrans2 (REQUEST)

	02:46:07.907493 IP 192.168.56.117.microsoft-ds > 192.168.56.116.40686: Flags [P.], seq 329:1541, ack 244, win 277, options [nop,nop,TS val 685665 ecr 4294964451], length 1212 SMB PACKET: SMBtrans2 (REPLY)

	02:46:07.907917 IP 192.168.56.116.40686 > 192.168.56.117.microsoft-ds: Flags [P.], seq 244:354, ack 1541, win 477, options [nop,nop,TS val 4294964451 ecr 685665], length 110 SMB PACKET: SMBtrans2 (REQUEST)

	02:46:07.908145 IP 192.168.56.117.microsoft-ds > 192.168.56.116.40686: Flags [P.], seq 1541:1580, ack 354, win 277, options [nop,nop,TS val 685665 ecr 4294964451], length 39 SMB PACKET: SMBtrans2 (REPLY)

	02:46:07.952418 IP 192.168.56.116.40686 > 192.168.56.117.microsoft-ds: Flags [.], ack 1580, win 477, options [nop,nop,TS val 4294964463 ecr 685665], length 0
	^C
	11 packets captured
	11 packets received by filter
	0 packets dropped by kernel
	root@NAS-SEAX:~#

Comprovació de SFTP des del client amb les entrades en l'fstab automuntat:

	root@NAS-SEAX:~# tcpdump -i any port 22 and host 192.168.56.116
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
	02:47:35.820754 IP 192.168.56.116.37986 > 192.168.56.117.ssh: Flags [P.], seq 1974679769:1974679821, ack 3265008418, win 347, options [nop,nop,TS val 19133 ecr 649614], length 52
	02:47:35.821308 IP 192.168.56.117.ssh > 192.168.56.116.37986: Flags [P.], seq 1:77, ack 52, win 294, options [nop,nop,TS val 707643 ecr 19133], length 76
	02:47:35.821740 IP 192.168.56.116.37986 > 192.168.56.117.ssh: Flags [.], ack 77, win 347, options [nop,nop,TS val 19134 ecr 707643], length 0
	02:47:37.414239 IP 192.168.56.116.37986 > 192.168.56.117.ssh: Flags [P.], seq 52:104, ack 77, win 347, options [nop,nop,TS val 19532 ecr 707643], length 52
	02:47:37.414891 IP 192.168.56.117.ssh > 192.168.56.116.37986: Flags [P.], seq 77:129, ack 104, win 294, options [nop,nop,TS val 708041 ecr 19532], length 52
	02:47:37.415563 IP 192.168.56.116.37986 > 192.168.56.117.ssh: Flags [.], ack 129, win 347, options [nop,nop,TS val 19532 ecr 708041], length 0
	02:47:37.415938 IP 192.168.56.116.37986 > 192.168.56.117.ssh: Flags [P.], seq 104:172, ack 129, win 347, options [nop,nop,TS val 19532 ecr 708041], length 68
	02:47:37.419098 IP 192.168.56.117.ssh > 192.168.56.116.37986: Flags [P.], seq 129:2949, ack 172, win 294, options [nop,nop,TS val 708043 ecr 19532], length 2820
	02:47:37.419322 IP 192.168.56.116.37986 > 192.168.56.117.ssh: Flags [.], ack 2949, win 391, options [nop,nop,TS val 19533 ecr 708043], length 0
	02:47:37.419798 IP 192.168.56.116.37986 > 192.168.56.117.ssh: Flags [P.], seq 172:264, ack 2949, win 391, options [nop,nop,TS val 19533 ecr 708043], length 92
	02:47:37.420086 IP 192.168.56.117.ssh > 192.168.56.116.37986: Flags [P.], seq 2949:3081, ack 264, win 294, options [nop,nop,TS val 708043 ecr 19533], length 132
	02:47:37.420974 IP 192.168.56.116.37986 > 192.168.56.117.ssh: Flags [P.], seq 264:324, ack 3081, win 413, options [nop,nop,TS val 19534 ecr 708043], length 60
	02:47:37.421183 IP 192.168.56.117.ssh > 192.168.56.116.37986: Flags [P.], seq 3081:3197, ack 324, win 294, options [nop,nop,TS val 708043 ecr 19534], length 116
	02:47:37.421751 IP 192.168.56.116.37986 > 192.168.56.117.ssh: Flags [P.], seq 324:392, ack 3197, win 413, options [nop,nop,TS val 19534 ecr 708043], length 68
	02:47:37.421939 IP 192.168.56.117.ssh > 192.168.56.116.37986: Flags [P.], seq 3197:3321, ack 392, win 294, options [nop,nop,TS val 708043 ecr 19534], length 124
	02:47:37.422522 IP 192.168.56.116.37986 > 192.168.56.117.ssh: Flags [P.], seq 392:452, ack 3321, win 413, options [nop,nop,TS val 19534 ecr 708043], length 60
	02:47:37.422723 IP 192.168.56.117.ssh > 192.168.56.116.37986: Flags [P.], seq 3321:3445, ack 452, win 294, options [nop,nop,TS val 708043 ecr 19534], length 124
	02:47:37.423385 IP 192.168.56.116.37986 > 192.168.56.117.ssh: Flags [P.], seq 452:512, ack 3445, win 413, options [nop,nop,TS val 19534 ecr 708043], length 60
	02:47:37.423574 IP 192.168.56.117.ssh > 192.168.56.116.37986: Flags [P.], seq 3445:3561, ack 512, win 294, options [nop,nop,TS val 708044 ecr 19534], length 116
	02:47:37.469133 IP 192.168.56.116.37986 > 192.168.56.117.ssh: Flags [.], ack 3561, win 413, options [nop,nop,TS val 19546 ecr 708044], length 0
	02:47:46.540963 IP 192.168.56.116.37984 > 192.168.56.117.ssh: Flags [P.], seq 3111857997:3111858049, ack 919316449, win 347, options [nop,nop,TS val 21814 ecr 649614], length 52
	02:47:46.541374 IP 192.168.56.117.ssh > 192.168.56.116.37984: Flags [P.], seq 1:77, ack 52, win 294, options [nop,nop,TS val 710323 ecr 21814], length 76
	02:47:46.541577 IP 192.168.56.116.37984 > 192.168.56.117.ssh: Flags [.], ack 77, win 347, options [nop,nop,TS val 21814 ecr 710323], length 0
	02:47:47.848134 IP 192.168.56.116.37984 > 192.168.56.117.ssh: Flags [P.], seq 52:104, ack 77, win 347, options [nop,nop,TS val 22140 ecr 710323], length 52
	02:47:47.848813 IP 192.168.56.117.ssh > 192.168.56.116.37984: Flags [P.], seq 77:129, ack 104, win 294, options [nop,nop,TS val 710650 ecr 22140], length 52
	02:47:47.849261 IP 192.168.56.116.37984 > 192.168.56.117.ssh: Flags [.], ack 129, win 347, options [nop,nop,TS val 22141 ecr 710650], length 0
	02:47:47.849456 IP 192.168.56.116.37984 > 192.168.56.117.ssh: Flags [P.], seq 104:172, ack 129, win 347, options [nop,nop,TS val 22141 ecr 710650], length 68
	02:47:47.850389 IP 192.168.56.117.ssh > 192.168.56.116.37984: Flags [P.], seq 129:2949, ack 172, win 294, options [nop,nop,TS val 710650 ecr 22141], length 2820
	02:47:47.850725 IP 192.168.56.116.37984 > 192.168.56.117.ssh: Flags [.], ack 2949, win 391, options [nop,nop,TS val 22141 ecr 710650], length 0
	02:47:47.851220 IP 192.168.56.116.37984 > 192.168.56.117.ssh: Flags [P.], seq 172:264, ack 2949, win 391, options [nop,nop,TS val 22141 ecr 710650], length 92
	02:47:47.851498 IP 192.168.56.117.ssh > 192.168.56.116.37984: Flags [P.], seq 2949:3081, ack 264, win 294, options [nop,nop,TS val 710651 ecr 22141], length 132
	02:47:47.853264 IP 192.168.56.116.37984 > 192.168.56.117.ssh: Flags [P.], seq 264:324, ack 3081, win 413, options [nop,nop,TS val 22142 ecr 710651], length 60
	02:47:47.853589 IP 192.168.56.117.ssh > 192.168.56.116.37984: Flags [P.], seq 3081:3197, ack 324, win 294, options [nop,nop,TS val 710651 ecr 22142], length 116
	02:47:47.854240 IP 192.168.56.116.37984 > 192.168.56.117.ssh: Flags [P.], seq 324:392, ack 3197, win 413, options [nop,nop,TS val 22142 ecr 710651], length 68
	02:47:47.854531 IP 192.168.56.117.ssh > 192.168.56.116.37984: Flags [P.], seq 3197:3321, ack 392, win 294, options [nop,nop,TS val 710651 ecr 22142], length 124
	02:47:47.855102 IP 192.168.56.116.37984 > 192.168.56.117.ssh: Flags [P.], seq 392:452, ack 3321, win 413, options [nop,nop,TS val 22142 ecr 710651], length 60
	02:47:47.855407 IP 192.168.56.117.ssh > 192.168.56.116.37984: Flags [P.], seq 3321:3445, ack 452, win 294, options [nop,nop,TS val 710652 ecr 22142], length 124
	02:47:47.856219 IP 192.168.56.116.37984 > 192.168.56.117.ssh: Flags [P.], seq 452:512, ack 3445, win 413, options [nop,nop,TS val 22142 ecr 710652], length 60
	02:47:47.856495 IP 192.168.56.117.ssh > 192.168.56.116.37984: Flags [P.], seq 3445:3561, ack 512, win 294, options [nop,nop,TS val 710652 ecr 22142], length 116
	02:47:47.900945 IP 192.168.56.116.37984 > 192.168.56.117.ssh: Flags [.], ack 3561, win 413, options [nop,nop,TS val 22154 ecr 710652], length 0
	^C
	40 packets captured
	40 packets received by filter
	0 packets dropped by kernel
	root@NAS-SEAX:~#

Comprovació des del mòbil fent servir la xarxa 3G/4G:

	root@NAS-SEAX:~# tcpdump -i tun0
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on tun0, link-type RAW (Raw IP), capture size 262144 bytes
	00:45:17.812441 IP6 fe80::84c3:3e8a:3df1:d6f4 > ip6-allrouters: ICMP6, router solicitation, length 8
	00:45:44.988402 IP 10.10.10.6.65473 > resolver1.opendns.com.domain: 43012+ A? mqtt-mini.facebook.com. (40)
	00:45:44.988565 IP 10.10.10.6.37828 > edge-mqtt-mini-shv-01-mad1.facebook.com.https: Flags [S], seq 2661506514, win 64240, options [mss 1361,sackOK,TS val 3886261 ecr 0,nop,wscale 8], length 0
	00:45:45.002375 IP edge-mqtt-mini-shv-01-mad1.facebook.com.https > 10.10.10.6.37828: Flags [S.], seq 1463435027, ack 2661506515, win 27960, options [mss 1410,sackOK,TS val 38746158 ecr 3886261,nop,wscale 8], length 0
	00:45:45.028684 IP resolver1.opendns.com.domain > 10.10.10.6.65473: 43012 2/0/0 CNAME mqtt-mini.c10r.facebook.com., A 31.13.83.34 (85)
	00:45:45.078761 IP 10.10.10.6.42565 > resolver1.opendns.com.domain: 40183+ A? fr-app-chat-global-xiaomi-net-1516654448.eu-central-1.elb.amazonaws.com. (89)
	00:45:45.079137 IP 10.10.10.6.37828 > edge-mqtt-mini-shv-01-mad1.facebook.com.https: Flags [.], ack 1, win 251, options [nop,nop,TS val 3886268 ecr 38746158], length 0
	00:45:45.079344 IP 10.10.10.6.37828 > edge-mqtt-mini-shv-01-mad1.facebook.com.https: Flags [P.], seq 1:198, ack 1, win 251, options [nop,nop,TS val 3886269 ecr 38746158], length 197
	00:45:45.092449 IP edge-mqtt-mini-shv-01-mad1.facebook.com.https > 10.10.10.6.37828: Flags [.], ack 198, win 114, options [nop,nop,TS val 38746248 ecr 3886269], length 0
	00:45:45.093019 IP edge-mqtt-mini-shv-01-mad1.facebook.com.https > 10.10.10.6.37828: Flags [P.], seq 1:142, ack 198, win 114, options [nop,nop,TS val 38746249 ecr 3886269], length 141
	00:45:45.117658 IP resolver1.opendns.com.domain > 10.10.10.6.42565: 40183 8/0/0 A 18.194.103.52, A 18.194.237.42, A 18.194.252.226, A 52.58.29.255, A 52.58.71.49, A 54.93.158.139, A 18.184.229.175, A 18.185.5.65 (217)
	00:45:45.147298 IP 10.10.10.6.37828 > edge-mqtt-mini-shv-01-mad1.facebook.com.https: Flags [.], ack 142, win 256, options [nop,nop,TS val 3886278 ecr 38746249], length 0
	00:45:45.157394 IP 10.10.10.6.37828 > edge-mqtt-mini-shv-01-mad1.facebook.com.https: Flags [P.], seq 198:249, ack 142, win 256, options [nop,nop,TS val 3886278 ecr 38746249], length 51
	00:45:45.187434 IP 10.10.10.6.37828 > edge-mqtt-mini-shv-01-mad1.facebook.com.https: Flags [P.], seq 249:624, ack 142, win 256, options [nop,nop,TS val 3886278 ecr 38746249], length 375
	00:45:45.187631 IP 10.10.10.6.39966 > ec2-18-194-103-52.eu-central-1.compute.amazonaws.com.xmpp-client: Flags [S], seq 3957765132, win 64240, options [mss 1361,sackOK,TS val 3886280 ecr 0,nop,wscale 8], length 0
	00:45:45.200693 IP edge-mqtt-mini-shv-01-mad1.facebook.com.https > 10.10.10.6.37828: Flags [.], ack 624, win 118, options [nop,nop,TS val 38746357 ecr 3886278], length 0
	00:45:45.225609 IP ec2-18-194-103-52.eu-central-1.compute.amazonaws.com.xmpp-client > 10.10.10.6.39966: Flags [S.], seq 1937355051, ack 3957765133, win 26847, options [mss 1452,sackOK,TS val 4831090 ecr 3886280,nop,wscale 8], length 0
	00:45:45.335549 IP edge-mqtt-mini-shv-01-mad1.facebook.com.https > 10.10.10.6.37828: Flags [P.], seq 142:278, ack 624, win 118, options [nop,nop,TS val 38746491 ecr 3886278], length 136
	00:45:45.337104 IP 10.10.10.6.39966 > ec2-18-194-103-52.eu-central-1.compute.amazonaws.com.xmpp-client: Flags [.], ack 1, win 251, options [nop,nop,TS val 3886291 ecr 4831090], length 0
	00:45:45.337259 IP 10.10.10.6.39966 > ec2-18-194-103-52.eu-central-1.compute.amazonaws.com.xmpp-client: Flags [P.], seq 1:239, ack 1, win 251, options [nop,nop,TS val 3886291 ecr 4831090], length 238
	00:45:45.375090 IP ec2-18-194-103-52.eu-central-1.compute.amazonaws.com.xmpp-client > 10.10.10.6.39966: Flags [.], ack 239, win 110, options [nop,nop,TS val 4831127 ecr 3886291], length 0
	00:45:45.375452 IP ec2-18-194-103-52.eu-central-1.compute.amazonaws.com.xmpp-client > 10.10.10.6.39966: Flags [P.], seq 1:67, ack 239, win 110, options [nop,nop,TS val 4831127 ecr 3886291], length 66
	00:45:45.427142 IP 10.10.10.6.37828 > edge-mqtt-mini-shv-01-mad1.facebook.com.https: Flags [.], ack 278, win 260, options [nop,nop,TS val 3886306 ecr 38746491], length 0
	00:45:45.427368 IP 10.10.10.6.39966 > ec2-18-194-103-52.eu-central-1.compute.amazonaws.com.xmpp-client: Flags [.], ack 67, win 251, options [nop,nop,TS val 3886306 ecr 4831127], length 0
	00:45:45.447422 IP 10.10.10.6.39966 > ec2-18-194-103-52.eu-central-1.compute.amazonaws.com.xmpp-client: Flags [P.], seq 239:646, ack 67, win 251, options [nop,nop,TS val 3886307 ecr 4831127], length 407
	00:45:45.467381 IP 10.10.10.6.39966 > ec2-18-194-103-52.eu-central-1.compute.amazonaws.com.xmpp-client: Flags [P.], seq 646:1347, ack 67, win 251, options [nop,nop,TS val 3886307 ecr 4831127], length 701
	00:45:45.506089 IP ec2-18-194-103-52.eu-central-1.compute.amazonaws.com.xmpp-client > 10.10.10.6.39966: Flags [.], ack 1347, win 119, options [nop,nop,TS val 4831160 ecr 3886307], length 0
	00:45:45.511502 IP ec2-18-194-103-52.eu-central-1.compute.amazonaws.com.xmpp-client > 10.10.10.6.39966: Flags [P.], seq 67:173, ack 1347, win 119, options [nop,nop,TS val 4831161 ecr 3886307], length 106
	00:45:45.597881 IP 10.10.10.6.39966 > ec2-18-194-103-52.eu-central-1.compute.amazonaws.com.xmpp-client: Flags [.], ack 173, win 251, options [nop,nop,TS val 3886323 ecr 4831161], length 0
	00:45:45.694825 IP ec2-18-194-103-52.eu-central-1.compute.amazonaws.com.xmpp-client > 10.10.10.6.39966: Flags [P.], seq 173:258, ack 1347, win 119, options [nop,nop,TS val 4831207 ecr 3886323], length 85
	00:45:45.748471 IP 10.10.10.6.39966 > ec2-18-194-103-52.eu-central-1.compute.amazonaws.com.xmpp-client: Flags [.], ack 258, win 251, options [nop,nop,TS val 3886338 ecr 4831207], length 0
	00:45:51.668872 IP 10.10.10.6.64521 > resolver1.opendns.com.domain: 49050+ A? mtalk.google.com. (34)
	00:45:51.702687 IP resolver1.opendns.com.domain > 10.10.10.6.64521: 49050 2/0/0 CNAME mobile-gtalk.l.google.com., A 74.125.133.188 (79)
	00:45:52.237496 IP 10.10.10.6.47858 > wo-in-f188.1e100.net.5228: Flags [S], seq 469481861, win 64240, options [mss 1361,sackOK,TS val 3886972 ecr 0,nop,wscale 8], length 0
	00:45:52.270696 IP wo-in-f188.1e100.net.5228 > 10.10.10.6.47858: Flags [S.], seq 2323034081, ack 469481862, win 60192, options [mss 1380,sackOK,TS val 3787582557 ecr 3886972,nop,wscale 8], length 0
	00:45:52.570869 IP wo-in-f188.1e100.net.5228 > 10.10.10.6.47858: Flags [S.], seq 2323034081, ack 469481862, win 60192, options [mss 1380,sackOK,TS val 3787582857 ecr 3886972,nop,wscale 8], length 0
	00:45:52.597084 IP 10.10.10.6.47858 > wo-in-f188.1e100.net.5228: Flags [.], ack 1, win 251, options [nop,nop,TS val 3887002 ecr 3787582557], length 0
	00:45:52.803498 IP 10.10.10.6.47858 > wo-in-f188.1e100.net.5228: Flags [P.], seq 1:518, ack 1, win 251, options [nop,nop,TS val 3887002 ecr 3787582557], length 517
	00:45:52.835938 IP wo-in-f188.1e100.net.5228 > 10.10.10.6.47858: Flags [.], ack 518, win 240, options [nop,nop,TS val 3787583122 ecr 3887002], length 0
	00:45:52.836241 IP wo-in-f188.1e100.net.5228 > 10.10.10.6.47858: Flags [.], seq 1:1350, ack 518, win 240, options [nop,nop,TS val 3787583122 ecr 3887002], length 1349
	00:45:52.849131 IP wo-in-f188.1e100.net.5228 > 10.10.10.6.47858: Flags [.], seq 1350:2699, ack 518, win 240, options [nop,nop,TS val 3787583122 ecr 3887002], length 1349
	00:45:52.861736 IP wo-in-f188.1e100.net.5228 > 10.10.10.6.47858: Flags [P.], seq 2699:3420, ack 518, win 240, options [nop,nop,TS val 3787583122 ecr 3887002], length 721
	00:45:52.903427 IP 10.10.10.6.47858 > wo-in-f188.1e100.net.5228: Flags [.], ack 1, win 251, options [nop,nop,TS val 3887053 ecr 3787582557], length 0
	00:45:52.913065 IP 10.10.10.6.47858 > wo-in-f188.1e100.net.5228: Flags [.], ack 1350, win 262, options [nop,nop,TS val 3887054 ecr 3787583122], length 0
	00:45:52.923216 IP 10.10.10.6.47858 > wo-in-f188.1e100.net.5228: Flags [.], ack 2699, win 273, options [nop,nop,TS val 3887056 ecr 3787583122], length 0
	00:45:52.923396 IP 10.10.10.6.47858 > wo-in-f188.1e100.net.5228: Flags [.], ack 3420, win 283, options [nop,nop,TS val 3887056 ecr 3787583122], length 0
	00:45:52.953299 IP 10.10.10.6.47858 > wo-in-f188.1e100.net.5228: Flags [P.], seq 518:611, ack 3420, win 283, options [nop,nop,TS val 3887058 ecr 3787583122], length 93
	00:45:52.986997 IP wo-in-f188.1e100.net.5228 > 10.10.10.6.47858: Flags [P.], seq 3420:3704, ack 611, win 240, options [nop,nop,TS val 3787583273 ecr 3887058], length 284
	00:45:53.063473 IP 10.10.10.6.47858 > wo-in-f188.1e100.net.5228: Flags [P.], seq 611:997, ack 3704, win 294, options [nop,nop,TS val 3887068 ecr 3787583273], length 386
	00:45:53.105745 IP wo-in-f188.1e100.net.5228 > 10.10.10.6.47858: Flags [P.], seq 3704:3734, ack 997, win 244, options [nop,nop,TS val 3787583392 ecr 3887068], length 30
	00:45:53.109582 IP wo-in-f188.1e100.net.5228 > 10.10.10.6.47858: Flags [P.], seq 3734:3848, ack 997, win 244, options [nop,nop,TS val 3787583396 ecr 3887068], length 114
	00:45:53.111066 IP wo-in-f188.1e100.net.5228 > 10.10.10.6.47858: Flags [P.], seq 3848:3973, ack 997, win 244, options [nop,nop,TS val 3787583396 ecr 3887068], length 125
	00:45:53.203358 IP 10.10.10.6.47858 > wo-in-f188.1e100.net.5228: Flags [.], ack 3973, win 294, options [nop,nop,TS val 3887080 ecr 3787583392], length 0
	^C
	53 packets captured
	53 packets received by filter
	0 packets dropped by kernel
	root@NAS-SEAX:~#

	root@NAS-SEAX:~# tcpdump -i enp0s3 port 443
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes
	00:56:05.334622 IP ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https > 192.168.1.34.34028: Flags [.], ack 3791407339, win 106, options [nop,nop,TS val 740109576 ecr 3912928], length 0
	00:56:05.336327 IP ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https > 192.168.1.34.34028: Flags [P.], seq 0:3134, ack 1, win 106, options [nop,nop,TS val 740109576 ecr 3912928], length 3134
	00:56:06.077831 IP 192.168.1.34.34028 > ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https: Flags [.], ack 0, win 23, options [nop,nop,TS val 3913029 ecr 740109576,nop,nop,sack 1 {2576:3134}], length 0
	00:56:06.443004 IP ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https > 192.168.1.34.34028: Flags [.], seq 0:2576, ack 1, win 106, options [nop,nop,TS val 740109853 ecr 3913029], length 2576
	00:56:06.698971 IP 192.168.1.34.34028 > ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https: Flags [.], ack 1288, win 23, options [nop,nop,TS val 3913055 ecr 740109576,nop,nop,sack 1 {2576:3134}], length 0
	00:56:07.062915 IP 192.168.1.34.34028 > ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https: Flags [.], ack 3134, win 23, options [nop,nop,TS val 3913125 ecr 740109576], length 0
	00:56:07.258654 IP 192.168.1.34.34028 > ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https: Flags [P.], seq 1:127, ack 3134, win 23, options [nop,nop,TS val 3913129 ecr 740109576], length 126
	00:56:07.456385 IP ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https > 192.168.1.34.34028: Flags [P.], seq 3134:3185, ack 127, win 106, options [nop,nop,TS val 740110106 ecr 3913129], length 51
	00:56:08.299260 IP 192.168.1.34.33534 > 74.red-88-24-255.staticip.rima-tde.net.https: Flags [S], seq 4177703079, win 5840, options [mss 1361,sackOK,TS val 3913176 ecr 0,nop,wscale 8], length 0
	00:56:08.299508 IP 192.168.1.34.34028 > ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https: Flags [.], ack 3134, win 23, options [nop,nop,TS val 3913177 ecr 740109576,nop,nop,sack 1 {0:1288}], length 0
	00:56:08.299665 IP 192.168.1.34.34028 > ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https: Flags [.], ack 3134, win 23, options [nop,nop,TS val 3913193 ecr 740109576,nop,nop,sack 1 {1288:2576}], length 0
	00:56:08.299814 IP 192.168.1.34.34028 > ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https: Flags [.], ack 3185, win 23, options [nop,nop,TS val 3913195 ecr 740110106], length 0
	00:56:08.300346 IP 74.red-88-24-255.staticip.rima-tde.net.https > 192.168.1.34.33534: Flags [S.], seq 2462255690, ack 4177703080, win 28960, options [mss 1460,sackOK,TS val 3267884564 ecr 3913176,nop,wscale 7], length 0
	00:56:08.419178 IP 192.168.1.34.34028 > ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https: Flags [P.], seq 127:549, ack 3185, win 23, options [nop,nop,TS val 3913196 ecr 740110106], length 422
	00:56:08.419388 IP 192.168.1.34.33536 > 74.red-88-24-255.staticip.rima-tde.net.https: Flags [S], seq 1342554950, win 5840, options [mss 1361,sackOK,TS val 3913201 ecr 0,nop,wscale 8], length 0
	00:56:08.420406 IP 74.red-88-24-255.staticip.rima-tde.net.https > 192.168.1.34.33536: Flags [S.], seq 2629214652, ack 1342554951, win 28960, options [mss 1460,sackOK,TS val 3267884684 ecr 3913201,nop,wscale 7], length 0
	00:56:08.503151 IP 192.168.1.34.33534 > 74.red-88-24-255.staticip.rima-tde.net.https: Flags [.], ack 1, win 23, options [nop,nop,TS val 3913271 ecr 3267884564], length 0
	00:56:08.630731 IP ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https > 192.168.1.34.34028: Flags [P.], seq 3185:7049, ack 549, win 110, options [nop,nop,TS val 740110399 ecr 3913196], length 3864
	00:56:08.630857 IP ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https > 192.168.1.34.34028: Flags [.], seq 7049:8337, ack 549, win 110, options [nop,nop,TS val 740110399 ecr 3913196], length 1288
	00:56:08.739283 IP 192.168.1.34.33534 > 74.red-88-24-255.staticip.rima-tde.net.https: Flags [P.], seq 1:578, ack 1, win 23, options [nop,nop,TS val 3913275 ecr 3267884564], length 577
	00:56:08.740386 IP 74.red-88-24-255.staticip.rima-tde.net.https > 192.168.1.34.33534: Flags [.], ack 578, win 236, options [nop,nop,TS val 3267885004 ecr 3913275], length 0
	00:56:08.743346 IP 74.red-88-24-255.staticip.rima-tde.net.https > 192.168.1.34.33534: Flags [P.], seq 1:153, ack 578, win 236, options [nop,nop,TS val 3267885007 ecr 3913275], length 152
	00:56:08.778818 IP 192.168.1.34.33536 > 74.red-88-24-255.staticip.rima-tde.net.https: Flags [.], ack 1, win 23, options [nop,nop,TS val 3913283 ecr 3267884684], length 0
	00:56:09.042863 IP 192.168.1.34.33536 > 74.red-88-24-255.staticip.rima-tde.net.https: Flags [P.], seq 1:578, ack 1, win 23, options [nop,nop,TS val 3913286 ecr 3267884684], length 577
	00:56:09.044021 IP 74.red-88-24-255.staticip.rima-tde.net.https > 192.168.1.34.33536: Flags [.], ack 578, win 236, options [nop,nop,TS val 3267885308 ecr 3913286], length 0
	00:56:09.046856 IP 74.red-88-24-255.staticip.rima-tde.net.https > 192.168.1.34.33536: Flags [P.], seq 1:153, ack 578, win 236, options [nop,nop,TS val 3267885310 ecr 3913286], length 152
	00:56:09.266075 IP 192.168.1.34.34028 > ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https: Flags [P.], seq 127:549, ack 3185, win 23, options [nop,nop,TS val 3913316 ecr 740110106], length 422
	00:56:09.322803 IP 192.168.1.34.34028 > ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https: Flags [.], ack 4473, win 23, options [nop,nop,TS val 3913333 ecr 740110399], length 0
	00:56:09.378771 IP 192.168.1.34.34028 > ec2-52-34-47-68.us-west-2.compute.amazonaws.com.https: Flags [.], ack 5761, win 23, options [nop,nop,TS val 3913359 ecr 740110399], length 0
	^C
	29 packets captured
	29 packets received by filter
	0 packets dropped by kernel
	root@NAS-SEAX:~#

Captura samba des d'un client amb windows 10:

	root@NAS-SEAX:/home/shared# tcpdump -s 0 -i any port 445
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
	16:38:56.463830 IP 192.168.1.37.49881 > 192.168.1.34.microsoft-ds: Flags [.], seq 1074482636:1074482637, ack 1118582881, win 1020, length 1[|SMB]
	16:38:56.463938 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49881: Flags [.], ack 1, win 374, options [nop,nop,sack 1 {0:1}], length 0
	16:39:08.132143 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49751: Flags [P.], seq 547350023:547350100, ack 1021129872, win 821, length 77 SMB-over-TCP packet:(raw data or continuation?)

	16:39:26.625529 IP 192.168.56.116.35732 > 192.168.56.117.microsoft-ds: Flags [P.], seq 3766935861:3766935903, ack 1320071746, win 499, options [nop,nop,TS val 2137088 ecr 1494543], length 42 SMB PACKET: SMBecho (REQUEST)

	16:39:26.626659 IP 192.168.56.117.microsoft-ds > 192.168.56.116.35732: Flags [P.], seq 1:43, ack 42, win 260, options [nop,nop,TS val 1509903 ecr 2137088], length 42 SMB PACKET: SMBecho (REPLY)

	16:39:26.627568 IP 192.168.56.116.35732 > 192.168.56.117.microsoft-ds: Flags [.], ack 43, win 499, options [nop,nop,TS val 2137088 ecr 1509903], length 0
	16:39:35.507299 IP 192.168.1.37.49881 > 192.168.1.34.microsoft-ds: Flags [.], seq 0:1, ack 1, win 1020, length 1[|SMB]
	16:39:35.507398 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49881: Flags [.], ack 1, win 374, options [nop,nop,sack 1 {0:1}], length 0
	16:39:40.969187 IP 192.168.56.116.35724 > 192.168.56.117.microsoft-ds: Flags [P.], seq 1366200597:1366200639, ack 1272377560, win 312, options [nop,nop,TS val 2140673 ecr 1498127], length 42 SMB PACKET: SMBecho (REQUEST)

	16:39:40.969669 IP 192.168.56.117.microsoft-ds > 192.168.56.116.35724: Flags [P.], seq 1:43, ack 42, win 260, options [nop,nop,TS val 1513489 ecr 2140673], length 42 SMB PACKET: SMBecho (REPLY)

	16:39:40.970226 IP 192.168.56.116.35724 > 192.168.56.117.microsoft-ds: Flags [.], ack 43, win 312, options [nop,nop,TS val 2140674 ecr 1513489], length 0
	16:40:08.144968 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [S], seq 1215203455, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
	16:40:08.145120 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [S.], seq 2350476699, ack 1215203456, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	16:40:08.150506 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [.], ack 1, win 1026, length 0
	16:40:08.152809 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 1:179, ack 1, win 1026, length 178 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.152860 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [.], ack 179, win 237, length 0
	16:40:08.158922 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 1:273, ack 179, win 237, length 272 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.165153 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 179:345, ack 273, win 1025, length 166 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.165809 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 273:590, ack 345, win 245, length 317 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.170808 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 345:980, ack 590, win 1024, length 635 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.178287 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49881: Flags [P.], seq 1:78, ack 1, win 374, length 77 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.178491 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49881: Flags [P.], seq 78:155, ack 1, win 374, length 77 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.183783 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 590:667, ack 980, win 255, length 77 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.186272 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 667:772, ack 980, win 255, length 105 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.189489 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [.], ack 772, win 1023, length 0
	16:40:08.189862 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 980:1098, ack 772, win 1023, length 118 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.190552 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 772:856, ack 1098, win 255, length 84 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.192890 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 1098:1358, ack 856, win 1023, length 260 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.193367 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 856:1124, ack 1358, win 265, length 268 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.196855 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 1358:1610, ack 1124, win 1022, length 252 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.197418 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 1124:1312, ack 1610, win 275, length 188 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.197823 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 1610:1766, ack 1124, win 1022, length 156 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.198027 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 1312:1500, ack 1766, win 285, length 188 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.198115 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 1500:1577, ack 1766, win 285, length 77 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.200311 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [.], ack 1500, win 1026, length 0
	16:40:08.201687 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 1766:1858, ack 1577, win 1026, length 92 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.201926 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 1577:1705, ack 1858, win 285, length 128 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.205497 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 1858:2078, ack 1705, win 1025, length 220 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.205823 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 1705:1782, ack 2078, win 295, length 77 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.210394 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 2078:2430, ack 1782, win 1025, length 352 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.211780 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 1782:2102, ack 2430, win 305, length 320 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.212009 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 2102:2234, ack 2430, win 305, length 132 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.214803 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [.], ack 2234, win 1023, length 0
	16:40:08.215397 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 2430:2530, ack 2234, win 1023, length 100 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.216760 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 2234:2311, ack 2530, win 305, length 77 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.240097 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 2530:2638, ack 2311, win 1023, length 108 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.240862 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 2311:2381, ack 2638, win 305, length 70 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.241116 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 2381:2513, ack 2638, win 305, length 132 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.243956 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [.], ack 2513, win 1022, length 0
	16:40:08.244475 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 2638:2738, ack 2513, win 1022, length 100 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.245320 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 2738:2846, ack 2513, win 1022, length 108 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.245523 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [.], ack 2846, win 305, length 0
	16:40:08.245762 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 2513:2645, ack 2846, win 305, length 132 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.245983 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 2645:2722, ack 2846, win 305, length 77 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.250230 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 2846:3067, ack 2645, win 1022, length 221 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.250586 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 2722:2926, ack 3067, win 315, length 204 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.252393 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [.], ack 2926, win 1020, length 0
	16:40:08.306124 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [P.], seq 3067:3273, ack 2926, win 1020, length 206 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.306732 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49977: Flags [P.], seq 2926:4090, ack 3273, win 325, length 1164 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.324044 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49881: Flags [P.], seq 78:155, ack 1, win 374, length 77 SMB-over-TCP packet:(raw data or continuation?)

	16:40:08.362895 IP 192.168.1.37.49977 > 192.168.1.34.microsoft-ds: Flags [.], ack 4090, win 1026, length 0
	16:40:08.740051 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49881: Flags [P.], seq 1:78, ack 1, win 374, length 77 SMB-over-TCP packet:(raw data or continuation?)

	16:40:09.572111 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49881: Flags [P.], seq 1:78, ack 1, win 374, length 77 SMB-over-TCP packet:(raw data or continuation?)

	16:40:11.236372 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49881: Flags [P.], seq 1:78, ack 1, win 374, length 77 SMB-over-TCP packet:(raw data or continuation?)

	16:40:14.692123 IP 192.168.1.34.microsoft-ds > 192.168.1.37.49881: Flags [P.], seq 1:78, ack 1, win 374, length 77 SMB-over-TCP packet:(raw data or continuation?)

	^C
	65 packets captured
	65 packets received by filter
	0 packets dropped by kernel
	root@NAS-SEAX:/home/shared#

	NOTA: No ha fet falta activar la característica de windows per habilitar la compatibilitat amb CIFS 1.0.

Ping des del client de windows 10 al servidor OpenVPN:

	root@NAS-SEAX:~# tcpdump -i enp0s3 icmp
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes
	^C
	0 packets captured
	0 packets received by filter
	0 packets dropped by kernel
	root@NAS-SEAX:~# tcpdump -i enp0s3 tun0
	tcpdump: syntax error in filter expression: syntax error
	root@NAS-SEAX:~# ^C
	root@NAS-SEAX:~# tcpdump -i tun0 icmp
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on tun0, link-type RAW (Raw IP), capture size 262144 bytes
	12:44:53.874687 IP 10.10.10.6 > 10.10.10.1: ICMP echo request, id 1, seq 16, length 40
	12:44:53.874740 IP 10.10.10.1 > 10.10.10.6: ICMP echo reply, id 1, seq 16, length 40
	12:44:54.009252 IP 10.10.10.1 > 10.10.10.6: ICMP net 208.67.222.222 unreachable, length 77
	12:44:54.009350 IP 10.10.10.1 > 10.10.10.6: ICMP net 208.67.220.220 unreachable, length 77
	12:44:54.884178 IP 10.10.10.6 > 10.10.10.1: ICMP echo request, id 1, seq 17, length 40
	12:44:54.884268 IP 10.10.10.1 > 10.10.10.6: ICMP echo reply, id 1, seq 17, length 40
	12:44:55.897664 IP 10.10.10.6 > 10.10.10.1: ICMP echo request, id 1, seq 18, length 40
	12:44:55.897729 IP 10.10.10.1 > 10.10.10.6: ICMP echo reply, id 1, seq 18, length 40
	12:44:56.909623 IP 10.10.10.6 > 10.10.10.1: ICMP echo request, id 1, seq 19, length 40
	12:44:56.909682 IP 10.10.10.1 > 10.10.10.6: ICMP echo reply, id 1, seq 19, length 40
	12:44:56.996969 IP 10.10.10.1 > 10.10.10.6: ICMP net 81.161.59.132 unreachable, length 60
	^C
	11 packets captured
	11 packets received by filter
	0 packets dropped by kernel
	root@NAS-SEAX:~#

	root@NAS-SEAX:~# tcpdump -i tun0 icmp
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on tun0, link-type RAW (Raw IP), capture size 262144 bytes
	12:44:53.874687 IP 10.10.10.6 > 10.10.10.1: ICMP echo request, id 1, seq 16, length 40
	12:44:53.874740 IP 10.10.10.1 > 10.10.10.6: ICMP echo reply, id 1, seq 16, length 40
	12:44:54.009252 IP 10.10.10.1 > 10.10.10.6: ICMP net 208.67.222.222 unreachable, length 77
	12:44:54.009350 IP 10.10.10.1 > 10.10.10.6: ICMP net 208.67.220.220 unreachable, length 77
	12:44:54.884178 IP 10.10.10.6 > 10.10.10.1: ICMP echo request, id 1, seq 17, length 40
	12:44:54.884268 IP 10.10.10.1 > 10.10.10.6: ICMP echo reply, id 1, seq 17, length 40
	12:44:55.897664 IP 10.10.10.6 > 10.10.10.1: ICMP echo request, id 1, seq 18, length 40
	12:44:55.897729 IP 10.10.10.1 > 10.10.10.6: ICMP echo reply, id 1, seq 18, length 40
	12:44:56.909623 IP 10.10.10.6 > 10.10.10.1: ICMP echo request, id 1, seq 19, length 40
	12:44:56.909682 IP 10.10.10.1 > 10.10.10.6: ICMP echo reply, id 1, seq 19, length 40
	12:44:56.996969 IP 10.10.10.1 > 10.10.10.6: ICMP net 81.161.59.132 unreachable, length 60
	^C
	11 packets captured
	11 packets received by filter
	0 packets dropped by kernel
	root@NAS-SEAX:~#

Muntant samba en Windows 10 fent servir la VPN:

	root@NAS-SEAX:~# tcpdump -i any port 445
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
	13:04:16.067794 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [S], seq 2823012016, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
	13:04:16.067924 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [S.], seq 585324274, ack 2823012017, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	13:04:16.069424 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [.], ack 1, win 256, length 0
	13:04:16.069501 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 1:160, ack 1, win 256, length 159 SMB PACKET: SMBnegprot (REQUEST)

	13:04:16.069534 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [.], ack 160, win 237, length 0
	13:04:16.079855 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 1:207, ack 160, win 237, length 206 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.081342 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 160:338, ack 207, win 255, length 178 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.081745 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 207:479, ack 338, win 245, length 272 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.085785 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 338:504, ack 479, win 254, length 166 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.086513 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 479:796, ack 504, win 254, length 317 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.090002 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 504:1137, ack 796, win 253, length 633 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.098184 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 796:901, ack 1137, win 264, length 105 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.100706 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 1137:1243, ack 901, win 253, length 106 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.101382 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 901:985, ack 1243, win 264, length 84 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.102658 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 1243:1403, ack 985, win 252, length 160 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.102919 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 985:1062, ack 1403, win 274, length 77 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.107665 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 1403:1513, ack 1062, win 252, length 110 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.108465 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 1062:1146, ack 1513, win 274, length 84 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.151799 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [.], ack 1146, win 252, length 0
	13:04:16.333606 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 1513:1841, ack 1146, win 252, length 328 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.333668 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 1841:2021, ack 1146, win 252, length 180 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.338054 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 1146:1223, ack 2021, win 293, length 77 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.339400 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 1223:1467, ack 2021, win 293, length 244 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.341042 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 2021:2217, ack 1467, win 256, length 196 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.341710 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 1467:1544, ack 2217, win 303, length 77 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.383865 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [.], ack 1544, win 256, length 0
	13:04:16.829979 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 2217:2529, ack 1544, win 256, length 312 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.831180 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 1544:1788, ack 2529, win 313, length 244 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.835765 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 2529:2887, ack 1788, win 255, length 358 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.837535 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 1788:3264, ack 2887, win 323, length 1476 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.839537 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [.], ack 3264, win 256, length 0
	13:04:16.839621 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 2887:2979, ack 3264, win 256, length 92 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.840072 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 3264:3392, ack 2979, win 323, length 128 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.842255 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 2979:3071, ack 3392, win 256, length 92 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.842552 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 3392:3520, ack 3071, win 323, length 128 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.861477 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 3071:3383, ack 3520, win 255, length 312 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.862368 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 3520:3764, ack 3383, win 333, length 244 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.864815 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 3383:3483, ack 3764, win 254, length 100 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.864873 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 3483:3583, ack 3764, win 254, length 100 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.865574 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [.], ack 3583, win 333, length 0
	13:04:16.866159 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 3764:3841, ack 3583, win 333, length 77 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.867502 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 3841:3918, ack 3583, win 333, length 77 SMB-over-TCP packet:(raw data or continuation?)

	13:04:16.869560 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [.], ack 3918, win 254, length 0
	13:04:17.006874 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 3583:3843, ack 3918, win 254, length 260 SMB-over-TCP packet:(raw data or continuation?)

	13:04:17.008365 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 3918:4210, ack 3843, win 343, length 292 SMB-over-TCP packet:(raw data or continuation?)

	13:04:17.012249 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 3843:3951, ack 4210, win 252, length 108 SMB-over-TCP packet:(raw data or continuation?)

	13:04:17.013310 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 4210:4318, ack 3951, win 343, length 108 SMB-over-TCP packet:(raw data or continuation?)

	13:04:17.015883 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [P.], seq 3951:4172, ack 4318, win 252, length 221 SMB-over-TCP packet:(raw data or continuation?)

	13:04:17.016237 IP 10.10.10.1.microsoft-ds > 192.168.1.69.50871: Flags [P.], seq 4318:4522, ack 4172, win 353, length 204 SMB-over-TCP packet:(raw data or continuation?)

	13:04:17.059927 IP 192.168.1.69.50871 > 10.10.10.1.microsoft-ds: Flags [.], ack 4522, win 251, length 0
	^C
	50 packets captured
	50 packets received by filter
	0 packets dropped by kernel
	root@NAS-SEAX:~#

Vista de la validació anterior des de l'equip del company Heribert:

	C:\Users\herib>ping 10.10.10.1

	Haciendo ping a 10.10.10.1 con 32 bytes de datos:
	Respuesta desde 10.10.10.1: bytes=32 tiempo=2ms TTL=64
	Respuesta desde 10.10.10.1: bytes=32 tiempo=2ms TTL=64
	Respuesta desde 10.10.10.1: bytes=32 tiempo=2ms TTL=64
	Respuesta desde 10.10.10.1: bytes=32 tiempo=2ms TTL=64

	Estadísticas de ping para 10.10.10.1:
	    Paquetes: enviados = 4, recibidos = 4, perdidos = 0
	    (0% perdidos),
	Tiempos aproximados de ida y vuelta en milisegundos:
	    Mínimo = 2ms, Máximo = 2ms, Media = 2ms

	C:\Users\herib>ping 10.10.10.1

	Haciendo ping a 10.10.10.1 con 32 bytes de datos:
	Respuesta desde 10.10.10.1: bytes=32 tiempo=2ms TTL=64
	Respuesta desde 10.10.10.1: bytes=32 tiempo=2ms TTL=64
	Respuesta desde 10.10.10.1: bytes=32 tiempo=2ms TTL=64
	Respuesta desde 10.10.10.1: bytes=32 tiempo=2ms TTL=64

	Estadísticas de ping para 10.10.10.1:
	    Paquetes: enviados = 4, recibidos = 4, perdidos = 0
	    (0% perdidos),
	Tiempos aproximados de ida y vuelta en milisegundos:
	    Mínimo = 2ms, Máximo = 2ms, Media = 2ms


	C:\Users\herib>z:

	Z:\>ls
	"ls" no se reconoce como un comando interno o externo,
	programa o archivo por lotes ejecutable.

	Z:\>c:

	C:\Users\herib>z:

	Z:\>dir
	 El volumen de la unidad Z es shared
	 El número de serie del volumen es: CC05-DA4F

	 Directorio de Z:\

	31/05/2019  17:03    <DIR>          .
	24/05/2019  19:58    <DIR>          ..
	31/05/2019  17:03            10.253 client.ovpn
	31/05/2019  15:06                17 itiel-test
	26/05/2019  16:16                 0 itiel_prova.txt
	31/05/2019  16:40                 0 New Text Document.txt
	01/06/2019  13:04               785 test.py
	03/05/2019  15:18                 0 Uploaded_file
		       6 archivos         11.055 bytes
		       2 dirs     350.355.456 bytes libres

	Z:\>mkdir WindowsTest

	Z:\>dir
	 El volumen de la unidad Z es shared
	 El número de serie del volumen es: CC05-DA4F

	 Directorio de Z:\

	01/06/2019  13:07    <DIR>          .
	24/05/2019  19:58    <DIR>          ..
	31/05/2019  17:03            10.253 client.ovpn
	31/05/2019  15:06                17 itiel-test
	26/05/2019  16:16                 0 itiel_prova.txt
	31/05/2019  16:40                 0 New Text Document.txt
	01/06/2019  13:04               785 test.py
	03/05/2019  15:18                 0 Uploaded_file
	01/06/2019  13:07    <DIR>          WindowsTest
		       6 archivos         11.055 bytes
		       3 dirs     350.355.456 bytes libres

	Z:\>

Comprovant tràfic amb webdav del directori http://entel.com/entel i https://entel.com/entel. No conecta fent servir el client de windows 10, però, genera tràfic:

	root@NAS-SEAX:/etc/apache2# tcpdump -i any port 80 or port 443
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
	13:14:46.665381 IP 192.168.1.69.51047 > 192.168.1.34.http: Flags [S], seq 4042562928, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
	13:14:46.665547 IP 192.168.1.34.http > 192.168.1.69.51047: Flags [S.], seq 3289878079, ack 4042562929, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	13:14:46.667042 IP 192.168.1.69.51047 > 192.168.1.34.http: Flags [.], ack 1, win 256, length 0
	13:14:46.668918 IP 192.168.1.69.51047 > 192.168.1.34.http: Flags [P.], seq 1:129, ack 1, win 256, length 128: HTTP: OPTIONS / HTTP/1.1
	13:14:46.669076 IP 192.168.1.34.http > 192.168.1.69.51047: Flags [.], ack 129, win 237, length 0
	13:14:46.670364 IP 192.168.1.34.http > 192.168.1.69.51047: Flags [.], seq 1:7301, ack 129, win 237, length 7300: HTTP: HTTP/1.1 200 OK
	13:14:46.670817 IP 192.168.1.34.http > 192.168.1.69.51047: Flags [P.], seq 7301:7438, ack 129, win 237, length 137: HTTP
	13:14:46.672351 IP 192.168.1.69.51047 > 192.168.1.34.http: Flags [.], ack 7438, win 256, length 0
	13:14:46.678771 IP 192.168.1.69.51047 > 192.168.1.34.http: Flags [R.], seq 129, ack 7438, win 0, length 0
	13:14:46.687462 IP 192.168.1.69.51048 > 192.168.1.34.http: Flags [S], seq 519478627, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
	13:14:46.687548 IP 192.168.1.34.http > 192.168.1.69.51048: Flags [S.], seq 2701008734, ack 519478628, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	13:14:46.689378 IP 192.168.1.69.51048 > 192.168.1.34.http: Flags [.], ack 1, win 256, length 0
	13:14:46.690754 IP 192.168.1.69.51048 > 192.168.1.34.http: Flags [P.], seq 1:135, ack 1, win 256, length 134: HTTP: PROPFIND /entel HTTP/1.1
	13:14:46.690796 IP 192.168.1.34.http > 192.168.1.69.51048: Flags [.], ack 135, win 237, length 0
	13:14:46.691040 IP 192.168.1.34.http > 192.168.1.69.51048: Flags [P.], seq 1:717, ack 135, win 237, length 716: HTTP: HTTP/1.1 401 Unauthorized
	13:14:46.732859 IP 192.168.1.69.51048 > 192.168.1.34.http: Flags [.], ack 717, win 253, length 0
	13:14:51.695629 IP 192.168.1.34.http > 192.168.1.69.51048: Flags [F.], seq 717, ack 135, win 237, length 0
	13:14:51.910911 IP 192.168.1.34.http > 192.168.1.69.51048: Flags [F.], seq 717, ack 135, win 237, length 0
	13:14:52.126648 IP 192.168.1.34.http > 192.168.1.69.51048: Flags [F.], seq 717, ack 135, win 237, length 0
	13:14:52.558867 IP 192.168.1.34.http > 192.168.1.69.51048: Flags [F.], seq 717, ack 135, win 237, length 0
	13:14:53.422898 IP 192.168.1.34.http > 192.168.1.69.51048: Flags [F.], seq 717, ack 135, win 237, length 0
	13:14:55.150591 IP 192.168.1.34.http > 192.168.1.69.51048: Flags [F.], seq 717, ack 135, win 237, length 0
	13:14:58.644236 IP 192.168.1.34.http > 192.168.1.69.51048: Flags [F.], seq 717, ack 135, win 237, length 0
	13:14:58.712874 IP 192.168.1.69.51048 > 192.168.1.34.http: Flags [.], ack 718, win 253, length 0
	13:14:58.713206 IP 192.168.1.69.51048 > 192.168.1.34.http: Flags [F.], seq 135, ack 718, win 253, length 0
	13:14:58.713248 IP 192.168.1.34.http > 192.168.1.69.51048: Flags [.], ack 136, win 237, length 0
	
	13:15:29.336086 IP 192.168.1.69.51055 > 192.168.1.34.https: Flags [S], seq 3486221852, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
	13:15:29.336208 IP 192.168.1.34.https > 192.168.1.69.51055: Flags [S.], seq 1450426566, ack 3486221853, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	13:15:29.338009 IP 192.168.1.69.51055 > 192.168.1.34.https: Flags [.], ack 1, win 256, length 0
	13:15:29.339336 IP 192.168.1.69.51055 > 192.168.1.34.https: Flags [P.], seq 1:193, ack 1, win 256, length 192
	13:15:29.339417 IP 192.168.1.34.https > 192.168.1.69.51055: Flags [.], ack 193, win 237, length 0
	13:15:29.343843 IP 192.168.1.34.https > 192.168.1.69.51055: Flags [P.], seq 1:1212, ack 193, win 237, length 1211
	13:15:29.350836 IP 192.168.1.69.51055 > 192.168.1.34.https: Flags [P.], seq 193:319, ack 1212, win 251, length 126
	13:15:29.351513 IP 192.168.1.34.https > 192.168.1.69.51055: Flags [P.], seq 1212:1486, ack 319, win 237, length 274
	13:15:29.355760 IP 192.168.1.69.51055 > 192.168.1.34.https: Flags [F.], seq 319, ack 1486, win 256, length 0
	13:15:29.356369 IP 192.168.1.34.https > 192.168.1.69.51055: Flags [P.], seq 1486:1517, ack 320, win 237, length 31
	13:15:29.356616 IP 192.168.1.34.https > 192.168.1.69.51055: Flags [F.], seq 1517, ack 320, win 237, length 0
	13:15:29.358812 IP 192.168.1.69.51055 > 192.168.1.34.https: Flags [R.], seq 320, ack 1517, win 0, length 0
	13:15:32.777110 IP 192.168.1.69.51056 > 192.168.1.34.https: Flags [S], seq 1215090215, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
	13:15:32.777221 IP 192.168.1.34.https > 192.168.1.69.51056: Flags [S.], seq 1284490091, ack 1215090216, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	13:15:32.778766 IP 192.168.1.69.51056 > 192.168.1.34.https: Flags [.], ack 1, win 256, length 0
	13:15:32.780050 IP 192.168.1.69.51056 > 192.168.1.34.https: Flags [P.], seq 1:193, ack 1, win 256, length 192
	13:15:32.780169 IP 192.168.1.34.https > 192.168.1.69.51056: Flags [.], ack 193, win 237, length 0
	13:15:32.784716 IP 192.168.1.34.https > 192.168.1.69.51056: Flags [P.], seq 1:1212, ack 193, win 237, length 1211
	13:15:32.791423 IP 192.168.1.69.51056 > 192.168.1.34.https: Flags [P.], seq 193:319, ack 1212, win 251, length 126
	13:15:32.791910 IP 192.168.1.34.https > 192.168.1.69.51056: Flags [P.], seq 1212:1486, ack 319, win 237, length 274
	13:15:32.795873 IP 192.168.1.69.51056 > 192.168.1.34.https: Flags [F.], seq 319, ack 1486, win 256, length 0
	13:15:32.796026 IP 192.168.1.34.https > 192.168.1.69.51056: Flags [P.], seq 1486:1517, ack 320, win 237, length 31
	13:15:32.796131 IP 192.168.1.34.https > 192.168.1.69.51056: Flags [F.], seq 1517, ack 320, win 237, length 0
	13:15:32.796805 IP 192.168.1.69.51057 > 192.168.1.34.https: Flags [S], seq 896282792, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
	13:15:32.796844 IP 192.168.1.34.https > 192.168.1.69.51057: Flags [S.], seq 629198930, ack 896282793, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	13:15:32.797433 IP 192.168.1.69.51056 > 192.168.1.34.https: Flags [R.], seq 320, ack 1517, win 0, length 0
	13:15:32.798567 IP 192.168.1.69.51057 > 192.168.1.34.https: Flags [.], ack 1, win 256, length 0
	13:15:32.799788 IP 192.168.1.69.51057 > 192.168.1.34.https: Flags [P.], seq 1:401, ack 1, win 256, length 400
	13:15:32.799817 IP 192.168.1.34.https > 192.168.1.69.51057: Flags [.], ack 401, win 237, length 0
	13:15:32.800237 IP 192.168.1.34.https > 192.168.1.69.51057: Flags [P.], seq 1:121, ack 401, win 237, length 120
	13:15:32.804007 IP 192.168.1.69.51057 > 192.168.1.34.https: Flags [P.], seq 401:452, ack 121, win 256, length 51
	13:15:32.804828 IP 192.168.1.69.51057 > 192.168.1.34.https: Flags [F.], seq 452, ack 121, win 256, length 0
	13:15:32.804930 IP 192.168.1.34.https > 192.168.1.69.51057: Flags [P.], seq 121:152, ack 453, win 237, length 31
	13:15:32.805023 IP 192.168.1.34.https > 192.168.1.69.51057: Flags [F.], seq 152, ack 453, win 237, length 0
	13:15:32.806088 IP 192.168.1.69.51057 > 192.168.1.34.https: Flags [R.], seq 453, ack 152, win 0, length 0
	^C
	61 packets captured
	61 packets received by filter
	0 packets dropped by kernel
	root@NAS-SEAX:/etc/apache2#

Mateixa prova que l'anterior, però, fent servir la VPN directament connectant-se el cli a la ip 10.10.10.1:

	root@NAS-SEAX:/etc/apache2# tcpdump -i any port 80 or port 443
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
	13:18:02.735513 IP 192.168.1.69.51107 > 10.10.10.1.http: Flags [S], seq 1397806577, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
	13:18:02.735629 IP 10.10.10.1.http > 192.168.1.69.51107: Flags [S.], seq 2287734490, ack 1397806578, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	13:18:02.737722 IP 192.168.1.69.51107 > 10.10.10.1.http: Flags [.], ack 1, win 256, length 0
	13:18:02.739253 IP 192.168.1.69.51107 > 10.10.10.1.http: Flags [P.], seq 1:128, ack 1, win 256, length 127: HTTP: OPTIONS / HTTP/1.1
	13:18:02.739364 IP 10.10.10.1.http > 192.168.1.69.51107: Flags [.], ack 128, win 229, length 0
	13:18:02.742327 IP 10.10.10.1.http > 192.168.1.69.51107: Flags [.], seq 1:7301, ack 128, win 229, length 7300: HTTP: HTTP/1.1 200 OK
	13:18:02.742696 IP 10.10.10.1.http > 192.168.1.69.51107: Flags [P.], seq 7301:7435, ack 128, win 229, length 134: HTTP
	13:18:02.744033 IP 192.168.1.69.51107 > 10.10.10.1.http: Flags [.], ack 7435, win 256, length 0
	13:18:02.751006 IP 192.168.1.69.51107 > 10.10.10.1.http: Flags [R.], seq 128, ack 7435, win 0, length 0
	13:18:02.759628 IP 192.168.1.69.51108 > 10.10.10.1.http: Flags [S], seq 2203564107, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
	13:18:02.759697 IP 10.10.10.1.http > 192.168.1.69.51108: Flags [S.], seq 2378649240, ack 2203564108, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	13:18:02.761288 IP 192.168.1.69.51108 > 10.10.10.1.http: Flags [.], ack 1, win 256, length 0
	13:18:02.763285 IP 192.168.1.69.51108 > 10.10.10.1.http: Flags [P.], seq 1:133, ack 1, win 256, length 132: HTTP: PROPFIND /seax HTTP/1.1
	13:18:02.763331 IP 10.10.10.1.http > 192.168.1.69.51108: Flags [.], ack 133, win 237, length 0
	13:18:02.763642 IP 10.10.10.1.http > 192.168.1.69.51108: Flags [P.], seq 1:716, ack 133, win 237, length 715: HTTP: HTTP/1.1 401 Unauthorized
	13:18:02.806080 IP 192.168.1.69.51108 > 10.10.10.1.http: Flags [.], ack 716, win 253, length 0
	13:18:07.769251 IP 10.10.10.1.http > 192.168.1.69.51108: Flags [F.], seq 716, ack 133, win 237, length 0
	13:18:07.771711 IP 192.168.1.69.51108 > 10.10.10.1.http: Flags [.], ack 717, win 253, length 0
	13:18:07.772123 IP 192.168.1.69.51108 > 10.10.10.1.http: Flags [F.], seq 133, ack 717, win 253, length 0
	13:18:07.772171 IP 10.10.10.1.http > 192.168.1.69.51108: Flags [.], ack 134, win 237, length 0
	13:18:11.375364 IP 192.168.1.69.51109 > 10.10.10.1.http: Flags [S], seq 2567987157, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
	13:18:11.375480 IP 10.10.10.1.http > 192.168.1.69.51109: Flags [S.], seq 3743478787, ack 2567987158, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	13:18:11.376543 IP 192.168.1.69.51109 > 10.10.10.1.http: Flags [.], ack 1, win 256, length 0
	13:18:11.378473 IP 192.168.1.69.51109 > 10.10.10.1.http: Flags [P.], seq 1:132, ack 1, win 256, length 131: HTTP: OPTIONS /seax HTTP/1.1
	13:18:11.378548 IP 10.10.10.1.http > 192.168.1.69.51109: Flags [.], ack 132, win 237, length 0
	13:18:11.379096 IP 10.10.10.1.http > 192.168.1.69.51109: Flags [P.], seq 1:716, ack 132, win 237, length 715: HTTP: HTTP/1.1 401 Unauthorized
	13:18:11.421656 IP 192.168.1.69.51109 > 10.10.10.1.http: Flags [.], ack 716, win 253, length 0
	13:18:16.384605 IP 10.10.10.1.http > 192.168.1.69.51109: Flags [F.], seq 716, ack 132, win 237, length 0
	13:18:16.387063 IP 192.168.1.69.51109 > 10.10.10.1.http: Flags [.], ack 717, win 253, length 0
	13:18:16.387519 IP 192.168.1.69.51109 > 10.10.10.1.http: Flags [F.], seq 132, ack 717, win 253, length 0
	13:18:16.387572 IP 10.10.10.1.http > 192.168.1.69.51109: Flags [.], ack 133, win 237, length 0
	13:18:17.038130 IP 192.168.1.69.51110 > 10.10.10.1.https: Flags [S], seq 2975580278, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
	13:18:17.038245 IP 10.10.10.1.https > 192.168.1.69.51110: Flags [S.], seq 239289720, ack 2975580279, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	13:18:17.039747 IP 192.168.1.69.51110 > 10.10.10.1.https: Flags [.], ack 1, win 256, length 0
	13:18:17.041279 IP 192.168.1.69.51110 > 10.10.10.1.https: Flags [P.], seq 1:192, ack 1, win 256, length 191
	13:18:17.041391 IP 10.10.10.1.https > 192.168.1.69.51110: Flags [.], ack 192, win 237, length 0
	13:18:17.049072 IP 10.10.10.1.https > 192.168.1.69.51110: Flags [P.], seq 1:1212, ack 192, win 237, length 1211
	13:18:17.055327 IP 192.168.1.69.51110 > 10.10.10.1.https: Flags [P.], seq 192:318, ack 1212, win 251, length 126
	13:18:17.055972 IP 10.10.10.1.https > 192.168.1.69.51110: Flags [P.], seq 1212:1470, ack 318, win 237, length 258
	13:18:17.060282 IP 192.168.1.69.51110 > 10.10.10.1.https: Flags [F.], seq 318, ack 1470, win 256, length 0
	13:18:17.060507 IP 10.10.10.1.https > 192.168.1.69.51110: Flags [P.], seq 1470:1501, ack 319, win 237, length 31
	13:18:17.060851 IP 10.10.10.1.https > 192.168.1.69.51110: Flags [F.], seq 1501, ack 319, win 237, length 0
	13:18:17.062659 IP 192.168.1.69.51110 > 10.10.10.1.https: Flags [R.], seq 319, ack 1501, win 0, length 0
	13:18:47.564240 IP 192.168.1.69.51116 > 10.10.10.1.https: Flags [S], seq 55920720, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
	13:18:47.564358 IP 10.10.10.1.https > 192.168.1.69.51116: Flags [S.], seq 894956361, ack 55920721, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	13:18:47.565803 IP 192.168.1.69.51116 > 10.10.10.1.https: Flags [.], ack 1, win 256, length 0
	13:18:47.566846 IP 192.168.1.69.51116 > 10.10.10.1.https: Flags [P.], seq 1:192, ack 1, win 256, length 191
	13:18:47.566922 IP 10.10.10.1.https > 192.168.1.69.51116: Flags [.], ack 192, win 237, length 0
	13:18:47.571181 IP 10.10.10.1.https > 192.168.1.69.51116: Flags [P.], seq 1:1212, ack 192, win 237, length 1211
	13:18:47.577816 IP 192.168.1.69.51116 > 10.10.10.1.https: Flags [P.], seq 192:318, ack 1212, win 251, length 126
	13:18:47.579248 IP 10.10.10.1.https > 192.168.1.69.51116: Flags [P.], seq 1212:1470, ack 318, win 237, length 258
	13:18:47.583440 IP 192.168.1.69.51116 > 10.10.10.1.https: Flags [F.], seq 318, ack 1470, win 256, length 0
	13:18:47.583670 IP 10.10.10.1.https > 192.168.1.69.51116: Flags [P.], seq 1470:1501, ack 319, win 237, length 31
	13:18:47.584098 IP 10.10.10.1.https > 192.168.1.69.51116: Flags [F.], seq 1501, ack 319, win 237, length 0
	13:18:47.584421 IP 192.168.1.69.51117 > 10.10.10.1.https: Flags [S], seq 3203236857, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
	13:18:47.584496 IP 10.10.10.1.https > 192.168.1.69.51117: Flags [S.], seq 296916541, ack 3203236858, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	13:18:47.585087 IP 192.168.1.69.51116 > 10.10.10.1.https: Flags [R.], seq 319, ack 1501, win 0, length 0
	13:18:47.585711 IP 192.168.1.69.51117 > 10.10.10.1.https: Flags [.], ack 1, win 256, length 0
	13:18:47.586743 IP 192.168.1.69.51117 > 10.10.10.1.https: Flags [P.], seq 1:384, ack 1, win 256, length 383
	13:18:47.586777 IP 10.10.10.1.https > 192.168.1.69.51117: Flags [.], ack 384, win 237, length 0
	13:18:47.587277 IP 10.10.10.1.https > 192.168.1.69.51117: Flags [P.], seq 1:121, ack 384, win 237, length 120
	13:18:47.590379 IP 192.168.1.69.51117 > 10.10.10.1.https: Flags [P.], seq 384:435, ack 121, win 256, length 51
	13:18:47.591487 IP 192.168.1.69.51117 > 10.10.10.1.https: Flags [F.], seq 435, ack 121, win 256, length 0
	13:18:47.591593 IP 10.10.10.1.https > 192.168.1.69.51117: Flags [P.], seq 121:152, ack 436, win 237, length 31
	13:18:47.591663 IP 10.10.10.1.https > 192.168.1.69.51117: Flags [F.], seq 152, ack 436, win 237, length 0
	13:18:47.594222 IP 192.168.1.69.51117 > 10.10.10.1.https: Flags [R.], seq 436, ack 152, win 0, length 0
	13:18:54.509468 IP 192.168.1.69.51118 > 10.10.10.1.https: Flags [S], seq 1879673918, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
	13:18:54.509583 IP 10.10.10.1.https > 192.168.1.69.51118: Flags [S.], seq 1487931347, ack 1879673919, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	13:18:54.511639 IP 192.168.1.69.51118 > 10.10.10.1.https: Flags [.], ack 1, win 256, length 0
	13:18:54.512887 IP 192.168.1.69.51118 > 10.10.10.1.https: Flags [P.], seq 1:192, ack 1, win 256, length 191
	13:18:54.512941 IP 10.10.10.1.https > 192.168.1.69.51118: Flags [.], ack 192, win 237, length 0
	13:18:54.515914 IP 10.10.10.1.https > 192.168.1.69.51118: Flags [P.], seq 1:1212, ack 192, win 237, length 1211
	13:18:54.524411 IP 192.168.1.69.51118 > 10.10.10.1.https: Flags [P.], seq 192:318, ack 1212, win 251, length 126
	13:18:54.524928 IP 10.10.10.1.https > 192.168.1.69.51118: Flags [P.], seq 1212:1470, ack 318, win 237, length 258
	13:18:54.528852 IP 192.168.1.69.51118 > 10.10.10.1.https: Flags [F.], seq 318, ack 1470, win 256, length 0
	13:18:54.529080 IP 10.10.10.1.https > 192.168.1.69.51118: Flags [P.], seq 1470:1501, ack 319, win 237, length 31
	13:18:54.529228 IP 10.10.10.1.https > 192.168.1.69.51118: Flags [F.], seq 1501, ack 319, win 237, length 0
	13:18:54.530662 IP 192.168.1.69.51118 > 10.10.10.1.https: Flags [R.], seq 319, ack 1501, win 0, length 0
	^C
	78 packets captured
	78 packets received by filter
	0 packets dropped by kernel
	root@NAS-SEAX:/etc/apache2#

Aquesta prova s'ha fet des de l'equip del company Heribert connectant-se al servidor NAS des de Windows 10 fent servir sftp i la xarxa de l'universitat:

	C:\Users\herib>sftp entel@192.168.60.113
	The authenticity of host '192.168.60.113 (192.168.60.113)' can't be established.
	ECDSA key fingerprint is SHA256:NKzNH7qxcG7NJF/nzIkqEvxC3YePZoPh0eCVcR6/A3s.
	Are you sure you want to continue connecting (yes/no)?
	Warning: Permanently added '192.168.60.113' (ECDSA) to the list of known hosts.
	entel@192.168.60.113's password:
	Connected to entel@192.168.60.113.
	sftp> ls
	entel   seax    shared
	sftp> exit

	C:\Users\herib>

Comprovació sftp fent servir Windows 10 per el terminal de comandes (CMD):

	root@NAS-SEAX:~# tcpdump -i port 22 host 192.168.60.81
	tcpdump: port: No such device exists
	(SIOCGIFHWADDR: No such device)
	root@NAS-SEAX:~# tcpdump -i enp0s3 port 22 host 192.168.60.81
	tcpdump: syntax error in filter expression: syntax error
	root@NAS-SEAX:~# tcpdump -i enp0s3 port 22 and  host 192.168.60.81
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes
	17:13:45.631429 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [S], seq 538421678, win 64240, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
	17:13:45.631494 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [S.], seq 2154871125, ack 538421679, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
	17:13:45.632175 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [.], ack 1, win 256, length 0
	17:13:45.639802 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1:34, ack 1, win 256, length 33
	17:13:45.639854 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [.], ack 34, win 229, length 0
	17:13:45.646420 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 1:40, ack 34, win 229, length 39
	17:13:45.654103 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 34:1258, ack 40, win 256, length 1224
	17:13:45.654161 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 40:1120, ack 1258, win 251, length 1080
	17:13:45.660178 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1258:1306, ack 1120, win 252, length 48
	17:13:45.666760 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 1120:1540, ack 1306, win 251, length 420
	17:13:45.707613 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [.], ack 1540, win 256, length 0
	17:13:47.489363 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1306:1322, ack 1540, win 256, length 16
	17:13:47.531427 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [.], ack 1322, win 251, length 0
	17:13:47.531818 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1322:1366, ack 1540, win 256, length 44
	17:13:47.531836 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [.], ack 1366, win 251, length 0
	17:13:47.531967 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 1540:1584, ack 1366, win 251, length 44
	17:13:47.532628 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1366:1434, ack 1584, win 256, length 68
	17:13:47.533431 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 1584:1636, ack 1434, win 251, length 52
	17:13:47.574240 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [.], ack 1636, win 256, length 0
	17:13:51.087458 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1434:1518, ack 1636, win 256, length 84
	17:13:51.096165 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 1636:1664, ack 1518, win 251, length 28
	17:13:51.097229 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1518:1630, ack 1664, win 256, length 112
	17:13:51.132016 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 1664:2164, ack 1630, win 251, length 500
	17:13:51.172852 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [.], ack 2164, win 254, length 0
	17:13:51.172962 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 2164:2208, ack 1630, win 251, length 44
	17:13:51.173979 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1630:1682, ack 2208, win 254, length 52
	17:13:51.175217 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 2208:2280, ack 1682, win 251, length 72
	17:13:51.176118 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1682:1726, ack 2280, win 253, length 44
	17:13:51.178955 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 2280:2468, ack 1726, win 251, length 188
	17:13:51.180292 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1726:1770, ack 2468, win 253, length 44
	17:13:51.180320 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1770:1814, ack 2468, win 253, length 44
	17:13:51.180691 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [.], ack 1814, win 251, length 0
	17:13:51.181348 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 2468:2536, ack 1814, win 251, length 68
	17:13:51.222426 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [.], ack 2536, win 252, length 0
	17:13:54.550226 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1814:1858, ack 2536, win 252, length 44
	17:13:54.550272 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1858:1902, ack 2536, win 252, length 44
	17:13:54.550741 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [.], ack 1902, win 251, length 0
	17:13:54.551204 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 2536:2588, ack 1902, win 251, length 52
	17:13:54.552253 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1902:1946, ack 2588, win 252, length 44
	17:13:54.552303 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1946:1998, ack 2588, win 252, length 52
	17:13:54.552852 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [.], ack 1998, win 251, length 0
	17:13:54.553946 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 2588:3152, ack 1998, win 251, length 564
	17:13:54.555016 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 1998:2042, ack 3152, win 256, length 44
	17:13:54.555050 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 2042:2094, ack 3152, win 256, length 52
	17:13:54.555586 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [.], ack 2094, win 251, length 0
	17:13:54.555909 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 3152:3220, ack 2094, win 251, length 68
	17:13:54.560806 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 2094:2138, ack 3220, win 256, length 44
	17:13:54.560884 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 2138:2190, ack 3220, win 256, length 52
	17:13:54.561062 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [.], ack 2190, win 251, length 0
	17:13:54.561303 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 3220:3288, ack 2190, win 251, length 68
	17:13:54.601370 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [.], ack 3288, win 256, length 0
	17:13:55.659700 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [P.], seq 2190:2226, ack 3288, win 256, length 36
	17:13:55.660577 IP nas-seax.epsevg.upc.es.ssh > laptop-aak4nu13.epsevg.upc.es.49883: Flags [P.], seq 3288:3412, ack 2226, win 251, length 124
	17:13:55.661942 IP laptop-aak4nu13.epsevg.upc.es.49883 > nas-seax.epsevg.upc.es.ssh: Flags [R.], seq 2226, ack 3412, win 0, length 0
	^C
	54 packets captured
	54 packets received by filter
	0 packets dropped by kernel
	root@NAS-SEAX:~# 


# Pràctica 3 - Sessió 1 - Accés al servidor mitjançant SFTP i SAMBA. (Luque Díaz Itiel)
---------------------------------------------------------------------------------------

# PROGRAMARI NECESSARI
----------------------

* Editor de textos (Gedit p.exemple)
* nano/pico (opcionalment)
* openssh-server (apt-get install openssh-server)
* sshfs (apt-get install sshfs)
* samba (apt-get install samba)
* smbclient (apt-get install smbclient)
* cifs-utils (apt-get install cifs-utils)
* rsync (apt-get install rsync)
* borgbackup (apt-get install borgbackup)

# FITXER RELACIONATS
--------------------

* /etc/ssh/sshd_config	-->	Configuració general del servidor ssh i del servidor sftp.
* /etc/fstab			--> Punts de muntatge automàtics.
* /etc/samba/smb.conf	--> Configuració general de samba.


# DESCRIPCIÓ
------------

Quan s'ha arribat a configurar un escenari totalment funcional, un punt a tenir en compte, molt important, és la integritat de les dades i la redundància d'aquestes.
Per a això, és convenient poder administrar-les de forma segura i remota amb protocols com l'sftp on de forma no gràfica i gràfica es poden moure d'un lloc cap a 
un altre de manera senzilla. Per guarantir la preservació de les dades és molt important fer backups, que a més, poden estar compartits en la xarxa amb altres equips.


# CONFIGURACIÓ SFTP
-------------------

El paquet a descarregar és l'ssh del costat del client és l'openssh-client i del costat del servidor és openssh-server respectivament.

Per engabiar a un usuari i permetre que només hi tiguin accés als seus recursos, és necessari canviar paràmetres del fitxer /etc/ssh/sshd_config.

Primer de tot, s'ha d'establir un criteri que en aquest cas es seguirà el de engaviar per grup d'usuari en comptes d'especificar usuari per usuari,
a més, s'ha d'especificar quin serà el directory a engaviar, que en asquest cas, s'ha engaviat el home de l'usuari:

	root@esclavo:~# cat /etc/ssh/sshd_config 
	.
	.
	.
	Match Group filetransfer
		ChrootDirectory %h
		AllowTcpForwarding no
		X11Forwarding no
		ForceCommand internal-sftp
	root@esclavo:~#

	NOTA: Per afegir un grup (groupadd filetransfer).

S'ha de canviar el subsistema que es farà servir amb aquest grup:

	root@esclavo:~# cat /etc/ssh/sshd_config 
	.
	.
	.
	# override default of no subsystems
	#Subsystem	sftp	/usr/lib/openssh/sftp-server
	Subsystem	sftp	internal-sftp
	.
	.
	.
	root@esclavo:~#

Els usuaris no poden accedir si no tenen directoris. Per exemple, s'han creat uns amb els permisos, grup i propietari següents:
	
	root@esclavo:~# ls -l /home
	total 32
	drwxr-xr-x 5 root    root     4096 mai  2 11:28 entel
	drwxr-xr-x 7 root    root     4096 mai  7 23:38 itiel
	drwxr-xr-x 2 itiel2  itiel2   4096 feb 17 13:53 itiel2
	drwx------ 2 root    root    16384 feb 14 18:41 lost+found
	drwxr-xr-x 2 paquito paquito  4096 mai  7 23:47 paquito
	root@esclavo:~#

	NOTA: Els usuaris engabiats, han de tenir els seus directoris amb propietari usuari, grup de root.

	root@esclavo:/home/entel# ls -l
	total 8
	drwxr-xr-x 2 entel filetransfer 4096 mai  2 11:28 docs
	drwxr-xr-x 2 entel filetransfer 4096 mai  2 11:28 public_html
	root@esclavo:/home/entel#

S'ha afegit seguretat amb certificats com es va especificar en la sessió 4 de la pràctica 1.

Comprovació de funcionament del servidor i client per comandes:

	itiel@X550JX:~$ sftp -i key entel@192.168.56.102
	Connected to 192.168.56.102.
	sftp> ls
	docs         public_html  
	sftp> version
	SFTP protocol version 3
	sftp>
	sftp> exit
	itiel@X550JX:~$


# MUNTATGE RECURS SFTP
----------------------

Per muntar un recurs sftp de forma manual és necessari instal·lar un paquet adicional (sshfs), per exemple per muntar l'usuari previament creat:

	itiel@X550JX:~$ sudo sshfs entel@192.168.56.102:/ test/
	The authenticity of host '192.168.56.102 (192.168.56.102)' can't be established.
	ECDSA key fingerprint is SHA256:Db6R4MvFo2ZnKue8YoriRJCRZPyliBmsPgSvyx5HnCM.
	Are you sure you want to continue connecting (yes/no)? yes
	entel@192.168.56.102's password: 
	itiel@X550JX:~$ cd test/
	itiel@X550JX:~/test$ ls
	docs  public_html
	itiel@X550JX:~/test$ cd ..
	itiel@X550JX:~$

Es pot muntar també amb certificat, de tal forma que es més segur i no es necessari introduir contrasenya:

	itiel@X550JX:~$ sudo sshfs -o IdentityFile=/home/itiel/key entel@192.168.56.102:/ test/
	itiel@X550JX:~$ ls test/
	docs  public_html
	itiel@X550JX:~$

Per automuntar cada cop que s'encén l'equip, s'ha de configurar en /etc/fstab:

	itiel@X550JX:~$ tail -n1 /etc/fstab
	entel@192.168.56.102:/ /home/itiel/test fuse.sshfs defaults,idmap=user,reconnect,_netdev,users,IdentityFile=/home/itiel/.ssh/id_rsa 0 0
	itiel@X550JX:~$
	
	On entel@192.168.56.102:/ és el directori a muntar, /home/itiel/test és on es muntarà, fuse.sshfs és el tipus de sistema de fitxers a fer sevir,
	defaults,idmap=user,reconnect,_netdev,users,IdentityFile=/home/itiel/.ssh/id_rsa són els paràmetres a tenir en compte:

	- idmap			-->	Munta la carpeta amb l'uid de l'usuari que ho executa.
	- reconnect		-->	Reconecta amb el servidor si es perd la connexió.
	- _netdev		-->	Preveu abans de muntar que hi hagi connexió.
	- users			--> Permet a qualsevol usuari muntar i desmuntar.
	- IdentityFile	--> Certificat privat que identifica a l'usuari.

En aquest escenari, només tindrà accés l'usuari Itiel, ni tan sols l'usuari root pot accedir:

	itiel@X550JX:~$ ls -l test/
	total 0
	itiel@X550JX:~$ mount test/
	itiel@X550JX:~$ ls -l test/
	total 8
	drwxr-xr-x 1 itiel avahi-autoipd 4096 may  7 22:53 docs
	drwxr-xr-x 1 itiel avahi-autoipd 4096 may  2 11:28 public_html
	itiel@X550JX:~$ ls -l
	total 196
	.
	.
	.
	drwxr-xr-x 1 itiel root   4096 may  2 11:28  test
	.
	.
	.
	itiel@X550JX:~$ sudo su
	root@X550JX:/home/itiel# cd test 
	bash: cd: test: Permiso denegado
	root@X550JX:/home/itiel# ls -l
	ls: no se puede acceder a 'test': Permiso denegado
	total 192
	.
	.
	.
	d????????? ? ?     ?         ?            ?  test
	.
	.
	.
	root@X550JX:/home/itiel# ls -l test 
	ls: no se puede acceder a 'test': Permiso denegado
	root@X550JX:/home/itiel#

	NOTA: La carpeta .ssh ha de tenir permisos 700, el certificat id_rsa 600 i l'id_rsa.pub 644.

Comprovació del funcionament des d'un client connectant-se al protocol sftp port 22:

	root@esclavo:~# tcpdump -i any -n dst host 192.168.56.104
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
	18:57:39.571513 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [S.], seq 3233614797, ack 1665355091, win 28960, options [mss 1460,sackOK,TS val 1800605 ecr 4294944910,nop,wscale 6], length 0
	18:57:39.572012 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [.], ack 41, win 453, options [nop,nop,TS val 1800605 ecr 4294944911], length 0
	18:57:39.577673 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 1:40, ack 41, win 453, options [nop,nop,TS val 1800607 ecr 4294944911], length 39
	18:57:39.578409 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 40:1120, ack 1473, win 498, options [nop,nop,TS val 1800607 ecr 4294944912], length 1080
	18:57:39.585060 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 1120:1540, ack 1521, win 498, options [nop,nop,TS val 1800608 ecr 4294944913], length 420
	18:57:41.644917 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [.], ack 1537, win 498, options [nop,nop,TS val 1801124 ecr 4294945419], length 0
	18:57:41.645414 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [.], ack 1581, win 498, options [nop,nop,TS val 1801124 ecr 4294945429], length 0
	18:57:41.645968 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 1540:1584, ack 1581, win 498, options [nop,nop,TS val 1801124 ecr 4294945429], length 44
	18:57:41.650000 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 1584:1636, ack 1649, win 498, options [nop,nop,TS val 1801124 ecr 4294945429], length 52
	18:57:43.985339 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 1636:1664, ack 1733, win 498, options [nop,nop,TS val 1801708 ecr 4294946011], length 28
	18:57:44.020655 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 1664:2164, ack 1845, win 498, options [nop,nop,TS val 1801717 ecr 4294946015], length 500
	18:57:44.061701 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 2164:2208, ack 1845, win 498, options [nop,nop,TS val 1801728 ecr 4294946034], length 44
	18:57:44.063474 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 2208:2280, ack 1965, win 498, options [nop,nop,TS val 1801728 ecr 4294946034], length 72
	18:57:44.066275 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 2280:2468, ack 2009, win 498, options [nop,nop,TS val 1801729 ecr 4294946034], length 188
	18:57:44.068769 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 2468:2536, ack 2061, win 498, options [nop,nop,TS val 1801729 ecr 4294946035], length 68
	18:57:44.284903 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 2468:2536, ack 2061, win 498, options [nop,nop,TS val 1801784 ecr 4294946035], length 68
	18:57:56.582282 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 2536:2612, ack 2129, win 498, options [nop,nop,TS val 1804858 ecr 4294949165], length 76
	18:57:59.702875 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 2612:2664, ack 2181, win 498, options [nop,nop,TS val 1805638 ecr 4294949946], length 52
	18:57:59.703967 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 2664:3820, ack 2233, win 498, options [nop,nop,TS val 1805638 ecr 4294949946], length 1156
	18:57:59.704776 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 3820:3888, ack 2285, win 498, options [nop,nop,TS val 1805638 ecr 4294949946], length 68
	18:57:59.705417 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 3888:3956, ack 2337, win 498, options [nop,nop,TS val 1805639 ecr 4294949946], length 68
	18:58:01.246679 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 3956:4032, ack 2389, win 498, options [nop,nop,TS val 1806024 ecr 4294950332], length 76
	18:58:01.247727 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 4032:4108, ack 2441, win 498, options [nop,nop,TS val 1806024 ecr 4294950332], length 76
	18:58:03.757117 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 4108:4176, ack 2509, win 498, options [nop,nop,TS val 1806651 ecr 4294950960], length 68
	18:58:06.379013 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 4176:4212, ack 2545, win 498, options [nop,nop,TS val 1807307 ecr 4294951615], length 36
	18:58:06.379382 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [P.], seq 4212:4300, ack 2545, win 498, options [nop,nop,TS val 1807307 ecr 4294951615], length 88
	18:58:06.383394 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [.], ack 2642, win 498, options [nop,nop,TS val 1807308 ecr 4294951617], length 0
	18:58:06.388595 IP 192.168.56.102.22 > 192.168.56.104.42266: Flags [F.], seq 4300, ack 2642, win 498, options [nop,nop,TS val 1807309 ecr 4294951617], length 0
	^C
	28 packets captured
	28 packets received by filter
	0 packets dropped by kernel
	root@esclavo:~# 


# COMPARTICIÓ D'UN RECURS SFTP
------------------------------

Per poder tenir un recurs compartit entre usuaris, s'hauria d'engabiar a un nivell on tots puguin veure les carpetes dels
altres usuaris, però, no accedir-hi a aquestes, excepte la compartida, és a dir, en comptes d'engabiar a nivell del home
absolut de l'usuari, es faría a un nivell més baix, és a dir, del /home quedant així:

	root@esclavo:~# cat /etc/ssh/sshd_config 
	.
	.
	.
	Match Group filetransfer
		ChrootDirectory /home
		AllowTcpForwarding no
		X11Forwarding no
		ForceCommand internal-sftp
	root@esclavo:~#


# CONFIGURACIÓ SMB
------------------

Primer serà necessari crear un directori compartit que es farà servir entre usuaris samba:

	root@esclavo:~# mkdir /samba
	root@esclavo:~# chown :sambashare /samba/
	root@esclavo:~#

És important diferenciar els usuaris de sistema dels que utilitza samba, ja que no són iguals. Per crear un usuari de samba,
en aquest cas es crearà l'usuari itielsmb:

	root@esclavo:~# useradd -M -d /samba/itielsmb -s /usr/sbin/nologin -G sambashare itielsmb
	root@esclavo:~#

	- Paràmetre -M indica que no es vol crear el home automàticament.
	- Paràmetre -d indica la ruta del home (s'ha de crear).
	- Paràmetre -s indica la shell que farà servir.
	- Paràmetre -G indica els grups als quals pertanyerà.

	root@esclavo:/samba# mkdir itielsmb
	root@esclavo:/samba# chown itielsmb:sambashare itielsmb/
	root@esclavo:/samba# ls -l
	total 4
	drwxr-xr-x 2 itielsmb sambashare 4096 mai  8 00:37 itielsmb
	root@esclavo:/samba#

És necessari activar el bit de setgid per a què quan un altre usuari afegeixi un nou fitxer aquest mantingui el el grup
sambashare:

	root@esclavo:/samba# chmod 2770 itielsmb/
	root@esclavo:/samba#

Per establir claus als usuaris s'ha de fer amb una comanda de samba i també s'han d'activar els usuaris:

	root@esclavo:/samba# smbpasswd -a itielsmb
	New SMB password:
	Retype new SMB password:
	Added user itielsmb.
	root@esclavo:/samba# smbpasswd -e itielsmb
	Enabled user itielsmb.
	root@esclavo:/samba#


# COMPARTICIÓ RECURSOS SMB
--------------------------

És important establir els permisos en 2770 (rwx rws ---) per poder mantindre el grup sambashare després de realitzar
canvis.
Per poder compartir recursos i ser visibles de cara als altres usuaris, s'ha d'especificar uns certs paràmetres en
el fitxer de configuració de l'smb (/etc/samba/smb.conf):

	root@esclavo:/samba# tail -n 15 /etc/samba/smb.conf 
	[users]
		path = /samba/users
		browseable = yes
		read only = no
		force create mode = 0660
		force directory mode = 2770
		valid users = @sambashare @sadmin

	[itielsmb]
		path = /samba/itielsmb
		browseable = no
		read only = no
		force create mode = 0660
		force directory mode = 2770
		valid users = itiel @sadmin
	root@esclavo:/samba#

On	-[<nom_recurs>] és el nom que es veurà quan es connecta l'usuari.
	- Path és la ruta de la carpeta compartida. 
	- Browseable vol dir que si pot ser trobada en la llista.
	- Read only vol dir que si poden escriure o no els usuaris vàlids.
	- Force create mode obliga a tenir els permissos indicats als fitxers nous (sería un equivalent a umask).
	- Force directory mode és igual que l'anterior però amb directoris.
	- Valid users indica els usuaris que tenen el permís d'accedir-hi al recurs compartit. Els grups s'indiquen amb @.

Cada cop que s'estableix un nou recurs compartit en la xarxa smb, s'ha de reinicialitzar el dimoni per a que
torni a carregar el fitxer de configuració:

	root@esclavo:/samba# systemctl restart nmbd
	root@esclavo:/samba#


# CLIENT I MUNTATGE SMB
-----------------------

Des del terminal es pot connectar amb el paquet smbclient especificat en el programari necessari:

	itiel@X550JX:~$ smbclient //192.168.56.102/itielsmb -U itielsmb
	Enter WORKGROUP\itielsmb's password: 
	Try "help" to get a list of possible commands.
	smb: \>
	itiel@X550JX:~$

També es pot muntar des de l'entorn gràfic d'Ubuntu, en aquest cas, s'ha fet servir la versió 18.04 LTS. Per connectar-se
s'ha d'obrir el gestor d'arxius i en el panell esquerre en "altres ubicacions" permet connectar-se a un servidor.
S'especificarà el protocol smb://x.x.x.x seguit de l'ip del servidor:

	smb://192.168.56.102

A continuació demanarà l'usuari, contrasenya i domini. Un cop validat, es mostrarà els recursos compartits.

Un altre forma de muntar el sistema de fitxers, és, en comptes de fer servir directament el protocol o bé l'entorn gràfic,
es pot incloure al sistema de fitxers que s'està fent servir com si d'una carpeta més es tractés, i per tant, es pot gestionar mitjançant
el terminal. Amb el mode gràfic s'aconsegueix el mateix efecte, però d'aquesta forma es guanya que es pot muntar des del terminal,
i com a conseqüència, també es podrà automàticament fent servir l'fstab.

Es necessari instal·lar el paquet cifs-utils.

Un cop instal·lat, per muntar el sistema de fitxers, amb la comanda mount i especificant el tipus:

	itiel@X550JX:~$ sudo mount -v -t cifs //192.168.56.102/users/ /home/itiel/test -o username=itielsmb,password=asd,domain=WORKGROUP,iocharset=utf8,rw,uid=itiel,gid=itiel
	mount.cifs kernel mount options: ip=192.168.56.102,unc=\\192.168.56.102\users,iocharset=utf8,uid=1000,gid=1000,user=itielsmb,domain=WORKGROUP,pass=********
	itiel@X550JX:~$	
	
	itiel@X550JX:~$ df -h
	S.ficheros             Tamaño Usados  Disp Uso% Montado en
	.
	.
	.
	//192.168.56.102/users   1,8G   1,5G  262M  86% /home/itiel/test
	itiel@X550JX:~$

	itiel@X550JX:~$ ls -l | grep test
	drwxr-xr-x 2 itiel itiel     0 may  8 01:35 test
	itiel@X550JX:~$

	itiel@X550JX:~/test$ touch myfile
	itiel@X550JX:~/test$ ls -l
	total 0
	drwxr-xr-x 2 itiel itiel 0 may  8 01:04 hello
	-rwxr-xr-x 1 itiel itiel 0 may  8 01:37 myfile
	itiel@X550JX:~/test$

Es pot automatitzar aquest procés en /etc/fstab com s'havia fet amb l'sftp. Primer que tot es crearà el fitxer amb les credencials necessaries i es protegiran:

	itiel@X550JX:~$ nano cifs.credentials
	itiel@X550JX:~$ chmod 600 cifs.credentials 
	itiel@X550JX:~$ ls -l | grep cifs.credentials
	-rw------- 1 root root      31 mai  8 01:43 cifs.credentials
	itiel@X550JX:~$ cat cifs.credentials 
	username=itielsmb
	password=asd
	itiel@X550JX:~$

	itiel@X550JX:~$ tail -n1 /etc/fstab 
	//192.168.56.102/users /home/itiel/test cifs defaults,credentials=/etc/cifs.credentials,_netdev,users,uid=itiel,gid=itiel 0 0
	itiel@X550JX:~$

	itiel@X550JX:~$ sudo mount test/
	itiel@X550JX:~$ ls -l | grep test
	drwxr-xr-x 2 itiel itiel     0 may  8 01:37  test
	itiel@X550JX:~$ ls -l test/
	total 0
	drwxr-xr-x 2 itiel itiel 0 may  8 01:04 hello
	-rwxr-xr-x 1 itiel itiel 0 may  8 01:37 myfile
	itiel@X550JX:~$

Comprovació del funcionament de smb en el port 445:

	root@esclavo:~# tcpdump -i any port 445
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
	18:43:19.856824 IP X550JX.36116 > 192.168.56.102.microsoft-ds: Flags [S], seq 425997339, win 29200, options [mss 1460,sackOK,TS val 3234584130 ecr 0,nop,wscale 7], length 0
	18:43:19.856877 IP 192.168.56.102.microsoft-ds > X550JX.36116: Flags [S.], seq 859842463, ack 425997340, win 28960, options [mss 1460,sackOK,TS val 1585676 ecr 3234584130,nop,wscale 6], length 0
	18:43:19.857029 IP X550JX.36116 > 192.168.56.102.microsoft-ds: Flags [.], ack 1, win 229, options [nop,nop,TS val 3234584130 ecr 1585676], length 0
	18:43:19.857054 IP X550JX.36116 > 192.168.56.102.microsoft-ds: Flags [P.], seq 1:217, ack 1, win 229, options [nop,nop,TS val 3234584130 ecr 1585676], length 216 SMB PACKET: SMBnegprot (REQUEST)

	18:43:19.857063 IP 192.168.56.102.microsoft-ds > X550JX.36116: Flags [.], ack 217, win 470, options [nop,nop,TS val 1585677 ecr 3234584130], length 0
	18:43:19.862993 IP 192.168.56.102.microsoft-ds > X550JX.36116: Flags [P.], seq 1:207, ack 217, win 470, options [nop,nop,TS val 1585678 ecr 3234584130], length 206 SMB-over-TCP packet:(raw data or continuation?)

	18:43:19.863086 IP X550JX.36116 > 192.168.56.102.microsoft-ds: Flags [.], ack 207, win 237, options [nop,nop,TS val 3234584136 ecr 1585678], length 0
	18:43:19.870805 IP 192.168.56.102.microsoft-ds > X550JX.36116: Flags [F.], seq 479, ack 404, win 486, options [nop,nop,TS val 1585680 ecr 3234584138], length 0
	18:43:19.870896 IP X550JX.36116 > 192.168.56.102.microsoft-ds: Flags [.], ack 480, win 245, options [nop,nop,TS val 3234584144 ecr 1585680], length 0
	18:43:37.557008 IP X550JX.36118 > 192.168.56.102.microsoft-ds: Flags [S], seq 1195233459, win 29200, options [mss 1460,sackOK,TS val 3234601830 ecr 0,nop,wscale 7], length 0
	18:43:37.557071 IP 192.168.56.102.microsoft-ds > X550JX.36118: Flags [S.], seq 2750520387, ack 1195233460, win 28960, options [mss 1460,sackOK,TS val 1590102 ecr 3234601830,nop,wscale 6], length 0
	18:43:37.557287 IP X550JX.36118 > 192.168.56.102.microsoft-ds: Flags [.], ack 1, win 229, options [nop,nop,TS val 3234601830 ecr 1590102], length 0
	18:43:37.557313 IP X550JX.36118 > 192.168.56.102.microsoft-ds: Flags [P.], seq 1:217, ack 1, win 229, options [nop,nop,TS val 3234601830 ecr 1590102], length 216 SMB PACKET: SMBnegprot (REQUEST)

	18:43:37.557322 IP 192.168.56.102.microsoft-ds > X550JX.36118: Flags [.], ack 217, win 470, options [nop,nop,TS val 1590102 ecr 3234601830], length 0
	18:43:37.568676 IP 192.168.56.102.microsoft-ds > X550JX.36118: Flags [P.], seq 1:207, ack 217, win 470, options [nop,nop,TS val 1590104 ecr 3234601830], length 206 SMB-over-TCP packet:(raw data or continuation?)

	18:43:37.568803 IP X550JX.36118 > 192.168.56.102.microsoft-ds: Flags [.], ack 207, win 237, options [nop,nop,TS val 3234601842 ecr 1590104], length 0
	18:43:37.568998 IP X550JX.36118 > 192.168.56.102.microsoft-ds: Flags [P.], seq 217:403, ack 207, win 237, options [nop,nop,TS val 3234601842 ecr 1590104], length 186 SMB-over-TCP packet:(raw data or continuation?)

	18:43:37.571912 IP 192.168.56.102.microsoft-ds > X550JX.36118: Flags [P.], seq 207:479, ack 403, win 486, options [nop,nop,TS val 1590105 ecr 3234601842], length 272 SMB-over-TCP packet:(raw data or continuation?)

	18:43:37.574247 IP X550JX.36118 > 192.168.56.102.microsoft-ds: Flags [P.], seq 403:569, ack 479, win 245, options [nop,nop,TS val 3234601847 ecr 1590105], length 166 SMB-over-TCP packet:(raw data or continuation?)

	18:43:37.576500 IP 192.168.56.102.microsoft-ds > X550JX.36118: Flags [P.], seq 479:720, ack 569, win 503, options [nop,nop,TS val 1590106 ecr 3234601847], length 241 SMB-over-TCP packet:(raw data or continuation?)

	18:43:37.579348 IP X550JX.36118 > 192.168.56.102.microsoft-ds: Flags [P.], seq 569:1101, ack 720, win 254, options [nop,nop,TS val 3234601852 ecr 1590106], length 532 SMB-over-TCP packet:(raw data or continuation?)

	18:43:37.580460 IP 192.168.56.102.microsoft-ds > X550JX.36118: Flags [P.], seq 720:797, ack 1101, win 520, options [nop,nop,TS val 1590107 ecr 3234601852], length 77 SMB-over-TCP packet:(raw data or continuation?)

	18:43:37.580643 IP X550JX.36118 > 192.168.56.102.microsoft-ds: Flags [F.], seq 1101, ack 797, win 254, options [nop,nop,TS val 3234601853 ecr 1590107], length 0
	18:43:37.585485 IP 192.168.56.102.microsoft-ds > X550JX.36118: Flags [F.], seq 797, ack 1102, win 520, options [nop,nop,TS val 1590109 ecr 3234601853], length 0
	18:43:37.585559 IP X550JX.36118 > 192.168.56.102.microsoft-ds: Flags [.], ack 798, win 254, options [nop,nop,TS val 3234601858 ecr 1590109], length 0
	18:43:44.998930 IP X550JX.36126 > 192.168.56.102.microsoft-ds: Flags [S], seq 3998321570, win 29200, options [mss 1460,sackOK,TS val 3234609272 ecr 0,nop,wscale 7], length 0
	18:43:44.998988 IP 192.168.56.102.microsoft-ds > X550JX.36126: Flags [S.], seq 2983410699, ack 3998321571, win 28960, options [mss 1460,sackOK,TS val 1591962 ecr 3234609272,nop,wscale 6], length 0
	18:43:44.999175 IP X550JX.36126 > 192.168.56.102.microsoft-ds: Flags [.], ack 1, win 229, options [nop,nop,TS val 3234609272 ecr 1591962], length 0
	18:43:44.999203 IP X550JX.36126 > 192.168.56.102.microsoft-ds: Flags [P.], seq 1:217, ack 1, win 229, options [nop,nop,TS val 3234609272 ecr 1591962], length 216 SMB PACKET: SMBnegprot (REQUEST)

	18:43:44.999213 IP 192.168.56.102.microsoft-ds > X550JX.36126: Flags [.], ack 217, win 470, options [nop,nop,TS val 1591962 ecr 3234609272], length 0
	18:43:45.005831 IP 192.168.56.102.microsoft-ds > X550JX.36126: Flags [P.], seq 1:207, ack 217, win 470, options [nop,nop,TS val 1591964 ecr 3234609272], length 206 SMB-over-TCP packet:(raw data or continuation?)

	18:43:45.005903 IP X550JX.36126 > 192.168.56.102.microsoft-ds: Flags [.], ack 207, win 237, options [nop,nop,TS val 3234609279 ecr 1591964], length 0
	18:43:45.005981 IP X550JX.36126 > 192.168.56.102.microsoft-ds: Flags [P.], seq 217:403, ack 207, win 237, options [nop,nop,TS val 3234609279 ecr 1591964], length 186 SMB-over-TCP packet:(raw data or continuation?)
	.
	.
	.
	18:43:54.876805 IP X550JX.36126 > 192.168.56.102.microsoft-ds: Flags [P.], seq 10176:10268, ack 13161, win 790, options [nop,nop,TS val 3234619150 ecr 1594431], length 92 SMB-over-TCP packet:(raw data or continuation?)

	18:43:54.877073 IP 192.168.56.102.microsoft-ds > X550JX.36126: Flags [P.], seq 13161:13289, ack 10268, win 771, options [nop,nop,TS val 1594432 ecr 3234619150], length 128 SMB-over-TCP packet:(raw data or continuation?)

	18:43:54.917483 IP X550JX.36126 > 192.168.56.102.microsoft-ds: Flags [.], ack 13289, win 798, options [nop,nop,TS val 3234619190 ecr 1594432], length 0
	^C
	209 packets captured
	212 packets received by filter
	3 packets dropped by kernel
	root@esclavo:~# 
 

# SEGURETAT
-----------

Es dedueix que la política per defecte es drop en input, les altres no perquè no és un router.

Per securitzar l'sftp, que en realitat es tracta del protocol SSH, amb capa de transport TCP pel port 22 (per defecte). 
Per habilitar les connexions entrants sense estat, es pot fer amb aquestes filter rule:
	
	$ iptables -A INPUT -p tcp --dport 22 -j ACCEPT
	# $ iptables -A OUPUT -p tcp --sport -j ACCEPT

Si es vol simplificar amb estats per a permetre només aquells paquets de sortida on estan lligats a una connexió oberta:

	$ iptables -A INPUT -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
	# $ iptables -A OUTPUT -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT

	NOTA: Les regles OUTPUT no són necessaries amb les deduccions que s'han fet per a aquest escenari.


Basant-se en la pràctica 2 en la sessió evaluable, com no és un router i es dedueix que el samba serà només per als equips interns
de la xarxa 10.10.4.0/28 i amb destinació el NAS amb ip 10.10.4.4, la política per defecte d'OUTPUT serà ACCEPT:

	$ iptables -A INPUT -p udp -m udp -d 10.10.4.4 -s 10.10.4.0/28 --dport 137 -j ACCEPT
	$ iptables-A INPUT -p udp -m udp -d 10.10.4.4 -s 10.10.4.0/28 --dport 138 -j ACCEPT
	$ iptables -A INPUT -m state --state NEW -m tcp -p tcp -d 10.10.4.4 -s 10.10.4.0/28 --dport 139 -j ACCEPT
	$ iptables -A INPUT -m state --state NEW -m tcp -p tcp -d 10.10.4.4 -s 10.10.4.0/28 --dport 445 -j ACCEPT

	root@esclavo:~# iptables -L -n
	Chain INPUT (policy DROP)
	target     prot opt source               destination         
	ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22 state NEW,ESTABLISHED
	ACCEPT     udp  --  10.10.4.0/28         10.10.4.4            udp dpt:137
	ACCEPT     tcp  --  10.10.4.0/28         10.10.4.4            state NEW tcp dpt:139
	ACCEPT     tcp  --  10.10.4.0/28         10.10.4.4            state NEW tcp dpt:445

	Chain FORWARD (policy ACCEPT)
	target     prot opt source               destination         

	Chain OUTPUT (policy ACCEPT)
	target     prot opt source               destination         
	root@esclavo:~#


# BACKUPS
---------

Les copies es fan en la mateixa màquina. Tindría més sentit fer-ho en el raid que serà la pròxima sessió.

Per fer servir l'eina borgbackup, primer s'ha de crear un repositori. En aquest escenari s'ha fet tot en la mateixa màquina:

	root@esclavo:/backups# borg init --encryption=repokey /backups/repository
	Enter new passphrase: 
	Enter same passphrase again: 
	Do you want your passphrase to be displayed for verification? [yN]: y
	Your passphrase (between double-quotes): "asd"
	Make sure the passphrase displayed above is exactly what you wanted.

	By default repositories initialized with this version will produce security
	errors if written to with an older version (up to and including Borg 1.0.8).

	If you want to use these older versions, you can disable the check by runnning:
	borg upgrade --disable-tam '/backups/repository'

	See https://borgbackup.readthedocs.io/en/stable/changes.html#pre-1-0-9-manifest-spoofing-vulnerability for details about the security implications.
	root@esclavo:/backups#

El programa ha creat una estructura de carpetes:

	root@esclavo:/backups# ls -l
	total 4
	drwx------ 3 root root 4096 mai  8 02:29 repository
	root@esclavo:/backups# cd repository/
	root@esclavo:/backups/repository# ls
	config	data  hints.0  index.0	README
	root@esclavo:/backups/repository# 

Per crear un nou backup, per exemple, del directori /home, s'ha d'indicar on està el repositori i amb quin nom es vol emmagatzemar la copia de seguretat:
	
	root@esclavo:/backups/repository# borg create /backups/repository::seax.backup1 /home/
	Enter passphrase for key /backups/repository: 
	root@esclavo:/backups/repository

A més es poden crear backups amb compressió, des de més lleugeres (més ràpides però amb factor de compressió més baix) a més potents (per defecte es fa servir lz4):

	$ borg create --compression <compressió>,<N> <repositori>::<nom_arxiu> <path_a_fer_backup>
	
	Compressió pot ser zlib, lzma o lz4. També es pot indicar que no es vol compressió (none).
	N és el nivell de compressió desitjat en un rang de menor a major on els valors van de 0 fins a 9, ambdos inclosos.

Es pot veure els backups realitzats al repositori i el contiguts d'aquestos:

	root@esclavo:~# borg list /backups/repository/
	Enter passphrase for key /backups/repository: 
	seax.backup1                         Wed, 2019-05-08 02:34:01
	seax.backup2                         Wed, 2019-05-08 02:36:09
	root@esclavo:~#

	root@esclavo:~# borg list /backups/repository::seax.backup1
	Enter passphrase for key /backups/repository: 
	drwxr-xr-x root   root          0 Tue, 2019-05-07 23:54:35 home
	drwxr-xr-x root   root          0 Tue, 2019-05-07 23:55:37 home/entel
	-rw------- entel  entel       168 Wed, 2019-05-08 00:08:58 home/entel/.bash_history
	-rw-r--r-- entel  entel       220 Thu, 2019-02-14 18:49:01 home/entel/.bash_logout
	-rw-r--r-- entel  entel      3526 Thu, 2019-02-14 18:49:01 home/entel/.bashrc
	-rw-r--r-- entel  entel       675 Thu, 2019-02-14 18:49:01 home/entel/.profile
	drwx------ entel  entel         0 Tue, 2019-05-07 22:35:02 home/entel/.ssh
	-rw------- entel  entel       394 Tue, 2019-05-07 22:35:02 home/entel/.ssh/authorized_keys
	lrwxrwxrwx root   filetransfer        0 Tue, 2019-05-07 23:55:37 home/entel/compartit -> ../shared
	drwxr-xr-x entel  filetransfer        0 Wed, 2019-05-08 00:08:46 home/entel/docs
	drwxr-xr-x entel  entel         0 Wed, 2019-05-08 00:08:46 home/entel/docs/carpeta
	drwxr-xr-x entel  filetransfer        0 Thu, 2019-05-02 11:28:49 home/entel/public_html
	drwxr-xr-x root   root          0 Wed, 2019-05-08 00:07:48 home/itiel
	-rw------- itiel  itiel       253 Tue, 2019-05-07 23:40:58 home/itiel/.bash_history
	-rw-r--r-- itiel  itiel       220 Sun, 2019-02-17 13:40:03 home/itiel/.bash_logout
	-rw-r--r-- itiel  itiel      3526 Sun, 2019-02-17 13:40:03 home/itiel/.bashrc
	-rw-r--r-- itiel  itiel       675 Sun, 2019-02-17 13:40:03 home/itiel/.profile
	drwxr-xr-x itiel  itiel         0 Mon, 2019-05-06 23:14:52 home/itiel/.ssh
	-rw-r--r-- itiel  itiel         0 Mon, 2019-05-06 23:14:52 home/itiel/.ssh/authorized_keys
	lrwxrwxrwx itiel  filetransfer        0 Tue, 2019-05-07 23:59:09 home/itiel/compartit -> /home/shared/
	drwxr-xr-x itiel  filetransfer        0 Tue, 2019-05-07 23:38:14 home/itiel/docs
	drwxr-xr-x itiel  filetransfer        0 Tue, 2019-05-07 23:37:30 home/itiel/folder
	drwxr-xr-x itiel  filetransfer        0 Wed, 2019-05-08 00:09:35 home/itiel/public_html
	lrwxrwxrwx root   root          0 Wed, 2019-05-08 00:09:35 home/itiel/public_html/testing -> /home/entel/docs/carpeta/
	lrwxrwxrwx itiel  filetransfer        0 Wed, 2019-05-08 00:07:48 home/itiel/testing -> /home/entel
	drwxr-xr-x itiel2 itiel2        0 Sun, 2019-02-17 13:53:21 home/itiel2
	-rw-r--r-- itiel2 itiel2      220 Sun, 2019-02-17 13:53:21 home/itiel2/.bash_logout
	-rw-r--r-- itiel2 itiel2     3526 Sun, 2019-02-17 13:53:21 home/itiel2/.bashrc
	-rw-r--r-- itiel2 itiel2      675 Sun, 2019-02-17 13:53:21 home/itiel2/.profile
	drwx------ root   root          0 Thu, 2019-02-14 18:41:16 home/lost+found
	drwxr-xr-x paquito paquito        0 Tue, 2019-05-07 23:47:07 home/paquito
	-rw------- paquito paquito        5 Tue, 2019-05-07 23:47:07 home/paquito/.bash_history
	-rw-r--r-- paquito paquito      220 Mon, 2019-05-06 17:17:49 home/paquito/.bash_logout
	-rw-r--r-- paquito paquito     3526 Mon, 2019-05-06 17:17:49 home/paquito/.bashrc
	-rw-r--r-- paquito paquito      675 Mon, 2019-05-06 17:17:49 home/paquito/.profile
	drwxrwxr-x itiel  filetransfer        0 Wed, 2019-05-08 00:04:11 home/shared
	lrwxrwxrwx root   root          0 Wed, 2019-05-08 00:04:11 home/shared/shared -> /home/shared/
	root@esclavo:~#

	root@esclavo:~# borg list /backups/repository::seax.backup2
	Enter passphrase for key /backups/repository: 
	.
	.
	.
	-rw-r--r-- root   root          0 Wed, 2019-05-08 02:36:03 home/file
	.
	.
	.
	root@esclavo:~#

Per restaurar una copia de seguretat es pot fer mitjantçant:

	root@esclavo:~# borg extract /backups/repository::seax.backup1
	Enter passphrase for key /backups/repository: 
	root@esclavo:~#

Per esborrar un backup que ja no es necessari:

	root@esclavo:/backups# borg delete repository::seax.backup1
	Enter passphrase for key /backups/repository: 
	root@esclavo:/backups# borg list /backups/repository/
	Enter passphrase for key /backups/repository: 
	seax.backup2                         Wed, 2019-05-08 02:36:09
	root@esclavo:/backups#

	NOTA: Si s'esborra un backup del qual depen un incremental, aquest no restaurarà correctament.

El mateix efecte es pot aconseguir amb rsync. És una eina molt potent que aprofitant els paràmetres adients es poden fer
backups incrementals i també de tipus snapshot. Un script que vaig fer per a l'assignatura ADSO:

	#!/bin/bash
	SOURCE_DIR="/home"
	DEST_DIR="/backups/backups-rsync"
	# excludes file: list of files to exclude
	EXCLUDES="/root/excludes.txt"
	# the name of the backup machine
	BSERVER="localhost"
	# the name of the incremental backups directory
	# put a date command for: year month day hour minute second
	BACKUP_DATE=`date +%y%m%d-%H%M%S` # options for rsync
	OPTS="--ignore-errors --delete-excluded --exclude-from=$EXCLUDES --delete --backup --backup-dir=$DEST_DIR/$BACKUP_DATE -av"
	# now the actual transfer
	#rsync $OPTS $SOURCE_DIR root@$BSERVER:$DEST_DIR/complet
	rsync $OPTS $SOURCE_DIR $DEST_DIR/complet

Comprovació de la comanda executant l'script:

	root@esclavo:~# ./rsync-script.sh 
	sending incremental file list
	created directory /backups/backups-rsync/complet
	(new) backup_dir is /backups/backups-rsync/190508-173635
	home/
	home/entel/
	home/entel/.bash_history
	home/entel/.bash_logout
	home/entel/.bashrc
	home/entel/.profile
	home/entel/compartit -> ../shared
	home/entel/.ssh/
	home/entel/.ssh/authorized_keys
	home/entel/docs/
	home/entel/docs/carpeta/
	home/entel/public_html/
	home/itiel/
	home/itiel/.bash_history
	home/itiel/.bash_logout
	home/itiel/.bashrc
	home/itiel/.profile
	home/itiel/compartit -> /home/shared/
	home/itiel/testing -> /home/entel
	home/itiel/.ssh/
	home/itiel/.ssh/authorized_keys
	home/itiel/docs/
	home/itiel/folder/
	home/itiel/public_html/
	home/itiel/public_html/testing -> /home/entel/docs/carpeta/
	home/itiel2/
	home/itiel2/.bash_logout
	home/itiel2/.bashrc
	home/itiel2/.profile
	home/lost+found/
	home/paquito/
	home/paquito/.bash_history
	home/paquito/.bash_logout
	home/paquito/.bashrc
	home/paquito/.profile
	home/shared/
	home/shared/shared -> /home/shared/

	sent 20,583 bytes  received 532 bytes  42,230.00 bytes/sec
	total size is 18,575  speedup is 0.88
	root@esclavo:~#


# AUTOMATITZACIÓ AMB CRON
-------------------------

* * * * * comanda a executar
- - - - -
| | | | |
| | | | +----- dia de la setmana (0 -6) (diumenge =0)
| | | +------- mes (1 -12)
| | +--------- dia del mes (1 -31)
| +----------- hora (0 -23)
+------------- minut (0 -59)

Per editar el nostre crontab només és necessari executar:

	$ crontab -e

Si és la primera vegada que s'executa, es veurà un arxiu en l'editor vi (o nano) amb una línia comentada. Per exemple, amb aquesta tasca:
        
	30 16 * * * rm /home/itiel/tmp/*

Aquesta línia indica que el contingut del directori /home/itiel/tmp/ serà esborrat tots els dies a les 16:30 PM.

Per saber les tasques que té el cron:

	$ crontab -l

L'opció -r remou l'arxiu crontab de l'usuari. 

	$ crontab -r

Típicament, el cron envia un email de notificació a l'usuari propietari del cron, això pot arribar a ser molest, sobretot si es té un cron que s'executa amb molta freqüència.
Per deshabilitar l'enviament de l'email s'ha de redirigir cap a >/dev/null 2>&1.

En aquest cas es podría automatitzar periodicament els scripts per fer backups.

Cada usuari del sistema posseeix un crontab personalitzat i només el root pot modificar el crontab d'un altre usuari. Si es desitja agregar un crontab és necessari primer 
fer login com aquest usuari.
Un usuari només pot fer ús de crontab si el seu nom apareix al fitxer /etc/cron.allow. Si l'arxiu no existeix l'usuari pot usar crontab llevat que el seu nom aparegui en /etc/cron.deny.


# Pràctica 3 - Sessió 2 - Crear un raid/cluster de discs en xarxa. (Luque Díaz Itiel)
-------------------------------------------------------------------------------------

# PROGRAMARI NECESSARI
----------------------

* Editor de textos (Gedit p.exemple)
* nano/pico (opcionalment)
* mdadm (apt-get install mdadm)
* zfs (apt-get install zfs-dkms)
* drbd (apt-get install drbd8-utils)

# FITXER RELACIONATS
--------------------

* /etc/ssh/sshd_config				-->	Configuració general del servidor ssh i del servidor sftp.
* /etc/fstab						--> Punts de muntatge automàtics.
* /etc/samba/smb.conf				--> Configuració general de samba.
* /etc/mdadm/mdadm.conf				-->	Declaració dels raids.
* /etc/modules						-->	Mòduls que carrega el kernel al arrencar la màquina.
* /etc/zfs/zed.d/zed.rc				--> Configuracions generals de zfs.
* /etc/drbd.d/global_common.conf	--> Configuració global de drbd.
* /etc/drbd.conf					--> Fitxers a carregar.


# DESCRIPCIÓ
------------

Sovint hi ha un gran flux de dades que s'emmagatzemen en el servidor nas, però, què passa si aquestes dades s'estan desant en un mateix disc? Pitjor encara,
que passa si aquest disc mor? Es interessant poder aprofitar la capacitat de tenir més discos i tractar-los com si d'un només es tractés. Això s'anomena RAID, i,
es pot mantindre un compromís entre guanyar més capacitat i velocitat o redundància de dades on s'hauría de sacrificar aquests dos beneficis.
 

# CREACIÓ D'UN RAID AMB MDADM
-----------------------------

Primer s'ha de crear l'array de discos (Multi Disk) amb la comanda:

	root@esclavo:~# mknod /dev/md0 b 9 0
	root@esclavo:~#

	- Paràmetre b: Crea un block buffered junt als valors "majors" i "minors".

	NOTA: El valor 9 és el màxim dels menors. El valor minor s'incrementa al mateix temps que número de "md". Ex: $ mknod /Dev/md1 b 9 1

Previament a fer l'array de discos (raid) és necessari particionar els discos. En aquest cas, s'ha creat una partició ocupant el màxim del
disc. Seguidament s'ha donat format en ext4.

Per fer un raid 0 on suma les capacitats dels dos discos assignats i per tant guanya en velocitat:

	root@esclavo:~# mdadm --create /dev/md0 --level=raid0 --raid-devices=2 /dev/sdb1 /dev/sdc1
	mdadm: Defaulting to version 1.2 metadata
	mdadm: array /dev/md0 started.
	root@esclavo:~#


Comprovació de l'stat del multi-disk (raid) en el sistema operatiu:

	root@esclavo:~# cat /proc/mdstat 
	Personalities : [linear] [multipath] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] 
	md0 : active raid0 sdc1[1] sdb1[0]
		  200704 blocks super 1.2 512k chunks
		  
	unused devices: <none>
	root@esclavo:~#

Ara queja donar-li un sistema de fitxer, per això cal formatejar:

	root@esclavo:~# mkfs.ext4 /dev/md0
	mke2fs 1.43.4 (31-Jan-2017)
	S'està creant un sistema de fitxers amb 200704 1k blocs i 50200 nodes-i
	UUID del sistema de fitxers=8af60877-4911-4915-a669-b632eaab3f89
	Còpies de seguretat del superbloc desades en els blocs: 
		8193, 24577, 40961, 57345, 73729

	S'assignen les taules de grup: fet                            
	Escriptura de les taules de nodes-i:fet                            
	Creació del registre de transaccions (4096 blocs): fet
	Escriptura de la informació dels superblocs i de comptabilitat del sistema de fitxers:fet  

	root@esclavo:~#

Per a què s'automunti al encendre la màquina és necessari indicar-ho en el /etc/fstab:

	root@esclavo:~# tail -n1 /etc/fstab 
	/dev/md0	/raid		ext4	defaults,user	10	2

Comprovació del muntatge:

	root@esclavo:~# mount /dev/md0 
	mount: /dev/md0 is already mounted or /raid busy
		   /dev/md0 is already mounted on /raid
	root@esclavo:~# df -h | grep md0
	/dev/md0        186M  1,6M   171M   1% /raid
	root@esclavo:~#

	NOTA: Es pot observar com s'han sumat les capacitats d'ambdós discos.

Es pot saber de forma detallada l'estat actual del raid, com saber els dispositius associats i la quantitat d'aquests, el nivell de raid, l'UUID, etc...

	root@esclavo:~# mdadm --query /dev/md0
	/dev/md0: 196.00MiB raid0 2 devices, 0 spares. Use mdadm --detail for more detail.
	root@esclavo:~#

	root@esclavo:~# mdadm --detail /dev/md0
	/dev/md0:
		    Version : 1.2
	  Creation Time : Thu May  9 11:49:34 2019
		 Raid Level : raid0
		 Array Size : 200704 (196.00 MiB 205.52 MB)
	   Raid Devices : 2
	  Total Devices : 2
		Persistence : Superblock is persistent

		Update Time : Thu May  9 11:49:34 2019
		      State : clean 
	 Active Devices : 2
	Working Devices : 2
	 Failed Devices : 0
	  Spare Devices : 0

		 Chunk Size : 512K

		       Name : esclavo:0  (local to host esclavo)
		       UUID : aee2c135:ccb842e3:9af4e737:3a8cac0a
		     Events : 0

		Number   Major   Minor   RaidDevice State
		   0       8       17        0      active sync   /dev/sdb1
		   1       8       33        1      active sync   /dev/sdc1
	root@esclavo:~#

IMPORTANT: Hi ha un bug amb el nom del multi-disk, al reinicialitzar canvia de /dev/md0 a /dev/md127 i de vegades a l'inversa. Per solucionar-ho i curar-se'n en salut,
aprofitarem l'UUID en el /etc/fstab que de segur mai fallarà:

	root@esclavo:~# blkid | grep md127
	/dev/md127: UUID="8af60877-4911-4915-a669-b632eaab3f89" TYPE="ext4"
	root@esclavo:~#

	root@esclavo:~# tail -n1 /etc/fstab 
	UUID=8af60877-4911-4915-a669-b632eaab3f89	/raid		ext4	defaults,user	10	2
	root@esclavo:~#

Creació d'un raid 1 després d'esborrar el raid0:

	root@esclavo:~# mdadm --create /dev/md0 --level=raid1 --raid-devices=2 /dev/sdb1 /dev/sdc1
	mdadm: Defaulting to version 1.2 metadata
	mdadm: array /dev/md0 started.
	root@esclavo:~#

Formateig del raid en extensió 4:

	root@esclavo:~# mkfs.ext4 /dev/md0
	mke2fs 1.43.4 (31-Jan-2017)
	S'està creant un sistema de fitxers amb 200704 1k blocs i 50200 nodes-i
	UUID del sistema de fitxers=3c13e52f-bc14-4734-9d5f-60597d0cae39
	Còpies de seguretat del superbloc desades en els blocs: 
		8193, 24577, 40961, 57345, 73729

	S'assignen les taules de grup: fet                            
	Escriptura de les taules de nodes-i:fet                            
	Creació del registre de transaccions (4096 blocs): fet
	Escriptura de la informació dels superblocs i de comptabilitat del sistema de fitxers:fet  

	root@esclavo:~#

S'ha d'actualitzar l'fstab per a quan es reinicialitzi l'equip continui muntant correctament el raid:

	root@esclavo:~# blkid /dev/md127
	/dev/md127: UUID="b8a7f0e1-c533-4dfa-bfc4-174c9930109f" TYPE="ext4"
	root@esclavo:~#

	root@esclavo:~# tail -n1 /etc/fstab 
	UUID=b8a7f0e1-c533-4dfa-bfc4-174c9930109f	/raid		ext4	defaults,user	10	2
	root@esclavo:~#

Comprovació del raid 1:

	root@esclavo:~# df -h | grep /dev/md127
	/dev/md127       92M  1,6M    84M   2% /raid
	root@esclavo:~#
	
	NOTA: L'espai és l'ho que ocupa un disc per separat, aquest raid és el "mirall".

	root@esclavo:~# cat /proc/mdstat 
	Personalities : [raid1] [linear] [multipath] [raid0] [raid6] [raid5] [raid4] [raid10] 
	md127 : active raid1 sdb1[0] sdc1[1]
		  101248 blocks super 1.2 [2/2] [UU]
		  
	unused devices: <none>
	root@esclavo:~#

Simulació de fallada en un dels discos de l'array:

	root@esclavo:~# mdadm --fail /dev/md127 /dev/sdb1
	mdadm: set /dev/sdb1 faulty in /dev/md127
	root@esclavo:~# 

	root@esclavo:~# cat /proc/mdstat 
	Personalities : [raid1] [linear] [multipath] [raid0] [raid6] [raid5] [raid4] [raid10] 
	md127 : active raid1 sdb1[0](F) sdc1[1]
		  101248 blocks super 1.2 [2/1] [_U]
		  
	unused devices: <none>
	root@esclavo:~# 

Eliminació del disc amb fallades:

	root@esclavo:/raid# mdadm --fail /dev/md127 /dev/sdb1
	mdadm: set /dev/sdb1 faulty in /dev/md127
	root@esclavo:/raid#

	root@esclavo:/raid# mdadm --manage /dev/md127 --remove /dev/sdb1
	mdadm: hot removed /dev/sdb1 from /dev/md127
	root@esclavo:/raid#

S'ha afegit un nou disc a l'array que aquest automàticament comença la sincronització per a recuperar les dades:

	root@esclavo:/raid# mdadm /dev/md127 --manage --add /dev/sde1
	mdadm: added /dev/sde1
	root@esclavo:/raid#

En la comprovació de l'estat del multi-disk es pot veure com està funcionant correctament:

	root@esclavo:/raid# cat /proc/mdstat 
	Personalities : [raid1] [linear] [multipath] [raid0] [raid6] [raid5] [raid4] [raid10] 
	md127 : active raid1 sde1[2] sdc1[1]
		  101248 blocks super 1.2 [2/2] [UU]
		  
	unused devices: <none>
	root@esclavo:/raid#

	NOTA: S'hauría de veure l'estat de recuperació, però, donat la velocitat del SSD en l'escenari, no permet visualitzar-ho.

Creació d'un raid 5 amb un mínim de tres discos, dos de dades i un de paritat:

	root@esclavo:~# mdadm --create /dev/md0 --level=raid5 --raid-devices=3 /dev/sdb1 /dev/sdc1 /dev/sdd1
	mdadm: Defaulting to version 1.2 metadata
	mdadm: array /dev/md0 started.
	root@esclavo:~#

Formateig del raid en extensió 4:

	root@esclavo:~# mkfs.ext4 /dev/md0
	mke2fs 1.43.4 (31-Jan-2017)
	S'està creant un sistema de fitxers amb 200704 1k blocs i 50200 nodes-i
	UUID del sistema de fitxers=3c13e52f-bc14-4734-9d5f-60597d0cae39
	Còpies de seguretat del superbloc desades en els blocs: 
		8193, 24577, 40961, 57345, 73729

	S'assignen les taules de grup: fet                            
	Escriptura de les taules de nodes-i:fet                            
	Creació del registre de transaccions (4096 blocs): fet
	Escriptura de la informació dels superblocs i de comptabilitat del sistema de fitxers:fet  

	root@esclavo:~#

Comprovació de l'estat del raid5 per assegurar-se'n de que estan tots els discos i figura com a tal:

	root@esclavo:~# cat /proc/mdstat 
	Personalities : [raid1] [linear] [multipath] [raid0] [raid6] [raid5] [raid4] [raid10] 
	md0 : active raid5 sdd1[3] sdc1[1] sdb1[0]
		  200704 blocks super 1.2 level 5, 512k chunk, algorithm 2 [3/3] [UUU]
		  
	unused devices: <none>
	root@esclavo:~#

Actualizació del fstab per el nou raid:

	root@esclavo:~# blkid | grep md0
	/dev/md0: UUID="3c13e52f-bc14-4734-9d5f-60597d0cae39" TYPE="ext4"
	root@esclavo:~#

	root@esclavo:~# tail -n1 /etc/fstab 
	UUID=3c13e52f-bc14-4734-9d5f-60597d0cae39	/raid		ext4	defaults,user	10	2
	root@esclavo:~#

Després de reiniciatlizar la màquina i d'automuntar-se el raid, s'ha comprovat que ho estigui realment:

	root@esclavo:~# df -h  | grep raid
	/dev/md127      186M  1,6M   171M   1% /raid
	root@esclavo:~#

Comprovació del raid després d'omplir-lo de dades perquè a continuació es procedirà a marcar un disc com a fallit i canviar-lo per un de nou:

	root@esclavo:/raid# mdadm --detail /dev/md127
	/dev/md127:
		    Version : 1.2
	  Creation Time : Sun May 12 12:38:08 2019
		 Raid Level : raid5
		 Array Size : 200704 (196.00 MiB 205.52 MB)
	  Used Dev Size : 100352 (98.00 MiB 102.76 MB)
	   Raid Devices : 3
	  Total Devices : 3
		Persistence : Superblock is persistent

		Update Time : Sun May 12 12:54:33 2019
		      State : clean 
	 Active Devices : 3
	Working Devices : 3
	 Failed Devices : 0
	  Spare Devices : 0

		     Layout : left-symmetric
		 Chunk Size : 512K

		       Name : esclavo:0  (local to host esclavo)
		       UUID : 091db981:5f9a56d8:7879818c:2a581191
		     Events : 42

		Number   Major   Minor   RaidDevice State
		   4       8       17        0      active sync   /dev/sdb1
		   1       8       33        1      active sync   /dev/sdc1
		   3       8       49        2      active sync   /dev/sdd1
	root@esclavo:/raid#

	NOTA: Es mostren tots el discos en estat actiu i sincronitzats. És bona senyal.

Indicació d'un disc fallit al raid i eliminació d'aquest:

	root@esclavo:/raid# mdadm --fail /dev/md127 /dev/sdb1
	mdadm: set /dev/sdb1 faulty in /dev/md127
	root@esclavo:/raid# 

	root@esclavo:/raid# mdadm --remove /dev/md127 /dev/sdb1
	mdadm: hot removed /dev/sdb1 from /dev/md127
	root@esclavo:/raid#

	root@esclavo:/raid# mdadm --detail /dev/md127
	/dev/md127:
		    Version : 1.2
	  Creation Time : Sun May 12 12:38:08 2019
		 Raid Level : raid5
		 Array Size : 200704 (196.00 MiB 205.52 MB)
	  Used Dev Size : 100352 (98.00 MiB 102.76 MB)
	   Raid Devices : 3
	  Total Devices : 2
		Persistence : Superblock is persistent

		Update Time : Sun May 12 12:57:27 2019
		      State : clean, degraded 
	 Active Devices : 2
	Working Devices : 2
	 Failed Devices : 0
	  Spare Devices : 0

		     Layout : left-symmetric
		 Chunk Size : 512K

		       Name : esclavo:0  (local to host esclavo)
		       UUID : 091db981:5f9a56d8:7879818c:2a581191
		     Events : 45

		Number   Major   Minor   RaidDevice State
		   -       0        0        0      removed
		   1       8       33        1      active sync   /dev/sdc1
		   3       8       49        2      active sync   /dev/sdd1
	root@esclavo:/raid#

	NOTA: Indica que un dels discos ha estat eliminat de l'array.

Substitució del disc "espatllat" i comprovació de la resincronització:

	root@esclavo:/raid# mdadm --add /dev/md127 /dev/sde1
	mdadm: added /dev/sde1
	root@esclavo:/raid#

	root@esclavo:/raid# mdadm --detail /dev/md127
	/dev/md127:
		    Version : 1.2
	  Creation Time : Sun May 12 12:38:08 2019
		 Raid Level : raid5
		 Array Size : 200704 (196.00 MiB 205.52 MB)
	  Used Dev Size : 100352 (98.00 MiB 102.76 MB)
	   Raid Devices : 3
	  Total Devices : 3
		Persistence : Superblock is persistent

		Update Time : Sun May 12 12:59:02 2019
		      State : clean 
	 Active Devices : 3
	Working Devices : 3
	 Failed Devices : 0
	  Spare Devices : 0

		     Layout : left-symmetric
		 Chunk Size : 512K

		       Name : esclavo:0  (local to host esclavo)
		       UUID : 091db981:5f9a56d8:7879818c:2a581191
		     Events : 64

		Number   Major   Minor   RaidDevice State
		   4       8       65        0      active sync   /dev/sde1
		   1       8       33        1      active sync   /dev/sdc1
		   3       8       49        2      active sync   /dev/sdd1
	root@esclavo:/raid#

	NOTA: Un altre cop més degut a la alta velocitat del SSD ha resincronitzat el raid molt ràpid.

S'han eliminat dos dels tres discos del raid 5 i aquest a mort. Cal reformar de nou el raid:

	root@esclavo:~# mdadm --stop /dev/md0
	mdadm: stopped /dev/md0
	root@esclavo:~#

	root@esclavo:~# mdadm --assemble /dev/sde1 /dev/sdd1
	mdadm: device /dev/sde1 exists but is not an md array.
	root@esclavo:~#

	root@esclavo:~# mdadm --misc --detail /dev/md0 
	/dev/md0:
		    Version : 1.2
		 Raid Level : raid0
	  Total Devices : 3
		Persistence : Superblock is persistent

		      State : inactive

		       Name : esclavo:0  (local to host esclavo)
		       UUID : 091db981:5f9a56d8:7879818c:2a581191
		     Events : 64

		Number   Major   Minor   RaidDevice

		   -       8       65        -        /dev/sde1
		   -       8       49        -        /dev/sdd1
		   -       8       33        -        /dev/sdc1
	root@esclavo:~#

	root@esclavo:~# mdadm -R /dev/md0
	root@esclavo:~# cat /proc/mdstat 
	Personalities : [linear] [multipath] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] 
	md0 : inactive sdd1[3]
		  100352 blocks super 1.2
		   
	unused devices: <none>
	root@esclavo:~# mdadm --misc --detail /dev/md0 
	/dev/md0:
		    Version : 1.2
	  Creation Time : Sun May 12 12:38:08 2019
		 Raid Level : raid5
	  Used Dev Size : 100352 (98.00 MiB 102.76 MB)
	   Raid Devices : 3
	  Total Devices : 1
		Persistence : Superblock is persistent

		Update Time : Sun May 12 13:03:31 2019
		      State : active, FAILED, Not Started 
	 Active Devices : 1
	Working Devices : 1
	 Failed Devices : 0
	  Spare Devices : 0

		     Layout : left-symmetric
		 Chunk Size : 512K

		       Name : esclavo:0  (local to host esclavo)
		       UUID : 091db981:5f9a56d8:7879818c:2a581191
		     Events : 74

		Number   Major   Minor   RaidDevice State
		   -       0        0        0      removed
		   -       0        0        1      removed
		   3       8       49        2      active sync   /dev/sdd1
	root@esclavo:~#

Per poder refer l'array es important aturar-lo primer, després és necessari forçar el ensamblatge:

	root@esclavo:~# mdadm --stop /dev/md127 
	mdadm: stopped /dev/md127
	root@esclavo:~# 

	root@esclavo:~# mdadm --assemble /dev/md127 /dev/sdd1 /dev/sdc1 /dev/sde1 --force
	mdadm: forcing event count in /dev/sdc1(1) from 66 upto 74
	mdadm: /dev/md127 has been started with 2 drives (out of 3).
	root@esclavo:~#

	root@esclavo:~# mdadm --misc --detail /dev/md127 
	/dev/md127:
		    Version : 1.2
	  Creation Time : Sun May 12 12:38:08 2019
		 Raid Level : raid5
		 Array Size : 200704 (196.00 MiB 205.52 MB)
	  Used Dev Size : 100352 (98.00 MiB 102.76 MB)
	   Raid Devices : 3
	  Total Devices : 2
		Persistence : Superblock is persistent

		Update Time : Sun May 12 13:42:46 2019
		      State : clean, degraded 
	 Active Devices : 2
	Working Devices : 2
	 Failed Devices : 0
	  Spare Devices : 0

		     Layout : left-symmetric
		 Chunk Size : 512K

		       Name : esclavo:0  (local to host esclavo)
		       UUID : 091db981:5f9a56d8:7879818c:2a581191
		     Events : 76

		Number   Major   Minor   RaidDevice State
		   -       0        0        0      removed
		   1       8       33        1      active sync   /dev/sdc1
		   3       8       49        2      active sync   /dev/sdd1
	root@esclavo:~#

	NOTA: Està net, pero amb una degradació que ha estat arrosegada del trencament d'aquest.

S'ha d'incloure el disc que no ha pogut ser afegit amb la comanda:
	
	root@esclavo:~# mdadm --add /dev/md127 /dev/sde1
	mdadm: added /dev/sde1
	root@esclavo:~#

Comprovació del raid després de forçar una recuperació:

	root@esclavo:~# cat /proc/mdstat 
	Personalities : [linear] [multipath] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] 
	md127 : active raid5 sde1[4] sdc1[1] sdd1[3]
		  200704 blocks super 1.2 level 5, 512k chunk, algorithm 2 [3/3] [UUU]
		  
	unused devices: <none>
	root@esclavo:~#

	root@esclavo:~# mdadm --misc --detail /dev/md127 
	/dev/md127:
		    Version : 1.2
	  Creation Time : Sun May 12 12:38:08 2019
		 Raid Level : raid5
		 Array Size : 200704 (196.00 MiB 205.52 MB)
	  Used Dev Size : 100352 (98.00 MiB 102.76 MB)
	   Raid Devices : 3
	  Total Devices : 3
		Persistence : Superblock is persistent

		Update Time : Sun May 12 13:43:12 2019
		      State : clean 
	 Active Devices : 3
	Working Devices : 3
	 Failed Devices : 0
	  Spare Devices : 0

		     Layout : left-symmetric
		 Chunk Size : 512K

		       Name : esclavo:0  (local to host esclavo)
		       UUID : 091db981:5f9a56d8:7879818c:2a581191
		     Events : 95

		Number   Major   Minor   RaidDevice State
		   4       8       65        0      active sync   /dev/sde1
		   1       8       33        1      active sync   /dev/sdc1
		   3       8       49        2      active sync   /dev/sdd1
	root@esclavo:~#

Creació d'un raid6, en aquest cas són necessaris com a mínim quatre discos, dos de dades i dos de paritat:

	root@esclavo:~# mdadm --create /dev/md0 --level=raid6 --raid-devices=4 /dev/sdb1 /dev/sdc1 /dev/sdd1 /dev/sde1
	mdadm: /dev/sdb1 appears to be part of a raid array:
		   level=raid5 devices=3 ctime=Sun May 12 12:38:08 2019
	Continue creating array? 
	Continue creating array? (y/n) y
	mdadm: Defaulting to version 1.2 metadata
	mdadm: array /dev/md0 started.
	root@esclavo:~#

	root@esclavo:~# mkfs.ext4 /dev/md0
	mke2fs 1.43.4 (31-Jan-2017)
	S'està creant un sistema de fitxers amb 200704 1k blocs i 50200 nodes-i
	UUID del sistema de fitxers=c328492b-7b73-479f-a4ae-03e6a89a4c46
	Còpies de seguretat del superbloc desades en els blocs: 
		8193, 24577, 40961, 57345, 73729

	S'assignen les taules de grup: fet                            
	Escriptura de les taules de nodes-i:fet                            
	Creació del registre de transaccions (4096 blocs): fet
	Escriptura de la informació dels superblocs i de comptabilitat del sistema de fitxers:fet  

	root@esclavo:~#

	root@esclavo:~# blkid | grep md0
	/dev/md0: UUID="c328492b-7b73-479f-a4ae-03e6a89a4c46" TYPE="ext4"
	root@esclavo:~#

	root@esclavo:~# tail -n1 /etc/fstab 
	UUID=c328492b-7b73-479f-a4ae-03e6a89a4c46	/raid		ext4	defaults,user	10	2
	root@esclavo:~#

	root@esclavo:~# cat /proc/mdstat 
	Personalities : [linear] [multipath] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] 
	md0 : active raid6 sde1[3] sdd1[2] sdc1[1] sdb1[0]
		  200704 blocks super 1.2 level 6, 512k chunk, algorithm 2 [4/4] [UUUU]
		  
	unused devices: <none>
	root@esclavo:~#

Després de reinicialitzar la màquina i d'automuntar-se el raid, es comprovarà que aquest estigui muntat correctament:

	root@esclavo:~# df -h | grep /raid
	/dev/md127      186M  1,6M   171M   1% /raid
	root@esclavo:~#

Preparació de la carpeta compartida de samba per a poder omplir el raid:

	root@esclavo:~# cd /raid/
	root@esclavo:~#

	root@esclavo:/raid# mkdir shared
	root@esclavo:/raid#

	root@esclavo:/raid# chown sadmin:sambashare shared/
	root@esclavo:/raid#

	root@esclavo:/raid# chmod 2770 shared/
	root@esclavo:/raid#

Demostració com el raid està omplert:

	root@esclavo:/raid/shared# ls -l
	total 174664
	-rw-rw-r-- 1 itielsmb sambashare 14535364 mar  1 19:35 Captures_Wireshark (10.ª copia).zip
	-rwxrw-r-- 1 itielsmb sambashare 11812864 mai 12 13:59 Captures_Wireshark (11.ª copia).zip
	-rwxrw-r-- 1 itielsmb sambashare  5865472 mai 12 13:59 Captures_Wireshark (12.ª copia).zip
	-rwxrw-r-- 1 itielsmb sambashare  1284160 mai 12 13:59 Captures_Wireshark (13.ª copia).zip
	-rwxrw-r-- 1 itielsmb sambashare        0 mai 12 13:59 Captures_Wireshark (14.ª copia).zip
	-rwxrw-r-- 1 itielsmb sambashare        0 mai 12 13:59 Captures_Wireshark (15.ª copia).zip
	-rwxrw-r-- 1 itielsmb sambashare        0 mai 12 13:59 Captures_Wireshark (16.ª copia).zip
	-rw-rw-r-- 1 itielsmb sambashare 14535364 mar  1 19:35 Captures_Wireshark (3.ª copia).zip
	-rw-rw-r-- 1 itielsmb sambashare 14535364 mar  1 19:35 Captures_Wireshark (4.ª copia).zip
	-rw-rw-r-- 1 itielsmb sambashare 14535364 mar  1 19:35 Captures_Wireshark (5.ª copia).zip
	-rw-rw-r-- 1 itielsmb sambashare 14535364 mar  1 19:35 Captures_Wireshark (6.ª copia).zip
	-rw-rw-r-- 1 itielsmb sambashare 14535364 mar  1 19:35 Captures_Wireshark (7.ª copia).zip
	-rw-rw-r-- 1 itielsmb sambashare 14535364 mar  1 19:35 Captures_Wireshark (8.ª copia).zip
	-rw-rw-r-- 1 itielsmb sambashare 14535364 mar  1 19:35 Captures_Wireshark (9.ª copia).zip
	-rw-rw-r-- 1 itielsmb sambashare 14535364 mar  1 19:35 Captures_Wireshark (copia).zip
	-rw-rw-r-- 1 itielsmb sambashare 14535364 mar  1 19:35 Captures_Wireshark (otra copia).zip
	-rw-rw-r-- 1 itielsmb sambashare 14535364 mar  1 19:35 Captures_Wireshark.zip
	root@esclavo:/raid/shared#

	root@esclavo:/raid/shared# df -h | grep raid
	/dev/md127      186M  173M      0 100% /raid
	root@esclavo:/raid/shared#

	NOTA: Totes les proves en l'escenari s'han fet del mateix mode, per no repetir s'explica només un cop, perquè són iguals.

Comprovació de l'estat del raid 6:

	root@esclavo:/raid/shared# mdadm --misc --detail /dev/md127 
	/dev/md127:
		    Version : 1.2
	  Creation Time : Sun May 12 13:52:45 2019
		 Raid Level : raid6
		 Array Size : 200704 (196.00 MiB 205.52 MB)
	  Used Dev Size : 100352 (98.00 MiB 102.76 MB)
	   Raid Devices : 4
	  Total Devices : 4
		Persistence : Superblock is persistent

		Update Time : Sun May 12 14:00:46 2019
		      State : clean 
	 Active Devices : 4
	Working Devices : 4
	 Failed Devices : 0
	  Spare Devices : 0

		     Layout : left-symmetric
		 Chunk Size : 512K

		       Name : esclavo:0  (local to host esclavo)
		       UUID : a979bb3d:9ca42b5d:0ddaf140:5fc0a95c
		     Events : 19

		Number   Major   Minor   RaidDevice State
		   0       8       17        0      active sync   /dev/sdb1
		   1       8       33        1      active sync   /dev/sdc1
		   2       8       49        2      active sync   /dev/sdd1
		   3       8       65        3      active sync   /dev/sde1
	root@esclavo:/raid/shared# 

Testeig del raid, marcament d'un raid com a fallit:

	root@esclavo:~# mdadm --fail /dev/md127 /dev/sdd1 
	mdadm: set /dev/sdd1 faulty in /dev/md127
	root@esclavo:~#

	root@esclavo:~# mdadm --misc --detail /dev/md127 
	/dev/md127:
		    Version : 1.2
	  Creation Time : Sun May 12 13:52:45 2019
		 Raid Level : raid6
		 Array Size : 200704 (196.00 MiB 205.52 MB)
	  Used Dev Size : 100352 (98.00 MiB 102.76 MB)
	   Raid Devices : 4
	  Total Devices : 4
		Persistence : Superblock is persistent

		Update Time : Sun May 12 14:05:37 2019
		      State : clean, degraded 
	 Active Devices : 3
	Working Devices : 3
	 Failed Devices : 1
	  Spare Devices : 0

		     Layout : left-symmetric
		 Chunk Size : 512K

		       Name : esclavo:0  (local to host esclavo)
		       UUID : a979bb3d:9ca42b5d:0ddaf140:5fc0a95c
		     Events : 25

		Number   Major   Minor   RaidDevice State
		   0       8       17        0      active sync   /dev/sdb1
		   1       8       33        1      active sync   /dev/sdc1
		   -       0        0        2      removed
		   3       8       65        3      active sync   /dev/sde1

		   2       8       49        -      faulty   /dev/sdd1
	root@esclavo:~#

Es torna a marcar un altre com a mort i es treuen de l'array:

	root@esclavo:~# mdadm --misc --detail /dev/md127 
	/dev/md127:
		    Version : 1.2
	  Creation Time : Sun May 12 13:52:45 2019
		 Raid Level : raid6
		 Array Size : 200704 (196.00 MiB 205.52 MB)
	  Used Dev Size : 100352 (98.00 MiB 102.76 MB)
	   Raid Devices : 4
	  Total Devices : 4
		Persistence : Superblock is persistent

		Update Time : Sun May 12 14:05:37 2019
		      State : clean, degraded 
	 Active Devices : 3
	Working Devices : 3
	 Failed Devices : 1
	  Spare Devices : 0

		     Layout : left-symmetric
		 Chunk Size : 512K

		       Name : esclavo:0  (local to host esclavo)
		       UUID : a979bb3d:9ca42b5d:0ddaf140:5fc0a95c
		     Events : 25

		Number   Major   Minor   RaidDevice State
		   0       8       17        0      active sync   /dev/sdb1
		   1       8       33        1      active sync   /dev/sdc1
		   -       0        0        2      removed
		   3       8       65        3      active sync   /dev/sde1

		   2       8       49        -      faulty   /dev/sdd1
	root@esclavo:~#

	root@esclavo:~# mdadm --misc --detail /dev/md127 
	/dev/md127:
		    Version : 1.2
	  Creation Time : Sun May 12 13:52:45 2019
		 Raid Level : raid6
		 Array Size : 200704 (196.00 MiB 205.52 MB)
	  Used Dev Size : 100352 (98.00 MiB 102.76 MB)
	   Raid Devices : 4
	  Total Devices : 4
		Persistence : Superblock is persistent

		Update Time : Sun May 12 14:08:55 2019
		      State : clean, degraded 
	 Active Devices : 2
	Working Devices : 2
	 Failed Devices : 2
	  Spare Devices : 0

		     Layout : left-symmetric
		 Chunk Size : 512K

		       Name : esclavo:0  (local to host esclavo)
		       UUID : a979bb3d:9ca42b5d:0ddaf140:5fc0a95c
		     Events : 27

		Number   Major   Minor   RaidDevice State
		   0       8       17        0      active sync   /dev/sdb1
		   -       0        0        1      removed
		   -       0        0        2      removed
		   3       8       65        3      active sync   /dev/sde1

		   1       8       33        -      faulty   /dev/sdc1
		   2       8       49        -      faulty   /dev/sdd1
	root@esclavo:~#

	root@esclavo:~# mdadm --remove /dev/md127 /dev/sdc1 
	mdadm: hot removed /dev/sdc1 from /dev/md127
	root@esclavo:~#

	root@esclavo:~# mdadm --remove /dev/md127 /dev/sdd1
	mdadm: hot removed /dev/sdd1 from /dev/md127
	root@esclavo:~#

	root@esclavo:~# mdadm --misc --detail /dev/md127 
	/dev/md127:
		    Version : 1.2
	  Creation Time : Sun May 12 13:52:45 2019
		 Raid Level : raid6
		 Array Size : 200704 (196.00 MiB 205.52 MB)
	  Used Dev Size : 100352 (98.00 MiB 102.76 MB)
	   Raid Devices : 4
	  Total Devices : 2
		Persistence : Superblock is persistent

		Update Time : Sun May 12 14:10:38 2019
		      State : clean, degraded 
	 Active Devices : 2
	Working Devices : 2
	 Failed Devices : 0
	  Spare Devices : 0

		     Layout : left-symmetric
		 Chunk Size : 512K

		       Name : esclavo:0  (local to host esclavo)
		       UUID : a979bb3d:9ca42b5d:0ddaf140:5fc0a95c
		     Events : 29

		Number   Major   Minor   RaidDevice State
		   0       8       17        0      active sync   /dev/sdb1
		   -       0        0        1      removed
		   -       0        0        2      removed
		   3       8       65        3      active sync   /dev/sde1
	root@esclavo:~#

S'afegirà un nou disc per tractar de recuperar el raid:

	root@esclavo:~# mdadm --add /dev/md127 /dev/sdf1
	mdadm: added /dev/sdf1
	root@esclavo:~#

	root@esclavo:~# mdadm --misc --detail /dev/md127 
	/dev/md127:
		    Version : 1.2
	  Creation Time : Sun May 12 13:52:45 2019
		 Raid Level : raid6
		 Array Size : 200704 (196.00 MiB 205.52 MB)
	  Used Dev Size : 100352 (98.00 MiB 102.76 MB)
	   Raid Devices : 4
	  Total Devices : 3
		Persistence : Superblock is persistent

		Update Time : Sun May 12 14:14:25 2019
		      State : clean, degraded 
	 Active Devices : 3
	Working Devices : 3
	 Failed Devices : 0
	  Spare Devices : 0

		     Layout : left-symmetric
		 Chunk Size : 512K

		       Name : esclavo:0  (local to host esclavo)
		       UUID : a979bb3d:9ca42b5d:0ddaf140:5fc0a95c
		     Events : 48

		Number   Major   Minor   RaidDevice State
		   0       8       17        0      active sync   /dev/sdb1
		   4       8       81        1      active sync   /dev/sdf1
		   -       0        0        2      removed
		   3       8       65        3      active sync   /dev/sde1
	root@esclavo:~#

	NOTA: Funciona tot correctament.

Es forçarà a que el raid mori matant 3 discos, d'aquesta forma quedarà inservible:

	root@esclavo:~# mdadm --fail /dev/md127 /dev/sdf1
	mdadm: set /dev/sdf1 faulty in /dev/md127
	root@esclavo:~#

	root@esclavo:~# mdadm --fail /dev/md127 /dev/sde1
	mdadm: set /dev/sde1 faulty in /dev/md127
	root@esclavo:~#

	root@esclavo:~# mdadm --remove /dev/md127 /dev/sdf1
	mdadm: hot removed /dev/sdf1 from /dev/md127
	root@esclavo:~#

	root@esclavo:~# mdadm --remove /dev/md127 /dev/sde1
	mdadm: hot removed /dev/sde1 from /dev/md127
	root@esclavo:~#

	root@esclavo:~# mdadm --misc --detail /dev/md127 
	/dev/md127:
		    Version : 1.2
	  Creation Time : Sun May 12 13:52:45 2019
		 Raid Level : raid6
		 Array Size : 200704 (196.00 MiB 205.52 MB)
	  Used Dev Size : 100352 (98.00 MiB 102.76 MB)
	   Raid Devices : 4
	  Total Devices : 1
		Persistence : Superblock is persistent

		Update Time : Sun May 12 14:18:01 2019
		      State : clean, FAILED 
	 Active Devices : 1
	Working Devices : 1
	 Failed Devices : 0
	  Spare Devices : 0

		     Layout : left-symmetric
		 Chunk Size : 512K

		       Name : esclavo:0  (local to host esclavo)
		       UUID : a979bb3d:9ca42b5d:0ddaf140:5fc0a95c
		     Events : 70

		Number   Major   Minor   RaidDevice State
		   0       8       17        0      active sync   /dev/sdb1
		   -       0        0        1      removed
		   -       0        0        2      removed
		   -       0        0        3      removed
	root@esclavo:~#

	NOTA: En aquest punt, l'estat del raid és fallit. No pot recuperar-se.

root@esclavo:~# mdadm --zero-superblock /dev/sde1
root@esclavo:~# mdadm --zero-superblock /dev/sdf1
root@esclavo:~# mdadm --zero-superblock /dev/sdc1
root@esclavo:~#

root@esclavo:~# mdadm --add /dev/md127 /dev/sde1
mdadm: /dev/md127 has failed so using --add cannot work and might destroy
mdadm: data on /dev/sde1.  You should stop the array and re-assemble it.
root@esclavo:~#


# ADMINISTRACIÓ D'UN RAID AMB MDADM
-----------------------------------

En el següent escenari, amb un raid 0 (suma de capacitats) s'ha tret un dels discos que el conforma i el sistema operatiu ha detecta que passa alguna cosa.
El sistema operatiu ha entrat en mode manteniment i requereix l'usuari root.

Amb la següent comanda, mostra quin és l'estat actual del raid:

	root@esclavo:~# cat /proc/mdstat 
	Personalities : [linear] [multipath] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] 
	md127 : inactive sdb1[1](S)
		  100352 blocks super 1.2
		   
	unused devices: <none>
	root@esclavo:~#

	NOTA: Està indicant que el disc sbd1 no està actiu en el dispositiu multi-disk.

Amb aquesta altra ens indica clarament que només hi ha un disc dels dos que hi hauría de tenir:

	root@esclavo:~# mdadm --misc --detail /dev/md127 
	/dev/md127:
		    Version : 1.2
		 Raid Level : raid0
	  Total Devices : 1
		Persistence : Superblock is persistent

		      State : inactive

		       Name : esclavo:0  (local to host esclavo)
		       UUID : aee2c135:ccb842e3:9af4e737:3a8cac0a
		     Events : 0

		Number   Major   Minor   RaidDevice

		   -       8       17        -        /dev/sdb1
	root@esclavo:~#

Per afegir un disc nou en comptes de l'anterior que "està espatllat", caldría incloure'l al raid:

	root@esclavo:~# mdadm /dev/md127 --manage --add /dev/sdc1
	mdadm: Cannot get array info for /dev/md127
	root@esclavo:~#

La comanda no pot trobar l'array perquè no està definit. Si forcem a reorganitzar l'array, retornarà aquest missatge:

	root@esclavo:~# mdadm --assemble /dev/md127 
	mdadm: /dev/md127 not identified in config file.
	root@esclavo:~#

S'ha de configurar previament en el fitxer /etc/mdadm/mdadm.conf

	root@esclavo:~# mdadm --detail --scan > /etc/mdadm/mdadm.conf 
	root@esclavo:~#

	root@esclavo:~# tail -n1 /etc/mdadm/mdadm.conf 
	ARRAY /dev/md/127 metadata=1.2 name=esclavo:0 UUID=aee2c135:ccb842e3:9af4e737:3a8cac0a
	root@esclavo:~#

Com es tracta del raid0 i aquest no té cap mena de redundància, no es possible tractar de recuperar/substituir el disc.
Per aquest motiu, una opció és refer l'array amb un nou disc.

Al tractar de crear-lo, el sistema detecta que ja existeix:

	root@esclavo:~# mdadm --create --verbose --assume-clean --level=raid0 --raid-devices=2 /dev/md127 /dev/sdc1 /dev/sdd1
	mdadm: chunk size defaults to 512K
	mdadm: /dev/md127 is already in use.
	root@esclavo:~#

Es necessari treure l'array fent:

	root@esclavo:~# mdadm --stop /dev/md127 
	mdadm: stopped /dev/md127
	root@esclavo:~#

En aquest punt, ja es pot crear de nou l'array amb el disc que habia sobreviscut:

	root@esclavo:~# mdadm --create --verbose --assume-clean --level=raid0 --raid-devices=2 /dev/md127 /dev/sdc1 /dev/sdd1
	mdadm: chunk size defaults to 512K
	mdadm: Defaulting to version 1.2 metadata
	mdadm: array /dev/md127 started.
	root@esclavo:~#

	root@esclavo:~# cat /proc/mdstat 
	Personalities : [linear] [multipath] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] 
	md127 : active raid0 sdd1[1] sdc1[0]
		  200704 blocks super 1.2 512k chunks
		  
	unused devices: <none>
	root@esclavo:~#

S'ha creat un nou array independent a l'anterior. L'anterior ha de ser esborrat perquè no es pot recuperar cap mena de dades
ja que el 50% d'aquestes han desaparegut.


# CREACIÓ D'UN RAID Z AMB ZFS
-----------------------------

Primerament s'ha d'instal·lar el paquet de zfs, que per fer-ho és necessari fer un seguit de passos previs.
Per començar, fa falta afegir els headers del kernel de linux:

	root@esclavo:~# apt-get install --yes dpkg-dev linux-headers-$(uname -r) linux-image-amd64
	Leyendo lista de paquetes... Hecho
	Creando árbol de dependencias       
	Leyendo la información de estado... Hecho
	dpkg-dev ya está en su versión más reciente (1.18.25).
	linux-headers-4.9.0-9-amd64 ya está en su versión más reciente (4.9.168-1).
	linux-image-amd64 ya está en su versión más reciente (4.9+80+deb9u7).
	0 actualizados, 0 nuevos se instalarán, 0 para eliminar y 8 no actualizados.
	root@esclavo:~#

	NOTA: Ja s'han instal·lat previament, aquesta captura és representativa.


Seguidament s'ha de modificar els sources list i afegir les fonts privades:

	root@esclavo:~# cat /etc/apt/sources.list
	# 

	# deb cdrom:[Debian GNU/Linux 9.6.0 _Stretch_ - Official amd64 NETINST 20181110-11:34]/ stretch main

	#deb cdrom:[Debian GNU/Linux 9.6.0 _Stretch_ - Official amd64 NETINST 20181110-11:34]/ stretch main

	deb http://ftp.es.debian.org/debian/ stretch main contrib non-free
	deb-src http://ftp.es.debian.org/debian/ stretch main

	deb http://security.debian.org/debian-security stretch/updates main
	deb-src http://security.debian.org/debian-security stretch/updates main

	# stretch-updates, previously known as 'volatile'
	deb http://ftp.es.debian.org/debian/ stretch-updates main contrib non-free
	deb-src http://ftp.es.debian.org/debian/ stretch-updates main
	root@esclavo:~#

En aquest punt ja es pot instal·lar el paquet:

	root@esclavo:~# apt-get install zfs-dkms
	Leyendo lista de paquetes... Hecho
	Creando árbol de dependencias       
	Leyendo la información de estado... Hecho
	zfs-dkms ya está en su versión más reciente (0.6.5.9-5).
	0 actualizados, 0 nuevos se instalarán, 0 para eliminar y 8 no actualizados.
	root@esclavo:~#

	NOTA: Ja s'havia instal·lat abans de fer la prova.

Per a que funcioni el mòdul cal carregar-lo i indicar que s'autocarregui al engegar la màquina:

	root@esclavo:~# modprobe zfs
	root@esclavo:~#

	root@esclavo:~# echo "zfs" >> /etc/modules
	root@esclavo:~#

	root@esclavo:~# lsmod | grep zfs
	zfs                  2707456  0
	zunicode              331776  1 zfs
	zavl                   16384  1 zfs
	zcommon                53248  1 zfs
	znvpair                90112  2 zcommon,zfs
	spl                    98304  3 znvpair,zcommon,zfs
	root@esclavo:~#

Per crear el raid Z amb zpool:

	root@esclavo:~# zpool create itiel raidz -m /raid /dev/sdb /dev/sdc /dev/sdd spare /dev/sde -f
	root@esclavo:~#

	NOTA: S'ha afegit un disc spare per poder fer les proves pertinents.

Comprovació de l'estat del raid Z:

	root@esclavo:~# df -h | grep /raid
	itiel            139M      0  139M   0% /raid
	root@esclavo:~#

	root@esclavo:~# zfs list
	NAME    USED  AVAIL  REFER  MOUNTPOINT
	itiel  83,9K   138M  24,0K  /raid
	root@esclavo:~#

	root@esclavo:~# zpool status
	  pool: itiel
	 state: ONLINE
	  scan: none requested
	config:

		NAME        STATE     READ WRITE CKSUM
		itiel       ONLINE       0     0     0
		  raidz1-0  ONLINE       0     0     0
			sdb     ONLINE       0     0     0
			sdc     ONLINE       0     0     0
			sdd     ONLINE       0     0     0
		spares
		  sde       AVAIL   

	errors: No known data errors
	root@esclavo:~#


# RECUPERACIÓ RAIDZ
-------------------

Simulació d'un dels discos danyats. A diferència de mdadm, aquest no té una comanda per esborrar el contigut de la partició. Comprovació de la partició conforme és part del raid Z:

	root@esclavo:/# fdisk /dev/sdb

	Bienvenido a fdisk (util-linux 2.29.2).
	Los cambios solo permanecerán en la memoria, hasta que decida escribirlos.
	Tenga cuidado antes de utilizar la orden de escritura.


	Orden (m para obtener ayuda): i
	Número de partición (1,9, valor predeterminado 9): 1

		     Device: /dev/sdb1
		      Start: 2048
		        End: 186367
		    Sectors: 184320
		       Size: 90M
		       Type: /usr de Solaris y ZFS de Apple
		  Type-UUID: 6A898CC3-1DD2-11B2-99A6-080020736631
		       UUID: B50FA690-A9A6-7C4F-A77E-3FF795A37092
		       Name: zfs-4ea28b5426bb4a5b

	Orden (m para obtener ayuda): d
	Número de partición (1,9, valor predeterminado 9): 1

	Se ha borrado la partición 1.

	Orden (m para obtener ayuda): n
	Número de partición (1-8,10-128, valor predeterminado 1): p
	El valor está fuera del rango.
	Número de partición (1-8,10-128, valor predeterminado 1): 1
	Primer sector (34-204766, valor predeterminado 2048): 
	Último sector, +sectores o +tamaño{K,M,G,T,P} (2048-186367, valor predeterminado 186367): 

	Crea una nueva partición 1 de tipo 'Linux filesystem' y de tamaño 90 MiB.
	Partición #1: contiene un zfs_member en la firma.

	¿Desea eliminar la firma? [S]í/[N]o: s

	La firma se borrará mediante una orden de escritura.

	Orden (m para obtener ayuda): i
	Número de partición (1,9, valor predeterminado 9): 1

		     Device: /dev/sdb1
		      Start: 2048
		        End: 186367
		    Sectors: 184320
		       Size: 90M
		       Type: Sistema de ficheros de Linux
		  Type-UUID: 0FC63DAF-8483-4772-8E79-3D69D8477DE4
		       UUID: A2F41004-D6D2-4686-8337-1CD4CBCE7703

	Orden (m para obtener ayuda): w
	Se ha modificado la tabla de particiones.
	Llamando a ioctl() para volver a leer la tabla de particiones.
	Fallo al leer de nuevo la tabla de particiones.: Dispositivo o recurso ocupado

	El núcleo todavía usa la tabla antigua. La nueva tabla se usará en el próximo reinicio o después de que usted ejecute partprobe(8) o kpartx(8).

	root@esclavo:/#

Després de forçar que el disc /dev/sdb es trenqués la partició fent un formateig, l'estat actual del raid és:

	root@esclavo:~# zpool status
	  pool: itiel
	 state: DEGRADED
	status: One or more devices could not be used because the label is missing or
		invalid.  Sufficient replicas exist for the pool to continue
		functioning in a degraded state.
	action: Replace the device using 'zpool replace'.
	   see: http://zfsonlinux.org/msg/ZFS-8000-4J
	  scan: none requested
	config:

		NAME                      STATE     READ WRITE CKSUM
		itiel                     DEGRADED     0     0     0
		  raidz1-0                DEGRADED     0     0     0
			17938557514020867377  UNAVAIL      0     0     0  was /dev/sdb1
			sdc                   ONLINE       0     0     0
			sdd                   ONLINE       0     0     0
		spares
		  sde                     AVAIL   

	errors: No known data errors
	root@esclavo:~# 

En aquest punt, s'ha d'afegir un nou disc reemplaçant al que està no disponible:

	root@esclavo:~# zpool replace -f itiel /dev/sdb1 /dev/sdf1
	root@esclavo:~#

	root@esclavo:~# zpool status
	  pool: itiel
	 state: ONLINE
	  scan: resilvered 69,4M in 0h0m with 0 errors on Mon May 13 19:01:04 2019
	config:

		NAME        STATE     READ WRITE CKSUM
		itiel       ONLINE       0     0     0
		  raidz1-0  ONLINE       0     0     0
			sdf1    ONLINE       0     0     0
			sdc     ONLINE       0     0     0
			sdd     ONLINE       0     0     0
		spares
		  sde       AVAIL   

	errors: No known data errors
	root@esclavo:~#
	
	NOTA: Ens indica que ha estat resincronitzat.

Per a què el disc spare entri automàticament en acció quan un cau com a fallit s'ha de configurar
el fitxer /etc/zfs/zed.d/zed.rc:

	root@esclavo:~# cat /etc/zfs/zed.d/zed.rc 
	.
	.
	.	
	##
	# Replace a device with a hot spare after N checksum errors are detected.
	# Disabled by default; uncomment to enable.
	#
	ZED_SPARE_ON_CHECKSUM_ERRORS=10

	##
	# Replace a device with a hot spare after N I/O errors are detected.
	# Disabled by default; uncomment to enable.
	#
	ZED_SPARE_ON_IO_ERRORS=1
	.
	.
	.
	root@esclavo:~#

També s'ha d'indicar que el raid faci autoreplace:

	root@esclavo:~# zpool set autoreplace=on itiel
	root@esclavo:~#

	root@esclavo:~# zpool get autoreplace itiel
	NAME   PROPERTY     VALUE    SOURCE
	itiel  autoreplace  on       local
	root@esclavo:~#

Després de provar, el servei ZFS està buguejat i no fa el canvi automàticament. S'ha de fer
manualment:

	root@esclavo:~# zpool replace -f itiel /dev/sdb1 /dev/sde
	root@esclavo:~#

	root@esclavo:~# zpool status
	  pool: itiel
	 state: DEGRADED
	status: One or more devices could not be used because the label is missing or
		invalid.  Sufficient replicas exist for the pool to continue
		functioning in a degraded state.
	action: Replace the device using 'zpool replace'.
	   see: http://zfsonlinux.org/msg/ZFS-8000-4J
	  scan: resilvered 49,5K in 0h0m with 0 errors on Mon May 13 19:47:44 2019
	config:

		NAME                        STATE     READ WRITE CKSUM
		itiel                       DEGRADED     0     0     0
		  raidz1-0                  DEGRADED     0     0     0
			spare-0                 UNAVAIL      0     0     0
			  12479254020888344351  UNAVAIL      0     0     0  was /dev/sdb1
			  sde                   ONLINE       0     0     0
			sdc                     ONLINE       0     0     0
			sdd                     ONLINE       0     0     0
		spares
		  sde                       INUSE     currently in use

	errors: No known data errors
	root@esclavo:~#


# CREACIÓ DE CLUSTER DE DISCOS AMB DRBD
---------------------------------------

Primer s'ha d'instal·lar el paquet gestor de drbd. Després s'ha de crear el fitxer de configuració
del disc que serà compartit.
Existeixen tres tipus de protocols de sincronització, el més utilitzat és el C.

protocol A: protocol de replicació asíncrona; sovint s’utilitza en escenaris de replicació de llarga distància.
Protocol B: Protocol de replicació semincrònic, protocol síncrona de memòria.
protocol C: comunament utilitzat per a nodes en xarxes de curta distància; és, amb diferència, el protocol de replicació
més utilitzat en configuracions DRBD. Protocol de replicació síncrona. Les operacions d’escriptura locals al node primari 
es consideren completades només després que s’hagin confirmat l’escriptura de disc local i remot. Com a resultat, es garanteix
que la pèrdua d'un sol node no suposa cap pèrdua de dades. La pèrdua de dades és, per descomptat, inevitable fins i tot amb aquest 
protocol de replicació si els dos nodes (o els seus subsistemes d’emmagatzematge) es destrueixen de manera irreversible 
al mateix temps.


Fitxer de configuració per al disc compartit. El recurs es diu raid i els nodes s'han de dir exactament com el hostname
de l'equip.

	root@esclavo1:~# cat /etc/drbd.d/raid.res 
	resource raid {
	  protocol C;
	  meta-disk internal;
	  device /dev/drbd1;
	  syncer {
	    verify-alg sha1;
	  }
	  net {
	    allow-two-primaries;
	  }
	  on esclavo1 {
	    disk /dev/sdb1;
	    address 192.168.56.113:7789;
	  }
	  on esclavo2 {
	    disk /dev/sdb1;
	    address 192.168.56.114:7789;
	  }
	}
	root@esclavo1:~#

Inicialització de les metadades als discos:
	
	root@esclavo1:~# drbdadm create-md raid
	md_offset 103804928
	al_offset 103772160
	bm_offset 103768064

	Found some data

	 ==> This might destroy existing data! <==

	Do you want to proceed?
	[need to type 'yes' to confirm] yes

	initializing activity log
	NOT initializing bitmap
	Writing meta data...
	New drbd meta data block successfully created.
	success
	root@esclavo1:~#

	root@esclavo1:~# drbd-overview
	 1:raid/0  Unconfigured . . 
	root@esclavo1:~#

	root@esclavo2:~# drbdadm create-md raid
	md_offset 103804928
	al_offset 103772160
	bm_offset 103768064

	Found some data

	 ==> This might destroy existing data! <==

	Do you want to proceed?
	[need to type 'yes' to confirm] yes

	initializing activity log
	NOT initializing bitmap
	Writing meta data...
	New drbd meta data block successfully created.
	success
	root@esclavo2:~#

Activació del recurs en ambdós costats:

	root@esclavo1:~# drbdadm up raid
	root@esclavo1:~# 

	root@esclavo1:~# cat /proc/drbd
	version: 8.4.7 (api:1/proto:86-101)
	srcversion: 7FA2FF168828B1B272D3F92 

	 1: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C r-----
		ns:0 nr:0 dw:0 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:101336
	root@esclavo1:~# 

	root@esclavo2:~# drbdadm up raid
	root@esclavo2:~#

	root@esclavo2:~# cat /proc/drbd
	version: 8.4.7 (api:1/proto:86-101)
	srcversion: 7FA2FF168828B1B272D3F92 

	 1: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C r-----
		ns:0 nr:0 dw:0 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:101336
	root@esclavo2:~#

Assignació de node primari al host "esclavo2":

	root@esclavo2:~# drbdadm -- --overwrite-data-of-peer primary raid
	root@esclavo2:~#

Vista de la sincronització entres el dos nodes:

	root@esclavo2:~# cat /proc/drbd 
	version: 8.4.7 (api:1/proto:86-101)
	srcversion: 7FA2FF168828B1B272D3F92 

	 1: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----
		ns:988 nr:0 dw:0 dr:988 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:100348
		[>....................] sync'ed:  4.0% (100348/101336)K
		finish: 0:01:23 speed: 988 (988) K/sec
	root@esclavo2:~# cat /proc/drbd 
	version: 8.4.7 (api:1/proto:86-101)
	srcversion: 7FA2FF168828B1B272D3F92 

	 1: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----
		ns:7224 nr:0 dw:0 dr:7224 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:94112
		[=>..................] sync'ed: 12.0% (94112/101336)K
		finish: 0:00:49 speed: 1,804 (1,804) K/sec
	root@esclavo2:~# cat /proc/drbd 
	version: 8.4.7 (api:1/proto:86-101)
	srcversion: 7FA2FF168828B1B272D3F92 

	 1: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----
		ns:16464 nr:0 dw:0 dr:16464 al:8 bm:0 lo:0 pe:2 ua:0 ap:0 ep:1 wo:f oos:85208
		[===>................] sync'ed: 20.0% (85208/101336)K
		finish: 0:00:31 speed: 2,688 (2,688) K/sec
	root@esclavo2:~# cat /proc/drbd 
	version: 8.4.7 (api:1/proto:86-101)
	srcversion: 7FA2FF168828B1B272D3F92 

	 1: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----
		ns:101336 nr:0 dw:0 dr:101336 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
	root@esclavo2:~#

	root@esclavo1:~# cat /proc/drbd 
	version: 8.4.7 (api:1/proto:86-101)
	srcversion: 7FA2FF168828B1B272D3F92 

	 1: cs:SyncTarget ro:Secondary/Primary ds:Inconsistent/UpToDate C r-----
		ns:0 nr:44016 dw:44016 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:57320
		[========>...........] sync'ed: 48.0% (57320/101336)K
		finish: 0:00:12 speed: 4,400 (4,400) want: 8,280 K/sec
	root@esclavo1:~# cat /proc/drbd 
	version: 8.4.7 (api:1/proto:86-101)
	srcversion: 7FA2FF168828B1B272D3F92 

	 1: cs:Connected ro:Secondary/Primary ds:UpToDate/UpToDate C r-----
		ns:0 nr:101336 dw:101336 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
	root@esclavo1:~#

Un cop s'ha fet la sincronització, el dispositiu /dev/drbd1 indicat en el fitxer de configuració, ja queda llest.
Només cal afegir un sistema de fitxers i muntar-lo:

	root@esclavo2:~# mkfs.ext4 /dev/drbd1
	mke2fs 1.43.4 (31-Jan-2017)
	Se está creando un sistema de ficheros con 101336 bloques de 1k y 25376 nodos-i
	UUID del sistema de ficheros: 60433608-2ef9-4b62-aaee-cd43d88b5737
	Respaldo del superbloque guardado en los bloques: 
		8193, 24577, 40961, 57345, 73729

	Reservando las tablas de grupo: hecho                           
	Escribiendo las tablas de nodos-i: hecho                           
	Creando el fichero de transacciones (4096 bloques): hecho
	Escribiendo superbloques y la información contable del sistema de ficheros:  0/1hecho

	root@esclavo2:~#

	NOTA: El format es fa en el node amb rol primary.

	root@esclavo2:~# mount /dev/drbd1 /raid/
	root@esclavo2:~#

	root@esclavo2:~# df -h | grep /raid
	/dev/drbd1        92M   1,6M   84M   2% /raid
	root@esclavo2:~#

Si s'intenta muntar el disc en el node esclau no deixa i ens avisa de la següent manera:

	root@esclavo1:~# mount /dev/drbd1 /raid
	mount: /dev/drbd1 está protegido contra escritura; se monta como sólo lectura
	mount: el montaje de /dev/drbd1 en /raid falló: Tipo de medio erróneo
	root@esclavo1:~#

	root@esclavo1:~# mount /dev/sdb1 /raid
	mount: tipo de sistema de ficheros 'drbd' desconocido
	root@esclavo1:~#

Per canviar el rol és tan senzill com desmuntar el disc en el node "esclavo2" i invertir els rols:

	$ drbdadm secondary raid
	$ drbdadm primary raid
	$ mount /dev/drbd1 <punt_de_muntatge>


# RECUPERACIÓ CLUSTER DE DISCOS
-------------------------------

Es forçarà a que el disc primari deixi de funcionar i es partirà d'aquest punt per a començar la reparació:

	root@esclavo2:~# df -h | grep /raid
	/dev/drbd1        92M   1,6M   84M   2% /raid
	root@esclavo2:~#

	root@esclavo2:~# fdisk /dev/sdb

	Bienvenido a fdisk (util-linux 2.29.2).
	Los cambios solo permanecerán en la memoria, hasta que decida escribirlos.
	Tenga cuidado antes de utilizar la orden de escritura.


	Orden (m para obtener ayuda): d
	Se ha seleccionado la partición 1
	Se ha borrado la partición 1.

	Orden (m para obtener ayuda): w
	Se ha modificado la tabla de particiones.
	Llamando a ioctl() para volver a leer la tabla de particiones.
	Fallo al leer de nuevo la tabla de particiones.: Dispositivo o recurso ocupado

	El núcleo todavía usa la tabla antigua. La nueva tabla se usará en el próximo reinicio o después de que usted ejecute partprobe(8) o kpartx(8).

	root@esclavo2:~#

Després de reinicialitzar la màquina, aquest és l'estat del disc que estava com a primari:

	root@esclavo2:~# cat /proc/drbd 
	version: 8.4.7 (api:1/proto:86-101)
	srcversion: 7FA2FF168828B1B272D3F92 

	 1: cs:Connected ro:Secondary/Secondary ds:Diskless/UpToDate C r-----
		ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
	root@esclavo2:~#

Com a conseqüència, el dispositiu ha estat danyat i no s'ha pogut muntar:

	root@esclavo2:~# df -h | grep raid
	root@esclavo2:~#

Per tant, cal inserir un nou disc amb la nomenclatura especificada a l'arxiu de configuració raid.res i donar-li format:

	root@esclavo2:~# fdisk /dev/sdb 

	Bienvenido a fdisk (util-linux 2.29.2).
	Los cambios solo permanecerán en la memoria, hasta que decida escribirlos.
	Tenga cuidado antes de utilizar la orden de escritura.


	Orden (m para obtener ayuda): n
	Tipo de partición
	   p   primaria (0 primaria(s), 0 extendida(s), 4 libre(s))
	   e   extendida (contenedor para particiones lógicas)
	Seleccionar (valor predeterminado p): p
	Número de partición (1-4, valor predeterminado 1): 
	Primer sector (2048-204799, valor predeterminado 2048): 
	Último sector, +sectores o +tamaño{K,M,G,T,P} (2048-204799, valor predeterminado 204799): 

	Crea una nueva partición 1 de tipo 'Linux' y de tamaño 99 MiB.
	Partición #1: contiene un drbd en la firma.

	¿Desea eliminar la firma? [S]í/[N]o: s

	La firma se borrará mediante una orden de escritura.

	Orden (m para obtener ayuda): w
	Se ha modificado la tabla de particiones.
	Llamando a ioctl() para volver a leer la tabla de particiones.
	Se están sincronizando los discos.

	root@esclavo2:~#

Es torna a muntar el raid amb el disc ja en marxa:

	root@esclavo2:~# drbdadm create-md raid
	md_offset 103804928
	al_offset 103772160
	bm_offset 103768064

	Found some data

	 ==> This might destroy existing data! <==

	Do you want to proceed?
	[need to type 'yes' to confirm] yes

	initializing activity log
	NOT initializing bitmap
	Writing meta data...
	New drbd meta data block successfully created.
	success
	root@esclavo2:~#

I es pot indicar si no està aixecat, que en aquest cas ja ho estava i retorna un missatge d'error:

	root@esclavo2:~# drbdadm up raid
	raid: Failure: (102) Local address(port) already in use.
	Command 'drbdsetup-84 connect raid ipv4:192.168.56.114:7789 ipv4:192.168.56.113:7789 --protocol=C --verify-alg=sha1 --allow-two-primaries=yes' terminated with exit code 10
	root@esclavo2:~#

Finalment, si s'observa l'estat actual d'aquest, es pot comprovar com passat un cert temps ja està sincronitzat i funcionant:

	root@esclavo2:~# cat /proc/drbd
	version: 8.4.7 (api:1/proto:86-101)
	srcversion: 7FA2FF168828B1B272D3F92 

	 1: cs:Connected ro:Secondary/Primary ds:UpToDate/UpToDate C r-----
		ns:0 nr:101336 dw:101336 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
	root@esclavo2:~#
	
	root@esclavo2:~# drbd-overview
	 1:raid/0  Connected Secondary/Primary UpToDate/UpToDate 
	root@esclavo2:~#

Comprovació del funcionament en "esclavo1" amb el cluster muntat i amb un FS ext4:

	root@esclavo1:~# ls /raid/
	lost+found  myfile
	root@esclavo1:~#

Si es tornen a repetir les passes anteriors, però, ara "esclavo2" passarà a ser el màster un altre cop:

	root@esclavo2:~# drbd-overview
	 1:raid/0  Connected Secondary/Primary UpToDate/UpToDate 
	root@esclavo2:~# cat /proc/drbd
	version: 8.4.7 (api:1/proto:86-101)
	srcversion: 7FA2FF168828B1B272D3F92 

	 1: cs:WFConnection ro:Secondary/Unknown ds:UpToDate/DUnknown C r-----
		ns:0 nr:101345 dw:101345 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
	root@esclavo2:~#

	root@esclavo2:~# drbdadm primary raid
	root@esclavo2:~#

	root@esclavo2:~# mount /dev/drbd1 /raid
	root@esclavo2:~#

	root@esclavo2:~# cd /raid/
	root@esclavo2:~#

	root@esclavo2:/raid# ls -l
	total 13
	drwx------ 2 root root 12288 may 15 18:08 lost+found
	-rw-r--r-- 1 root root    48 may 15 18:14 myfile
	root@esclavo2:/raid#

	root@esclavo2:/raid# cat myfile 
	askldjaslñkjdhlakjsdhlkajhsdkjhasdkjlaskdhashd
	root@esclavo2:/raid#

Després d'afegir de nou el disc i crear la partició necessària, s'ha tornat a afegir les metadades a aquesta:

	root@esclavo1:~# drbdadm up raid
	No valid meta data found
	Command 'drbdmeta 1 v08 /dev/sdb1 internal apply-al' terminated with exit code 255
	root@esclavo1:~# drbdadm create-md raid
	md_offset 103804928
	al_offset 103772160
	bm_offset 103768064

	Found some data

	 ==> This might destroy existing data! <==

	Do you want to proceed?
	[need to type 'yes' to confirm] yes

	initializing activity log
	NOT initializing bitmap
	Writing meta data...
	New drbd meta data block successfully created.
	success
	root@esclavo1:~#

	root@esclavo1:~# drbd-overview
	 1:raid/0  SyncTarget Secondary/Primary Inconsistent/UpToDate 
		[>....................] sync'ed:  4.0% (99232/101336)K          
	root@esclavo1:~# 

	root@esclavo1:~# drbd-overview
	 1:raid/0  Connected Secondary/Primary UpToDate/UpToDate 
	root@esclavo1:~#	


# COMPARTICIÓ RAID SMB
----------------------

Abans de començar l'estructura de directoris a compartir, es convenient assignar el punt de muntatge al grup al qual se li vol
compartir.

	root@esclavo:/# chown :sambashare raid
	root@esclavo:/# ls -l | grep raid
	drwxr-xr-x   4 root sambashare  1024 mai 11 13:50 raid
	root@esclavo:/# 
	
	NOTA: El grup es manté després de reinicialitzar la màquina.

Primer de tot, es crearà un directori específic per al raid i s'establiran els permisos adients:

	root@esclavo:/raid# mkdir shared
	root@esclavo:/raid#

	root@esclavo:/raid# chown sadmin:sambashare shared/
	root@esclavo:/raid#

	root@esclavo:/raid# chmod 2770 shared/
	root@esclavo:/raid#

	root@esclavo:/raid# ls -l
	total 13
	drwx------ 2 root   root       12288 mai  9 11:52 lost+found
	drwxrws--- 2 sadmin sambashare  1024 mai 11 13:52 shared
	root@esclavo:/raid#

	NOTA: Se li ha assignat a l'usuari administrador del samba que es va crear amb el grup que comparteixen tots els usuaris de samba.

Un cop creat el directori, s'ha d'indicar al dimoni samba que ha de compartir-lo:

	root@esclavo:~# tail -n7 /etc/samba/smb.conf
	[raid]
	    path = /raid/shared
	    browseable = yes
	    read only = no
	    force create mode = 0660
	    force directory mode = 2770
	    valid users = @sambashare @sadmin
	root@esclavo:~#

És molt important recarregar els fitxers de configuració, per a això, es pot fer un reload o un restart en el seu defecte:

	root@esclavo:~# service smbd restart 
	root@esclavo:~#

Prova des d'un client amb el smbclient que funcioni tot correctament:

	itiel@X550JX:~$ smbclient //192.168.56.102/raid -U itielsmb
	WARNING: The "syslog" option is deprecated
	Enter WORKGROUP\itielsmb's password: 
	Try "help" to get a list of possible commands.
	smb: \> ls
	  .                                   D        0  Sat May 11 14:06:25 2019
	  ..                                  D        0  Sat May 11 13:50:03 2019

			190264 blocks of size 1024. 174664 blocks available
	smb: \> put ficherin 
	putting file ficherin as \ficherin (4,9 kb/s) (average 4,9 kb/s)
	smb: \> ls
	  .                                   D        0  Sat May 11 14:08:49 2019
	  ..                                  D        0  Sat May 11 13:50:03 2019
	  ficherin                            A       15  Sat May 11 14:08:49 2019

			190264 blocks of size 1024. 174663 blocks available
	smb: \> 
	itiel@X550JX:~$

Comprovació des del servidor que els permissos estiguin correctes i que existeixi el fitxer "ficherin":

	root@esclavo:/raid/shared# ls -l
	total 1
	-rwxrw-r-- 1 itielsmb sambashare 15 mai 11 14:08 ficherin
	root@esclavo:/raid/shared#

	NOTA: Els permissos són els que s'esperaven i el propietari usuari/grup també.

Tots els raids, sigui quin sigui el seu nivell, es comparteixen del mateix mode, de cara a l'usuari és transparent i de cara a
l'administrador és un dispositiu més que tan sols s'ha d'afegir o en el seu defecte, si es modifica el raid i es manté amb el mateix
UUID, continuarà sent igual. 
També és comparteix de igual mode amb zfs, és un punt de muntatge que en aquest cas se li ha creat la carpeta shared amb les passes
anteriors i ha funcionat igual. També passa l'ho mateix amb drbd, compartint la carpeta shared amb les propietats necessàries situada 
al punt de muntatge /raid definit en el fitxer de configuració de smb.conf, funciona correctament.


# SEGURETAT
-----------

Configuració iptables per a compartir els recursos per samba en el node primary (esclavo2):

	iptables -A INPUT -p udp -m udp -d 192.168.56.114 -s 192.168.56.113 --dport 137 -j ACCEPT
	iptables-A INPUT -p udp -m udp -d 192.168.56.114 -s 192.168.56.113 --dport 138 -j ACCEPT
	iptables -A INPUT -m state --state NEW -m tcp -p tcp -d 192.168.56.114 -s 192.168.56.113 --dport 139 -j ACCEPT
	iptables -A INPUT -m state --state NEW -m tcp -p tcp -d 192.168.56.114 -s 192.168.56.113 --dport 445 -j ACCEPT

Configuració drbd node "esclavo1":

	iptables -A INPUT -m state --state ESTABLISHED -j ACCEPT
	iptables -A INPUT -p tcp -s 192.168.56.114 --dport 7789 -j ACCEPT

	iptables -A OUTPUT -m state --state ESTABLISHED -j ACCEPT
	iptables -A OUTPUT -p tcp -d 192.168.56.114 --dport 7789 -j ACCEPT

Configuració drbd node "esclavo2":

	iptables -A INPUT -m state --state ESTABLISHED -j ACCEPT
	iptables -A INPUT -p tcp -s 192.168.56.113 --dport 7789 -j ACCEPT

	iptables -A OUTPUT -m state --state ESTABLISHED -j ACCEPT
	iptables -A OUTPUT -p tcp -d 192.168.56.113 --dport 7789 -j ACCEPT


Pràctica 3 - Sessió 3 - Serveis sobre HTTP i HTTPS. (Luque Díaz Itiel)
----------------------------------------------------------------------

# PROGRAMARI NECESSARI
----------------------

* Editor de textos (Gedit p.exemple)
* nano/pico (opcionalment)
* apache2 (apt-get install apache2)
* mòdul php (apt-get install lib-mod-php7.0)
* cadaver (apt-get install cadaver)


# FITXER RELACIONATS
--------------------

* /etc/hosts										-->	Caché local (DNS LOCAL) en màquina real.
* /etc/apache2/sites-available/000-default.conf		--> Host virtual per al protocol http (port 80).
* /etc/apache2/sites-available/default-ssl.conf		--> Host virtual per al protocol https (port 443).
* /etc/apache2/ports.conf							--> Ports pels que escolta el daemon.
* /etc/webmin/miniserv.conf							--> Configuració del servidor webmin.


# COMANDES APACHE2
------------------

* a2{en/dis}site		--> Habilita o deshabilita un host virtual (site).
* a2{en/dis}mod			--> Habilita o deshabilita un mòdul de apache2.
* apachectl configtest	-->	Comprova la sintaxis dels arxius de configuració (sites/vhosts).


# CONSIDERACIONS
----------------

- En aquesta pràctica, en comptes de fer servir un DNS per a resoldre la IP, s'ha fet servir la caché local /etc/hosts.
- La URI es diferenciada pel protocol HTTP/HTTPS en la directiva Host. Apache2 determina a quin vhost ha d'anar el client gràcies a aquesta.


# DESCRIPCIÓ
------------

Amb la web 2.0 ha arribat un punt en què el ser humà està acostumat a fer-ho tot mitjançant navegadors que están a l'abast de qualsevol
persona, des de cerca informació, fer una comanda en una botiga, reservar lloc en el cinema, compartir experiències amb altres persones
fins a administrar serveis d'una forma còmoda.
Per garantir aquestes transaccions, lliures de persones malicioses, és necessari emprar seguretat en aquestes.
Administrar un servei amb la web 2.0 és fàcil, segur, escal·lable, fàcil de gestionar i multiplataforma.
 

# CONFIGURACIÓ D'UN VIRTUALHOST APACHE2
---------------------------------------

Per configurar un virtualhost nou, es pot començar copiant la plantilla que porta per defecte apache2:

	root@esclavo1:/etc/apache2/sites-available# cp 000-default.conf entel.com.conf
	root@esclavo1:/etc/apache2/sites-available#
	
	NOTA: És extremadament important que l'extensió del fitxer sigui .conf.

S'ha de distingir dos coses importants:

	1. La URI que identificarà aquest lloc virtual en la directiva ServerName.
	2. On estarà situat el lloc web a nivell intern del servidor web en la directiva DocumentRoot.

	root@esclavo1:/etc/apache2/sites-available# cat entel.com | grep -v "#"
	<VirtualHost *:80>
		ServerName entel.com

		ServerAdmin webmaster@localhost
		DocumentRoot /var/www/entel.com


		ErrorLog ${APACHE_LOG_DIR}/error.log
		CustomLog ${APACHE_LOG_DIR}/access.log combined

			        
	</VirtualHost>

	root@esclavo1:/etc/apache2/sites-available#

Com a opcional, es pot modificar també el port. En aquest cas, el vhost està escoltant en el 80 i per totes les xarxes.
En cas de modificar el port i incloure un de nou, s'ha d'afegir en el fitxer de configuració:

	root@esclavo1:/etc/apache2# cat ports.conf 
	# If you just change the port or add more ports here, you will likely also
	# have to change the VirtualHost statement in
	# /etc/apache2/sites-enabled/000-default.conf

	Listen 80
	Listen 8080

	<IfModule ssl_module>
		Listen 443
	</IfModule>

	<IfModule mod_gnutls.c>
		Listen 443
	</IfModule>

	# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
	root@esclavo1:/etc/apache2#

	NOTA: En aquest cas, s'ha afegit el port 8080. Per a que fos efectiu per a un vhost, s'hauría de canviar en <VirtualHost *:80
		  per <VirtualHost *:8080>.

Un cop està configurat el host, s'ha d'activar aquest:

	root@esclavo1:/etc/apache2/sites-available# a2ensite entel.com.conf 
	Enabling site entel.com.
	To activate the new configuration, you need to run:
	  systemctl reload apache2
	root@esclavo1:/etc/apache2/sites-available#

	root@esclavo1:/etc/apache2/sites-available# systemctl reload apache2
	root@esclavo1:/etc/apache2/sites-available#

S'ha de crear el DocumentRoot especificat en el fitxer de configuració del lloc virtual:

	root@esclavo1:/var/www# ls -l | grep entel.com
	drwxr-xr-x 2 root     www-data 4096 may 16 10:15 entel.com
	root@esclavo1:/var/www#

Es satisfarà un dels requeriments de la pràctica que es crear un recurs php que digui l'ip amb que es connecta l'usuari:

	root@esclavo1:/var/www/entel.com# ls
	index.php
	root@esclavo1:/var/www/entel.com#

	root@esclavo1:/var/www/entel.com# cat index.php 
	<?php echo $_SERVER['REMOTE_ADDR']; ?>

	root@esclavo1:/var/www/entel.com#

Comprovació del funcionament des de la màquina real:

	itiel@X550JX:~$ wget entel.com
	--2019-05-17 18:12:13--  http://entel.com/
	Resolviendo entel.com (entel.com)... 192.168.56.113
	Conectando con entel.com (entel.com)[192.168.56.113]:80... conectado.
	Petición HTTP enviada, esperando respuesta... 200 OK
	Longitud: 13 [text/html]
	Guardando como: “index.html”

	index.html          100%[===================>]      13  --.-KB/s    en 0s      

	2019-05-17 18:12:13 (2,03 MB/s) - “index.html” guardado [13/13]

	itiel@X550JX:~$

	itiel@X550JX:~$ cat index.html 
	192.168.56.1
	itiel@X550JX:~$

	NOTA: Es pot observar que està funcionant correctament el mòdul php i està retornant l'ip de l'usuari.

Demostració de l'ip amb la que accedeix al recurs:

	itiel@X550JX:~$ ip a | grep vboxnet | grep inet
    inet 192.168.56.1/24 brd 192.168.56.255 scope global vboxnet0
	itiel@X550JX:~$

	NOTA: Es troba a la mateixa xarxa, en aquest cas, és una xarxa interna amb la màquina física, no fa servir
		  cap tipus de NAT.


# CONFIGURACIÓ VIRTUALHOST SEGUR (SSL) APACHE2
----------------------------------------------

Cal activar el mòdul SSL primerament:

	root@esclavo1:~# a2enmod ssl
	Considering dependency setenvif for ssl:
	Module setenvif already enabled
	Considering dependency mime for ssl:
	Module mime already enabled
	Considering dependency socache_shmcb for ssl:
	Module socache_shmcb already enabled
	Enabling module ssl.
	See /usr/share/doc/apache2/README.Debian.gz on how to configure SSL and create self-signed certificates.
	To activate the new configuration, you need to run:
	  systemctl restart apache2
	root@esclavo1:~#

També és necessari carregar el vhost amb les directives del mòdul SSL que porta apache2 per defecte:

	root@esclavo1:~# a2ensite default-ssl.conf 
	Enabling site default-ssl.
	To activate the new configuration, you need to run:
	  systemctl reload apache2
	root@esclavo1:~#

És important reinicialitzar després d'habilitar aquesta configuració:

	root@esclavo1:~# systemctl reload apache2
	root@esclavo1:~#

Comprovació del funcionament del protocol HTTP amb la capa segura SSL (HTTPS):

	itiel@X550JX:~$ wget https://192.168.56.113/test.php
	--2019-05-17 18:21:58--  https://192.168.56.113/test.php
	Conectando con 192.168.56.113:443... conectado.
	ERROR: no se puede verificar el certificado de 192.168.56.113, emitido por “CN=esclavo1”:
	  Se encontró un certificado autofirmado.
		ERROR: el nombre común “esclavo1” del certificado no encaja con el nombre de equipo “192.168.56.113” solicitado.
	Para conectar inseguramente a 192.168.56.113, use `--no-check-certificate'.
	itiel@X550JX:~$	

Es queixa per diferents casuístiques, entre aquestes, perquè és un certificat que ha firmat el propi sistema operatiu
durant la instal·lació d'aquest, també perquè no és el mateix hostname respecte el que es va possar quan es va crear
el certificat, s'ha canviat durant el transcurs de les diferents pràctiques. Caldría tornar a crear-lo. En tot cas, 
igorant l'output, aquest és el resultat:

	itiel@X550JX:~$ wget https://192.168.56.113/test.php --no-check-certificate
	--2019-05-17 18:23:26--  https://192.168.56.113/test.php
	Conectando con 192.168.56.113:443... conectado.
	AVISO: no se puede verificar el certificado de 192.168.56.113, emitido por “CN=esclavo1”:
	  Se encontró un certificado autofirmado.
		AVISO: el nombre común “esclavo1” del certificado no encaja con el nombre de equipo “192.168.56.113” solicitado.
	Petición HTTP enviada, esperando respuesta... 200 OK
	Longitud: 42 [text/html]
	Guardando como: “test.php”

	test.php            100%[===================>]      42  --.-KB/s    en 0s      

	2019-05-17 18:23:26 (7,60 MB/s) - “test.php” guardado [42/42]

	itiel@X550JX:~$

	itiel@X550JX:~$ cat test.php
	192.168.56.1
	<br/>Your ip is: 192.168.56.1
	itiel@X550JX:~$

Ara que ja es sap que funciona tot correctament, es pot afegir seguretat al vhost d'entel.com, copiant les directives SSL
a aquest:

	root@esclavo1:/etc/apache2/sites-available# cat default-ssl.conf | grep -v "#" > ssl.entel.com.conf
	root@esclavo1:/etc/apache2/sites-available#

	root@esclavo1:/etc/apache2/sites-available# cat ssl.entel.com.conf 
	<IfModule mod_ssl.c>
		<VirtualHost _default_:443>
			ServerAdmin webmaster@localhost
			ServerName entel.com
			DocumentRoot /var/www/entel.com

			ErrorLog ${APACHE_LOG_DIR}/error.log
			CustomLog ${APACHE_LOG_DIR}/access.log combined

			SSLEngine on

			SSLCertificateFile	/etc/ssl/certs/ssl-cert-snakeoil.pem
			SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key


			<FilesMatch "\.(cgi|shtml|phtml|php)$">
					SSLOptions +StdEnvVars
			</FilesMatch>
			<Directory /usr/lib/cgi-bin>
					SSLOptions +StdEnvVars
			</Directory>

		</VirtualHost>
	</IfModule>

	root@esclavo1:/etc/apache2/sites-available#

	root@esclavo1:/etc/apache2/sites-available# a2ensite ssl.entel.com.conf 
	Enabling site ssl.entel.com.
	To activate the new configuration, you need to run:
	  systemctl reload apache2
	root@esclavo1:/etc/apache2/sites-available#

	root@esclavo1:/etc/apache2/sites-available# systemctl reload apache2
	root@esclavo1:/etc/apache2/sites-available#

En aquest punt, el vhost entel.com ja està funcionant per protocol no segur (http). Es comprovarà si funciona per protocol segur (https):

	itiel@X550JX:~$ wget https://entel.com --no-check-certificate
	--2019-05-17 18:30:12--  https://entel.com/
	Resolviendo entel.com (entel.com)... 192.168.56.113
	Conectando con entel.com (entel.com)[192.168.56.113]:443... conectado.
	AVISO: no se puede verificar el certificado de entel.com, emitido por “CN=esclavo1”:
	  Se encontró un certificado autofirmado.
	AVISO: ningún nombre de sujeto alternativo del certificado encaja con
		el nombre de equipo “entel.com” solicitado.
	Petición HTTP enviada, esperando respuesta... 200 OK
	Longitud: 13 [text/html]
	Guardando como: “index.html.1”

	index.html.1                                   100%[=================================================================================================>]      13  --.-KB/s    en 0s      

	2019-05-17 18:30:12 (2,74 MB/s) - “index.html.1” guardado [13/13]

	itiel@X550JX:~$ 

	itiel@X550JX:~$ cat index.html.1 
	192.168.56.1
	itiel@X550JX:~$

NOTA: També es podría haver fusionat els dos vhosts en el mateix. Però, per poder fer-lo més mantenible en el temps, és millor tenir-los separats.


# CONFIGURACIÓ WEBDAV APACHE2
-----------------------------

Primer s'ha d'activar els mòduls adients per al webdav:

	root@esclavo1:/etc/apache2/sites-available# a2enmod dav*
	Module dav already enabled
	Considering dependency dav for dav_fs:
	Module dav already enabled
	Enabling module dav_fs.
	Enabling module dav_lock.
	To activate the new configuration, you need to run:
	  systemctl restart apache2
	root@esclavo1:/etc/apache2/sites-available#

S'han d'incloure les diferents directives que fan referència al protocol DAV. Es farà sobre el vhost per defecte:

	root@esclavo1:/etc/apache2/sites-available# cat 000-default.conf | grep -v "#"
	<VirtualHost *:80>

		ServerAdmin webmaster@localhost
		DocumentRoot /var/www/html


		ErrorLog ${APACHE_LOG_DIR}/error.log
		CustomLog ${APACHE_LOG_DIR}/access.log combined

		
		Alias /webdav /var/www/webdav
		    
		<Directory /var/www/webdav>
			Options Includes FollowSymlinks MultiViews
		            Options indexes MultiViews
			Options +Indexes
		            AllowOverride all
		            Order allow,deny
			Allow from all
		    </Directory>
		
		<Location /webdav>
				DAV On
				Options None
				AuthType Basic
				AuthName webdav
				AuthUserFile /etc/apache2/.htpasswd
				Require valid-user
			Options Includes FollowSymlinks MultiViews
			Options +Indexes
		            AllowOverride all
		            Order allow,deny
			Allow from all
		</Location>
		
	</VirtualHost>

	root@esclavo1:/etc/apache2/sites-available#
	
	NOTA1: S'ha fet servir un Alias per a quan s'accedeixi al recurs /webdav aquest vagi a trobar-se en el directori /var/www/webdav.
		   Les directives noves són les de les etiquetes Location, les Directory es comenten en la següent nota.

	NOTA2: Per poder llistar per http/https, cal ficar les opcions Options +Indexes, etc. En la etiqueta Location i no en Directory.
		  S'han deixat per evitar qualsevol tipus de problema, però, en tot cas, les ignora l'apache.

S'ha d'afegir un usuari per autenticar-se'n al protocol DAV, que, en aquest cas, s'està separant el login d'usuaris de sistema
amb els de DAV. Es podría fer servir altres mòduls per a autenticar-se amb usuaris de sistema.
Per afegir un nou usuari:

	root@esclavo1:/etc/apache2# htpasswd /etc/apache2/.htpasswd itielweb
	New password: 
	Re-type new password: 
	Adding password for user itielweb
	root@esclavo1:/etc/apache2#

Cal crear l'estructura de carpetes que s'ha indicat previament en el fitxer de configuració del vhost:

	root@esclavo1:/var/www# ls -l | grep webdav
	drwxr-xr-x 3 root     www-data 4096 may 16 12:49 webdav
	root@esclavo1:/var/www#

Cal reinicialitzar el demoni:
	root@esclavo1:/var/www# systemctl reload apache2
	root@esclavo1:/var/www#

Comprovació d'autenticació amb usuari "itielweb" i la clau assignada mitjançat http en el navegador:

	Index of /webdav
	[ICO]	Name	Last modified	Size	Description
	[PARENTDIR]	Parent Directory	 	- 	 
	[ ]	asd	2019-05-16 12:43 	6 	 
	[TXT]	sample.txt	2019-05-16 10:55 	24 	 
	[DIR]	webdav/	2019-05-16 12:33 	- 	 
	Apache/2.4.25 (Debian) Server at 192.168.56.113 Port 80

Comprovació des de el terminal amb el paquet cadaver:

	itiel@X550JX:~$ cadaver http://192.168.56.113/webdav
	Autenticación requerida para webdav en el servidor '192.168.56.113':
	Nombre de usuario: itielweb
	Contraseña: 
	dav:/webdav/> ls
	Listando colección `/webdav/': exitoso.
	 Col:   webdav                                 0  may 16 12:33
		   *asd                                    6  may 16 12:43
		   *sample.txt                            24  may 16 10:55
	dav:/webdav/> 
	^CTerminado por señal 2.
	Conexión con '192.168.56.113' cerrada.
	itiel@X550JX:~$

Per configurar-lo amb https, es replicarà la explicació de com activar un site segur, però amb les directives del dav.
Es copien les directives dav en el fitxer default-ssl.conf:

	root@esclavo1:/etc/apache2/sites-available# cat default-ssl.conf | grep -v "#"
	<IfModule mod_ssl.c>
		<VirtualHost _default_:443>
			ServerAdmin webmaster@localhost

			DocumentRoot /var/www/html

			ErrorLog ${APACHE_LOG_DIR}/error.log
			CustomLog ${APACHE_LOG_DIR}/access.log combined

			SSLEngine on

			SSLCertificateFile	/etc/ssl/certs/ssl-cert-snakeoil.pem
			SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key

			<FilesMatch "\.(cgi|shtml|phtml|php)$">
					SSLOptions +StdEnvVars
			</FilesMatch>
			<Directory /usr/lib/cgi-bin>
					SSLOptions +StdEnvVars
			</Directory>

		Alias /webdav /var/www/webdav

		<Location /webdav>
		            DAV On
		    	SSLRequireSSL
		            Options None
		            AuthType Basic
		            AuthName webdav
		            AuthUserFile /etc/apache2/.htpasswd
		            Require valid-user
		            Options Includes FollowSymlinks MultiViews
		            Options +Indexes
		            AllowOverride all
		            Order allow,deny
		            Allow from all
		    </Location>


		</VirtualHost>
	</IfModule>

	root@esclavo1:/etc/apache2/sites-available#

Es deshabilitarà, habilitarà i reinicialitzarà l'apache per a que agafi els canvis efectuats:

	root@esclavo1:/etc/apache2/sites-available# a2dissite default-ssl.conf 
	Site default-ssl disabled.
	To activate the new configuration, you need to run:
	  systemctl reload apache2
	root@esclavo1:/etc/apache2/sites-available#

	root@esclavo1:/etc/apache2/sites-available# a2ensite default-ssl.conf 
	Enabling site default-ssl.
	To activate the new configuration, you need to run:
	  systemctl reload apache2
	root@esclavo1:/etc/apache2/sites-available#

	root@esclavo1:/etc/apache2/sites-available# systemctl reload apache2
	root@esclavo1:/etc/apache2/sites-available# 

Comprovacions amb el navegador i amb cadaver:

	Index of /webdav
	[ICO]	Name	Last modified	Size	Description
	[PARENTDIR]	Parent Directory	 	- 	 
	[ ]	asd	2019-05-16 12:43 	6 	 
	[TXT]	sample.txt	2019-05-16 10:55 	24 	 
	[DIR]	webdav/	2019-05-16 12:33 	- 	 
	Apache/2.4.25 (Debian) Server at 192.168.56.113 Port 443

	itiel@X550JX:~$ cadaver https://192.168.56.113/webdav
	WARNING: Untrusted server certificate presented for `esclavo1':
	Certificate was issued to hostname `esclavo1' rather than `192.168.56.113'
	This connection could have been intercepted.
	Issued to: esclavo1
	Issued by: esclavo1
	Certificate is valid from Thu, 16 May 2019 07:10:18 GMT to Sun, 13 May 2029 07:10:18 GMT
	Do you wish to accept the certificate? (y/n) y
	Autenticación requerida para webdav en el servidor '192.168.56.113':
	Nombre de usuario: itielweb
	Contraseña: 
	dav:/webdav/> ls
	Listando colección `/webdav/': exitoso.
	 Col:   webdav                                 0  may 16 12:33
		   *asd                                    6  may 16 12:43
		   *sample.txt                            24  may 16 10:55
	dav:/webdav/> exit
	Conexión con '192.168.56.113' cerrada.
	itiel@X550JX:~$

	NOTA: Es pot veure com cadaver detecta el certificat i pregunta si confiem en aquest.


# WEBMIN
--------

Instal·lació de dependències per a Debian 9:

 $ apt install software-properties-common apt-transport-https wget

Importació de la clau del repositori de webmin:

	root@esclavo1:~# wget -q http://www.webmin.com/jcameron-key.asc -O- | sudo apt-key add -
	sudo: unable to resolve host esclavo1: Expiró el tiempo de conexión
	OK
	root@esclavo1:~#


Agregació del repositori a les llistes /etc/apt/sources.list:

	root@esclavo1:~# add-apt-repository "deb [arch=amd64] http://download.webmin.com/download/repository sarge contrib"
	root@esclavo1:~#

Actualització i instal·lació de webmin:

	root@esclavo1:~# apt update && sudo apt install webmin
	.
	.
	.
	Webmin install complete. You can now login to https://esclavo1:10000/
	as root with your root password, or as any user who can use sudo
	to run commands as root.
	Procesando disparadores para systemd (241-3~bpo9+1) ...
	root@esclavo1:~#

Per defecte el servei s'inicialitza amb protocol HTTPS i no permet HTTP.

Es pot canviar per a què sigui forçosament HTTP canviant la directiva el 1 per un 0:

	root@esclavo1:/etc/webmin# cat miniserv.conf | grep ssl=
	ssl=0
	root@esclavo1:/etc/webmin#

	NOTA: No li agrada funcionar sobre HTTP, llença error de cookies.



# SEGURETAT
-----------

Regles bàsiques per a http, https, dav i davs sense estat:

	iptables -A INPUT -p tcp --dport 80 -j ACCEPT
	iptables -A INPUT -p tcp --dport 443 -j ACCEPT

Regles bàsiques per al webmin:

	iptables -A INPUT -p tcp --dport 10000 -j ACCEPT

	NOTA: Es pot canviar el port en el fitxer de configuració del servidor de webmin.

Regles amb estats:

	iptables -A INPUT -i enp0s3 -p tcp -m state --state ESTABLISHED --sport 80 -j ACCEPT
	iptables -A INPUT -i enp0s3 -p tcp -m state --state ESTABLISHED --sport 443 -j ACCEPT
	iptables -A INPUT -i enp0s3 -p tcp -m state --state ESTABLISHED --sport 10000 -j ACCEPT
	iptables -A OUTPUT -o enp0s3 -p tcp -m state --state NEW,ESTABLISHED --dport 80 -j ACCEPT
	iptables -A OUTPUT -o enp0s3 -p tcp -m state --state NEW,ESTABLISHED --dport 443 -j ACCEPT
	iptables -A OUTPUT -o enp0s3 -p tcp -m state --state NEW,ESTABLISHED --dport 10000 -j ACCEPT


# Pràctica 3 - Sessió 4 - Implementar un servei de xarxa privada virtual. (Luque Díaz Itiel)
--------------------------------------------------------------------------------------------

# PROGRAMARI NECESSARI
----------------------

* Editor de textos (Gedit p.exemple)
* nano/pico (opcionalment)
* OpenVPN (apt-get install openvpn)
* EasyRsa (apt-get install easyrsa)


# FITXER RELACIONATS
--------------------

* /etc/openvpn/server.conf			--> Configuració del servidor openvpn.
* /etc/openvpn/openvpn.conf			--> Configuració del client openvpn.


# ESCENARI
----------

Recuperant l'escenari de la pràctica 2, aquest servidor VPN hauria estat en el propi router 1 o bé també podria haver estat
en un dels servidors de la DMZ com a últim recurs, ja que, aquests estaven limitats només a servir DNS i SSH.

Els clients a través d'Internet és podrien connectar a la VPN i accedir a tots els recursos necessaris especificant les rutes
necessàries entre routers per poder arribar a on calgui.

- Servidor VPN 			-->	192.168.56.113
- Client VPN (Linux)	-->	192.168.56.115


# COMANDES OPENVPN
------------------

* systemctl start openvpn				--> Inicialitza el demoni.
* systemctl start openvpn@server		--> Carrega la configuració del servidor.
* systemctl status openvpn*.service		--> Comprova l'estat del demoni.
* systemctl enable openvpn				--> Configuració per a que es carregui a l'iniciar el sistema del client.
* systemctl enable openvpn@server		--> Configuració per a que es carregui a l'iniciar el sistema del servidor.


# CONSIDERACIONS
----------------

- Cada client tindrà el seu propi fitxer de configuració (.ovpn) amb les seves claus i paràmetres de configuració.
- Cada dispositiu d'un mateix client, amb un mateix fitxer de configuració, tindrà diferents ips assignades pel servidor.
- Per diferenciar clients, és necessari canviar les variables del certificat de cadascun d'ells.


# DESCRIPCIÓ
------------

En aquest punt ja es té un ecosistema sòlid i funcional, però, en una xarxa local, on els recursos es poden accedir només si la
persona es troba físicament en el mateix lloc dels serveis. Per poder fer servir aquests des d'un lloc geogràficament diferent
és impossible fer-ho amb tots els serveis que implica estar connectat a una xarxa (ip, gateway, dns... etc) amb seguretat.
En aquests casos, la millor opció es recorre a una VPN (Virtual Private Network) on ofereix tots aquests avantatges i a més
autentica els paquets d'origen. Però, no tot és bo o dolent, hi ha un preu que s'ha de pagar per incloure el xifratge, paquets
més grossos, més càlculs (xifratge), etc. Es pot balancejar les necessitats, bé només xifrant allò que hagi d'anar a parar al
servidor on es troben els recursos o en altre cas xifrant-ho tot. En qualsevol dels casos, guanyarem estar connectats en una
xarxa d'àrea local a través d'Internet.


# CREACIÓ I CONFIGURACIÓ CA
---------------------------

Primerament s'ha de crear la ruta dels certificats en la carpeta de OpenVPN:

	root@esclavo1:/usr/share/easy-rsa# make-cadir /etc/openvpn/certs
	root@esclavo1:/usr/share/easy-rsa#

S'ha de crear un soft link amb la configuració més actualitzada en la carpeta creada previament:

	root@esclavo1:/etc/openvpn/certs# ln -s openssl-1.0.0.cnf openssl.cnf
	root@esclavo1:/etc/openvpn/certs#

Cal modificar les variables i ajustar-les a les dades amb les que es volen validar els certificats:

	root@esclavo1:/usr/share/easy-rsa# cat vars | grep "KEY_"
	export KEY_CONFIG=`$EASY_RSA/whichopensslcnf $EASY_RSA`
	export KEY_DIR="$EASY_RSA/keys"
	echo NOTE: If you run ./clean-all, I will be doing a rm -rf on $KEY_DIR
	export KEY_SIZE=2048
	export KEY_EXPIRE=3650
	export KEY_COUNTRY="ES"
	export KEY_PROVINCE="BCN"
	export KEY_CITY="Vilanova i la Geltrú"
	export KEY_ORG="Universitat Politècnica de Catalunya"
	export KEY_EMAIL="itiel@admin.com"
	export KEY_OU="Seguretat i Administració de Xarxes"
	export KEY_NAME="EasyRSA"
	# If you'd like to sign all keys with the same Common Name, uncomment the KEY_CN export below
	# export KEY_CN="CommonName"
	root@esclavo1:/usr/share/easy-rsa#

S'han de validar, és a dir, tornar a carregar i netejar la configuració que hi ha previament:

	root@esclavo1:/etc/openvpn/certs# source ./vars
	NOTE: If you run ./clean-all, I will be doing a rm -rf on /etc/openvpn/certs/keys
	root@esclavo1:/etc/openvpn/certs#

	root@esclavo1:/etc/openvpn/certs# ./clean-all
	root@esclavo1:/etc/openvpn/certs#

Ja es pot construir la entitat certificadora amb els paràmetres que s'han configurat. Deixar en buit per utilitzar-los:

	root@esclavo1:/etc/openvpn/certs# ./build-ca 
	Generating a RSA private key
	........+++++
	................+++++
	writing new private key to 'ca.key'
	-----
	You are about to be asked to enter information that will be incorporated
	into your certificate request.
	What you are about to enter is what is called a Distinguished Name or a DN.
	There are quite a few fields but you can leave some blank
	For some fields there will be a default value,
	If you enter '.', the field will be left blank.
	-----
	Country Name (2 letter code) [ES]:
	State or Province Name (full name) [BCN]:
	Locality Name (eg, city) [Vilanova i la Geltrú]:
	Organization Name (eg, company) [Universitat Politècnica de Catalunya]:
	Organizational Unit Name (eg, section) [Seguretat i Administració de Xarxes]:
	Common Name (eg, your name or your server's hostname) [Universitat Politècnica de Catalunya CA]:
	Name [EasyRSA]:
	Email Address [itiel@admin.com]:
	root@esclavo1:/etc/openvpn/certs#

Es necessari crear un certificat per validar el servidor CA i signar-lo:

	root@esclavo1:/etc/openvpn/certs# ./build-key-server server
	Generating a RSA private key
	..+++++
	........................................................................................................................................................+++++
	writing new private key to 'server.key'
	-----
	You are about to be asked to enter information that will be incorporated
	into your certificate request.
	What you are about to enter is what is called a Distinguished Name or a DN.
	There are quite a few fields but you can leave some blank
	For some fields there will be a default value,
	If you enter '.', the field will be left blank.
	-----
	Country Name (2 letter code) [ES]:
	State or Province Name (full name) [BCN]:
	Locality Name (eg, city) [Vilanova i la Geltrú]:
	Organization Name (eg, company) [Universitat Politècnica de Catalunya]:
	Organizational Unit Name (eg, section) [Seguretat i Administració de Xarxes]:
	Common Name (eg, your name or your server's hostname) [server]:
	Name [EasyRSA]:
	Email Address [itiel@admin.com]:

	Please enter the following 'extra' attributes
	to be sent with your certificate request
	A challenge password []:
	An optional company name []:
	Using configuration from /etc/openvpn/certs/openssl.cnf
	Can't open /etc/openvpn/certs/keys/index.txt.attr for reading, No such file or directory
	140575243108416:error:02001002:system library:fopen:No such file or directory:../crypto/bio/bss_file.c:74:fopen('/etc/openvpn/certs/keys/index.txt.attr','r')
	140575243108416:error:2006D080:BIO routines:BIO_new_file:no such file:../crypto/bio/bss_file.c:81:
	Check that the request matches the signature
	Signature ok
	The Subject's Distinguished Name is as follows
	countryName           :PRINTABLE:'ES'
	stateOrProvinceName   :PRINTABLE:'BCN'
	localityName          :T61STRING:'Vilanova i la Geltr\0xFFFFFFC3\0xFFFFFFBA'
	organizationName      :T61STRING:'Universitat Polit\0xFFFFFFC3\0xFFFFFFA8cnica de Catalunya'
	organizationalUnitName:T61STRING:'Seguretat i Administraci\0xFFFFFFC3\0xFFFFFFB3 de Xarxes'
	commonName            :PRINTABLE:'server'
	name                  :PRINTABLE:'EasyRSA'
	emailAddress          :IA5STRING:'itiel@admin.com'
	Certificate is to be certified until May 20 09:24:14 2029 GMT (3650 days)
	Sign the certificate? [y/n]:y


	1 out of 1 certificate requests certified, commit? [y/n]y
	Write out database with 1 new entries
	Data Base Updated
	root@esclavo1:/etc/openvpn/certs#

Per intercanviar les claus entre client i servidor és necessari crear un certificat per utilitzar Diffie-Hellman:

	root@esclavo1:/etc/openvpn/certs# openssl dhparam 4096 > /etc/openvpn/dh4096.pem
	Generating DH parameters, 4096 bit long safe prime, generator 2
	This is going to take a long time
	.
	.
	.
	root@esclavo1:/etc/openvpn/certs#

Per autenticar els paquets que s'intercanvien entre màquines i només acceptar aquells que es coneixen, s'ha de crear una clau HMAC per autenticar-los:

	root@esclavo1:/etc/openvpn/certs# openvpn --genkey --secret /etc/openvpn/certs/keys/ta.key
	root@esclavo1:/etc/openvpn/certs#


# CONFIGURACIÓ SERVIDOR OPENVPN
-------------------------------

OpenVPN ofereix configuració bàsica per facilitar a l'usuari, per això, es copiarà els fitxers:

	root@esclavo1:/etc/openvpn# gunzip -c /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz > /etc/openvpn/server.conf
	root@esclavo1:/etc/openvpn#

En aquest punt, s'han d'especificar les claus i certificats que s'han generat perquè els faci servir el servidor:

	root@esclavo1:/etc/openvpn# cat server.conf 
	.
	.
	.
	ca /etc/openvpn/certs/keys/ca.crt
	cert /etc/openvpn/certs/keys/server.crt
	key /etc/openvpn/certs/keys/server.key  # This file should be kept secret
	.
	.
	.
	dh dh4096.pem
	.
	.
	.
	tls-auth /etc/openvpn/certs/keys/ta.key 0 # This file is secret
	.
	.
	.
	root@esclavo1:/etc/openvpn#

Com a punt opcional, es pot reforçar la seguretat. És un pas important si es vol maximitzar la seguretat. En aquest cas, en l'escenari de proves
no es necessari, però, es comentarà per si en un futur cal securitzar i prioritzar el xifrat. Cal buscar les seccions següents i ficar les directives:

Reforça l'encriptació:

	# Select a cryptographic cipher.
	cipher AES-256-CBC

Reforça l'autenticació dels usuaris:

	# Auth Digest
	auth SHA512

Reforça el limit dels xifrats:

	# Limit Ciphers
	tls-cipher TLS-DHE-RSA-WITH-AES-256-GCM-SHA384:TLS-DHE-RSA-WITH-AES-128-GCM-SHA256:TLS-DHE-RSA-WITH-AES-256-CBC-SHA:TLS-DHE-RSA-WITH-CAMELLIA-256-CBC-SHA:TLS-DHE-RSA-WITH-AES-128-CBC-SHA:TLS-DHE-RSA-WITH-CAMELLIA-128-CBC-SHA

Cal descomentar aquesta directiva per a redirigir el tràfic i el DNS:

	root@esclavo1:/etc/openvpn# cat server.conf 
	.
	.
	.
	push "redirect-gateway def1 bypass-dhcp"
	.
	.
	.
	push "dhcp-option DNS 208.67.222.222"
	push "dhcp-option DNS 208.67.220.220"
	.
	.
	.
	root@esclavo1:/etc/openvpn#

Per assignar a cada dispositiu d'un client diferents ips, s'ha d'afegir una directiva que indica que un mateix client
farà servir el mateix certificat per a tots els seus dispositius:

	root@esclavo1:/etc/openvpn# cat server.conf 
	.
	.
	.
	duplicate-cn
	.
	.
	.
	root@esclavo1:/etc/openvpn#

	NOTA: Per evitar això, caldria fer un certificat per a cada dispositiu encara que fos el mateix client.

Es necessari activar el bit de forwarding:

	root@esclavo1:/etc/openvpn/# echo 1 > /proc/sys/net/ipv4/ip_forward
	root@esclavo1:/etc/openvpn/#

	NOTA: Per fer-lo persiste cal canviar-lo en el fitxer /etc/sysctl.conf, cal descomentar la directiva net.ipv4.ip_forward.


Validació de la interfície:

	root@esclavo1:/etc/openvpn# ip addr list tun0
	4: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 100
		link/none 
		inet 10.10.10.1 peer 10.10.10.2/32 scope global tun0
		   valid_lft forever preferred_lft forever
		inet6 fe80::4aed:3dc5:3e60:2c73/64 scope link flags 800 
		   valid_lft forever preferred_lft forever
	root@esclavo1:/etc/openvpn#


# GENERACIÓ FITXER DE CONFIGURACIÓ .OVPN
----------------------------------------

S'ha de situar-se'n en la carpeta dels certificats i actualitzar les variables per a signar un certificat per als clients:

	root@esclavo1:/etc/openvpn# cd /etc/openvpn/certs
	root@esclavo1:/etc/openvpn/certs#

	root@esclavo1:/etc/openvpn/certs# source ./vars
	root@esclavo1:/etc/openvpn/certs#

Signatura del certificat per al primer client:

	root@esclavo1:/etc/openvpn/certs# ./build-key firstclient
	Generating a RSA private key
	...................................................+++++
	............+++++
	writing new private key to 'firstclient.key'
	-----
	You are about to be asked to enter information that will be incorporated
	into your certificate request.
	What you are about to enter is what is called a Distinguished Name or a DN.
	There are quite a few fields but you can leave some blank
	For some fields there will be a default value,
	If you enter '.', the field will be left blank.
	-----
	Country Name (2 letter code) [ES]:
	State or Province Name (full name) [BCN]:
	Locality Name (eg, city) [Vilanova i la Geltrú]:
	Organization Name (eg, company) [Universitat Politècnica de Catalunya]:
	Organizational Unit Name (eg, section) [Seguretat i Administració de Xarxes]:
	Common Name (eg, your name or your server's hostname) [firstclient]:
	Name [EasyRSA]:
	Email Address [itiel@admin.com]:

	Please enter the following 'extra' attributes
	to be sent with your certificate request
	A challenge password []:
	An optional company name []:
	Using configuration from /etc/openvpn/certs/openssl.cnf
	Check that the request matches the signature
	Signature ok
	The Subject's Distinguished Name is as follows
	countryName           :PRINTABLE:'ES'
	stateOrProvinceName   :PRINTABLE:'BCN'
	localityName          :T61STRING:'Vilanova i la Geltr\0xFFFFFFC3\0xFFFFFFBA'
	organizationName      :T61STRING:'Universitat Polit\0xFFFFFFC3\0xFFFFFFA8cnica de Catalunya'
	organizationalUnitName:T61STRING:'Seguretat i Administraci\0xFFFFFFC3\0xFFFFFFB3 de Xarxes'
	commonName            :PRINTABLE:'firstclient'
	name                  :PRINTABLE:'EasyRSA'
	emailAddress          :IA5STRING:'itiel@admin.com'
	Certificate is to be certified until May 20 15:21:23 2029 GMT (3650 days)
	Sign the certificate? [y/n]:y


	1 out of 1 certificate requests certified, commit? [y/n]y
	Write out database with 1 new entries
	Data Base Updated
	root@esclavo1:/etc/openvpn/certs#

S'ha de crear un directori on ficar la configuració que es transferirá al client:

	root@esclavo1:/etc/openvpn/certs# mkdir /etc/openvpn/clients
	root@esclavo1:/etc/openvpn/certs#

Així com es va copiar la configuració bàsica al servidor, també es farà per al client:

	root@esclavo1:/etc/openvpn/certs# cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /etc/openvpn/clients/client.ovpn
	root@esclavo1:/etc/openvpn/certs#

Es crearà un script per incloure els certificats i claus necessaris en el mateix fitxer de configuració del client (.ovpn):

	#!/bin/bash

	echo "key-direction 1" >> client.ovpn
	echo "<ca>" >> client.ovpn
	sed -n '/BEGIN CERTIFICATE/,/END CERTIFICATE/p' < ../certs/keys/ca.crt >> client.ovpn
	echo "</ca>" >> client.ovpn
	echo "<cert>" >> client.ovpn
	sed -n '/BEGIN CERTIFICATE/,/END CERTIFICATE/p' < ../certs/keys/firstclient.crt >> client.ovpn
	echo "</cert>" >> client.ovpn
	echo "<key>" >> client.ovpn
	sed -n '/BEGIN PRIVATE KEY/,/END PRIVATE KEY/p' < ../certs/keys/firstclient.key >> client.ovpn
	echo "</key>" >> client.ovpn
	echo "<tls-auth>" >> client.ovpn
	sed -n '/-----BEGIN OpenVPN Static key V1-----/,/-----BEGIN OpenVPN Static key V1-----/p' < ../certs/keys/ta.key >> client.ovpn
	echo "</tls-auth>" >> client.ovpn

Resultat del fitxer de configuració del client que ha de fer servir per poder connectar-se al servidor VPN:

	root@esclavo1:/etc/openvpn/clients# cat client.ovpn | grep -v ";" | grep -v "#"
	client
	dev tun
	proto udp
	remote 192.168.56.113 1194
	resolv-retry infinite
	nobind
	user nobody
	group nogroup
	persist-key
	persist-tun
	#ca ca.crt
	#cert client.crt
	#key client.key
	remote-cert-tls server
	#tls-auth ta.key 1
	cipher AES-256-CBC
	verb 3
	key-direction 1
	<ca>
	-----BEGIN CERTIFICATE-----
	MIIF8jCCBNqgAwIBAgIJAO7rYtR3Uiv5MA0GCSqGSIb3DQEBCwUAMIH/MQswCQYD
	VQQGEwJFUzEMMAoGA1UECBMDQkNOMR4wHAYDVQQHFBVWaWxhbm92YSBpIGxhIEdl
	bHRyw7oxLjAsBgNVBAoUJVVuaXZlcnNpdGF0IFBvbGl0w6hjbmljYSBkZSBDYXRh
	bHVueWExLTArBgNVBAsUJFNlZ3VyZXRhdCBpIEFkbWluaXN0cmFjacOzIGRlIFhh
	cnhlczExMC8GA1UEAxQoVW5pdmVyc2l0YXQgUG9saXTDqGNuaWNhIGRlIENhdGFs
	dW55YSBDQTEQMA4GA1UEKRMHRWFzeVJTQTEeMBwGCSqGSIb3DQEJARYPaXRpZWxA
	YWRtaW4uY29tMB4XDTE5MDUyMzA5MTQ1NloXDTI5MDUyMDA5MTQ1Nlowgf8xCzAJ
	BgNVBAYTAkVTMQwwCgYDVQQIEwNCQ04xHjAcBgNVBAcUFVZpbGFub3ZhIGkgbGEg
	R2VsdHLDujEuMCwGA1UEChQlVW5pdmVyc2l0YXQgUG9saXTDqGNuaWNhIGRlIENh
	dGFsdW55YTEtMCsGA1UECxQkU2VndXJldGF0IGkgQWRtaW5pc3RyYWNpw7MgZGUg
	WGFyeGVzMTEwLwYDVQQDFChVbml2ZXJzaXRhdCBQb2xpdMOoY25pY2EgZGUgQ2F0
	YWx1bnlhIENBMRAwDgYDVQQpEwdFYXN5UlNBMR4wHAYJKoZIhvcNAQkBFg9pdGll
	bEBhZG1pbi5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDD6DHU
	0dO2FQU5ADh9/pBc8uP81Xe6KCeOJFM4r9LQKBpyIKKweLMAGCN2dfJhVEA7c+fW
	p++pL5BBnSdQ6qMsgJrUc/vxU+HfLu5its7ew/PU18Kzh3yTN5n89QQeWANPcqaL
	RQ9Ej1twSgMfOD8H6iEcKlLO7WdYW0EsbyvG1GdRe+wY0rGmyKO0wK2KVFadpu7a
	8C1S/HMkcZxLljmgmZNi8HUUh8wXpI+M7OLJR8AuHFeysa9K4KheUw8Ovw0Qmzcw
	ocn2eJ29eRKOiGLjFCq15uQtkt7I5opAfD9jAZ9gvI8TJKAcNBMdO5njSeobb2bS
	ypfONBooRCPBn1hnAgMBAAGjggFtMIIBaTAdBgNVHQ4EFgQUVlp9SFDmS44BJXr+
	cfFqXpVAHlgwggE4BgNVHSMEggEvMIIBK4AUVlp9SFDmS44BJXr+cfFqXpVAHlih
	ggEGpIIBAjCB/zELMAkGA1UEBhMCRVMxDDAKBgNVBAgTA0JDTjEeMBwGA1UEBxQV
	VmlsYW5vdmEgaSBsYSBHZWx0csO6MS4wLAYDVQQKFCVVbml2ZXJzaXRhdCBQb2xp
	dMOoY25pY2EgZGUgQ2F0YWx1bnlhMS0wKwYDVQQLFCRTZWd1cmV0YXQgaSBBZG1p
	bmlzdHJhY2nDsyBkZSBYYXJ4ZXMxMTAvBgNVBAMUKFVuaXZlcnNpdGF0IFBvbGl0
	w6hjbmljYSBkZSBDYXRhbHVueWEgQ0ExEDAOBgNVBCkTB0Vhc3lSU0ExHjAcBgkq
	hkiG9w0BCQEWD2l0aWVsQGFkbWluLmNvbYIJAO7rYtR3Uiv5MAwGA1UdEwQFMAMB
	Af8wDQYJKoZIhvcNAQELBQADggEBAHrwo6CT/32QS/GZhPmkr5z2JfwRsFaakrnA
	HDR9ESp9NbYoRtP28CchYhPfWUnTf/c7keL8PQRoylTKnFj/GwUvCxQ/DbUavGQz
	Y/FdFw0BJ7XNm1vhkugztJeK9ISS0CFfuGPUH4aCbGcdDRENfbEXDoAMQUgpJ5nl
	oDJAAiG3MgjFPNQY3o+QWNvqsXy9s7jBgE7JL/2zLmGrJ4nBHBsv5nNhuSFAIgz0
	kVRsA2gUdxqdmyvoxzQHzmjUXT1JdZ1pKFMJVpl1F4OBT9pTurBlvtC5MPl5O6GI
	OIwkuh2vqLvgW/xCoaxgwDUTVnEd5kd7eY9bBft849yeX3gdtQw=
	-----END CERTIFICATE-----
	</ca>
	<cert>
	-----BEGIN CERTIFICATE-----
	MIIGMzCCBRugAwIBAgIBAjANBgkqhkiG9w0BAQsFADCB/zELMAkGA1UEBhMCRVMx
	DDAKBgNVBAgTA0JDTjEeMBwGA1UEBxQVVmlsYW5vdmEgaSBsYSBHZWx0csO6MS4w
	LAYDVQQKFCVVbml2ZXJzaXRhdCBQb2xpdMOoY25pY2EgZGUgQ2F0YWx1bnlhMS0w
	KwYDVQQLFCRTZWd1cmV0YXQgaSBBZG1pbmlzdHJhY2nDsyBkZSBYYXJ4ZXMxMTAv
	BgNVBAMUKFVuaXZlcnNpdGF0IFBvbGl0w6hjbmljYSBkZSBDYXRhbHVueWEgQ0Ex
	EDAOBgNVBCkTB0Vhc3lSU0ExHjAcBgkqhkiG9w0BCQEWD2l0aWVsQGFkbWluLmNv
	bTAeFw0xOTA1MjMxNTIxMjNaFw0yOTA1MjAxNTIxMjNaMIHiMQswCQYDVQQGEwJF
	UzEMMAoGA1UECBMDQkNOMR4wHAYDVQQHFBVWaWxhbm92YSBpIGxhIEdlbHRyw7ox
	LjAsBgNVBAoUJVVuaXZlcnNpdGF0IFBvbGl0w6hjbmljYSBkZSBDYXRhbHVueWEx
	LTArBgNVBAsUJFNlZ3VyZXRhdCBpIEFkbWluaXN0cmFjacOzIGRlIFhhcnhlczEU
	MBIGA1UEAxMLZmlyc3RjbGllbnQxEDAOBgNVBCkTB0Vhc3lSU0ExHjAcBgkqhkiG
	9w0BCQEWD2l0aWVsQGFkbWluLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCC
	AQoCggEBAN2WLqchUtump4ruYg/XANvUeuvYBA+Zxawm/m/OTpldDUevYtSLc9zb
	0YiYOIuK0P07J8xzndPnx4tkp6kj8RMPWUWA+y7+CE60eeNyXGSta0ZNdFYa7MEN
	VQOrCyR1ACvy5SIjmBcCZzBGPHqFBPT0+67T7JkwDoEJomuUXTSCqOJuqD//cd6t
	CPv3aWF7DKDnidLzOLerqtwUxGsm3XKepVf5XbNWqG0yj65WuItOhGqecUnRNAhc
	/f52/FQt+Ii6mhHUC78PCWjOE16N3TjNGEBKBHNPqz8U0l40dkcKZAMOjjKvR+vy
	QWzua78ZrvlYHJ9evBSZ9guK9va3kr0CAwEAAaOCAdMwggHPMAkGA1UdEwQCMAAw
	LQYJYIZIAYb4QgENBCAWHkVhc3ktUlNBIEdlbmVyYXRlZCBDZXJ0aWZpY2F0ZTAd
	BgNVHQ4EFgQUEWbuokcc4qBks/im36/em/ZabfAwggE4BgNVHSMEggEvMIIBK4AU
	Vlp9SFDmS44BJXr+cfFqXpVAHlihggEGpIIBAjCB/zELMAkGA1UEBhMCRVMxDDAK
	BgNVBAgTA0JDTjEeMBwGA1UEBxQVVmlsYW5vdmEgaSBsYSBHZWx0csO6MS4wLAYD
	VQQKFCVVbml2ZXJzaXRhdCBQb2xpdMOoY25pY2EgZGUgQ2F0YWx1bnlhMS0wKwYD
	VQQLFCRTZWd1cmV0YXQgaSBBZG1pbmlzdHJhY2nDsyBkZSBYYXJ4ZXMxMTAvBgNV
	BAMUKFVuaXZlcnNpdGF0IFBvbGl0w6hjbmljYSBkZSBDYXRhbHVueWEgQ0ExEDAO
	BgNVBCkTB0Vhc3lSU0ExHjAcBgkqhkiG9w0BCQEWD2l0aWVsQGFkbWluLmNvbYIJ
	AO7rYtR3Uiv5MBMGA1UdJQQMMAoGCCsGAQUFBwMCMAsGA1UdDwQEAwIHgDAWBgNV
	HREEDzANggtmaXJzdGNsaWVudDANBgkqhkiG9w0BAQsFAAOCAQEAID0Aq8poNiwG
	tIN89Y+fpPxsWy8Q3Opk0QsC19/D+60D5KX5v1Eq88+fvmkkxiJJAjpYD+LRTn4E
	sWvQL0YsmKqLlkdXs0yHIjnuzkpGEI5bnBXqrO0Rd8Q9LVqloIa23PNDRQzpU1Hh
	6frEGgwZ2DDDe2DoT/uC2gf087ThsPCHqZntUrCnIRFurww1Vq3fi70zaq7OeXF3
	30LC9Dt/lXPQIFaUUVge9eAqNANIuFtPxaVp/fp4MN6d9w0uoFKipxW/gEULYl1r
	3YHzIcjfMuzoGgdgpuJa8Nq4LJs5qwjIScAxlF6LkQY51dlu1IVLdZm7tHqqPjeY
	yla371I10Q==
	-----END CERTIFICATE-----
	</cert>
	<key>
	-----BEGIN PRIVATE KEY-----
	MIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDdli6nIVLbpqeK
	7mIP1wDb1Hrr2AQPmcWsJv5vzk6ZXQ1Hr2LUi3Pc29GImDiLitD9OyfMc53T58eL
	ZKepI/ETD1lFgPsu/ghOtHnjclxkrWtGTXRWGuzBDVUDqwskdQAr8uUiI5gXAmcw
	Rjx6hQT09Puu0+yZMA6BCaJrlF00gqjibqg//3HerQj792lhewyg54nS8zi3q6rc
	FMRrJt1ynqVX+V2zVqhtMo+uVriLToRqnnFJ0TQIXP3+dvxULfiIupoR1Au/Dwlo
	zhNejd04zRhASgRzT6s/FNJeNHZHCmQDDo4yr0fr8kFs7mu/Ga75WByfXrwUmfYL
	ivb2t5K9AgMBAAECggEBAJ+jZgL0aAxk+UmHSlCdFjpJzzEAVJSktRu8kAwettOY
	jUu62FnGCffwyfk9qWcm4D/AEYEjPm5/CmyrXHrnsPOJWEhRjyUg0P1a2oF5T4Uc
	xy9D9+9cwHqozzmwTXu7ax8+g8Nfn1/cVFkcENA36wVLRdODTG5kh96BAWm93pRH
	wk/6FgqvtzdQ8msS7ykVTXlrXZ/95MP3ADwDfyWjVAAe3OY7ODUNHTRyezCAeUB6
	Xyw17ndvGEdCSuw+CUWBdXZHy1/rSXax4ajvaz5KRnC34C1FAcvr03oYfaqMswgI
	pAonUDfOG1a3R4vy2iy+fGt8gD+Ic192ROoK+H4c+UECgYEA974zxPlVZGoUusaf
	t6WJQRi4Lw4XuHOz4fUP7lADEpiAbPHc7t19dBnonTKj+RFdLrGugCN4IRaHdmqr
	iS0MRkhEaKPtT0fOshA8yhEflh8sRwjG04wbeBtV35HHiDqgyyLo3zu8vLJIUf32
	NUk1ufLdt/wkjZFJmCVWs+m7bu0CgYEA5PjO9nGtqKIRhBCmYfA7WNHyYkVmR1Gm
	HhDXHJjGpPBdguLItZoV2oMfnTjlQVmTTCejRs3+ShyVYYBH+Wd53RvXDyA2Ewc7
	Fzy22Vm4OtzYhgSsu+x7R7SqWf1sFLV2KNjindzs66KIa6JV41fl06tVqRRTlvfm
	W+9NirUeaRECgYEAjqg900zn+RyEt1Cso+l0ccG0PZRV4GbvzEt7UvVL76dVPGbB
	m+J63SIWKn8AoOl4yOyT2UGTaSo58txVznXcPZRboA3VFvP4d9yVxJ27nIxyyKyr
	ISHqp2zGNCkTxsRL1u1RP0p80gOvVVdyMRjpERxixBEzUzm4MR4/IPaUcbkCgYBP
	MYsLi9ffamaagdO6LgeoubyWpqAwbJoC7hoohuK1q3j8SwnWXbvPPujRTRtl1eBv
	R4pec+LOqUI1XdQG+/YXNojUb3SkcizK5bHsTO6+VSICgF1qBenBrEf7Jf6azwRW
	LmV66i17dlSuvY/tOLqB0lGnUCN1JLqk84ijP++LsQKBgQCHgCUzJiQKn1xUxe7n
	vANrOb53u7oqtL+cRoulA/BdeJapOh9vLyVCg2eIQxG7InR+fDQkS+s4pGkPEFL8
	EQiJwVJZZJs/XYu8Trh37LOHMihdqQjfzc1POAhfR6PPJECcUpJC2zULqbssaOpr
	jQIcnKWShka/H65PP2e7YJ/FPw==
	-----END PRIVATE KEY-----
	</key>
	<tls-auth>
	-----BEGIN OpenVPN Static key V1-----
	0a9845e091cb7d832bab1c11aec3e26a
	1a440f50ea4a5564d783a94e1d1583fa
	5275ce312cf04cec092345e421bb0ad1
	7f8280a93ccf1a62fdc25c9fbd1ef3e9
	0e00749f32055a9b1aba154c8f7103a8
	e39e89042ca709cb94e68b50b5b33d0a
	963b847d72335cf57beaf29ff9bf7e8d
	67547aa4dde5a24460bb03d15cb0d7b7
	a3351d6fdc7df81ca39b66b88fd9a682
	db76b0b3c5fdf8bad6ff2d8410669c02
	99bbff47c2a9ea2599c1a409e791fec8
	ded71dca7c72196b1cabcdd15776ce58
	1d2d587866d9353207968cafe6631192
	11acc8fd6a4c0b398ee584f3b8a95a74
	e3f09dfea4f6f4f6316d35f6e15e69a8
	a60a15bad54bd976a8baeb9195fd586c
	-----END OpenVPN Static key V1-----
	</tls-auth>
	root@esclavo1:/etc/openvpn/clients#

	NOTA: key-direction 1 és el valor de #tls-auth ta.key 1. S'ha de possar així quan s'insereix els certificat tls en el fitxer .ovpn.
	NOTA2: En aquest punt, ja es pot distribuir el fitxer de configuració al client i pot connectar-se important-lo en la aplicació
		   del mòbil o en un Desktop-client per Linux, Windows o Mac.
	NOTA3: És molt important comentar les directives que es mostren, ja que, s'han incrustat els certificats.


# CONFIGURACIÓ CLIENT LINUX OPENVPN
-----------------------------------

Es torna a insistir que, un cop s'ha generat el fitxer .ovpn, important-lo ja funciona correctment si tots els paràmetres
i la configuració és bona.

Instal·lar el client de openvpn:

	$ apt install openvpn

S'ha de passar el fitxer .ovpn generat per al client i moure'l en /etc/openvpn i renombrar-lo:

	root@seax:~# mv client.ovpn /etc/openvpn/openvpn.conf
	root@seax:~#

Encendre el dimoni i fer que arrenqui al iniciar la màquina:

	root@seax:~# systemctl start openvpn
	root@seax:~#

	root@seax:~# systemctl enable openvpn
	Synchronizing state of openvpn.service with SysV service script with /lib/systemd/systemd-sysv-install.
	Executing: /lib/systemd/systemd-sysv-install enable openvpn
	root@seax:~#

Reinicialitzar la màquina amb un reboot:

	root@seax:~# reboot
	root@seax:~#	

Validació de la interfície tunnel de la VPN aixecada i rebent ip:

	root@seax:~# ip addr list tun0
	4: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 100
		link/none 
		inet 10.10.10.6 peer 10.10.10.5/32 scope global tun0
		   valid_lft forever preferred_lft forever
		inet6 fe80::1a6f:4b88:1d45:47d9/64 scope link flags 800 
		   valid_lft forever preferred_lft forever
	root@seax:~#

Es pot veure en la taula d'encaminament com s'ha afegit la ruta del tunnel de la VPN:

	root@seax:~# ip r
	0.0.0.0/1 via 10.10.10.5 dev tun0 
	default via 10.0.2.2 dev enp0s3 
	10.0.2.0/24 dev enp0s3 proto kernel scope link src 10.0.2.15 
	10.10.10.1 via 10.10.10.5 dev tun0 
	10.10.10.5 dev tun0 proto kernel scope link src 10.10.10.6 
	128.0.0.0/1 via 10.10.10.5 dev tun0 
	192.168.56.0/24 dev enp0s8 proto kernel scope link src 192.168.56.115 
	192.168.56.113 via 10.0.2.2 dev enp0s3 
	root@seax:~#


# SEGURETAT
-----------

La política per defecte és maximitzar la seguretat.

Permetre tràfic local entre la pròpia màquina:

	iptables -A INPUT -i lo -j ACCEPT
	iptables -A INPUT ! -i lo -s 127.0.0.0/8 -j REJECT
	iptables -A OUTPUT -o lo -j ACCEPT

Permetre pings:

	iptables -A INPUT -p icmp -m state --state NEW --icmp-type 8 -j ACCEPT
	iptables -A INPUT -p icmp -m state --state ESTABLISHED,RELATED -j ACCEPT
	iptables -A OUTPUT -p icmp -j ACCEPT

Permetre tràfic de la VPN:

	iptables -A INPUT -i enp0s3 -p udp -m state --state NEW,ESTABLISHED --dport 1194 -j ACCEPT
	iptables -A OUTPUT -o enp0s3 -p udp -m state --state ESTABLISHED --sport 1194 -j ACCEPT

	NOTA: S'ha espicificat el port i protocol per defecte.

Permetre consultes DNS:

	iptables -A INPUT -i enp0s3 -p udp -m state --state ESTABLISHED --sport 53 -j ACCEPT
	iptables -A OUTPUT -o enp0s3 -p udp -m state --state NEW,ESTABLISHED --dport 53 -j ACCEPT
	iptables -A INPUT -i enp0s3 -p tcp -m state --state ESTABLISHED --sport 53 -j ACCEPT
	iptables -A OUTPUT -o enp0s3 -p tcp -m state --state NEW,ESTABLISHED --dport 53 -j ACCEPT

Permetre protocols HTTP i HTTPS per poder navegar i actualitzar paquets:

	iptables -A INPUT -i enp0s3 -p tcp -m state --state ESTABLISHED --sport 80 -j ACCEPT
	iptables -A INPUT -i enp0s3 -p tcp -m state --state ESTABLISHED --sport 443 -j ACCEPT
	iptables -A OUTPUT -o enp0s3 -p tcp -m state --state NEW,ESTABLISHED --dport 80 -j ACCEPT
	iptables -A OUTPUT -o enp0s3 -p tcp -m state --state NEW,ESTABLISHED --dport 443 -j ACCEPT

Permetre tràfic per el tunnel de la VPN:

	iptables -A INPUT -i tun0 -j ACCEPT
	iptables -A FORWARD -i tun0 -j ACCEPT
	iptables -A OUTPUT -o tun0 -j ACCEPT

Cal fer un forwarding del tràfic entre la interfície virtual del tunnel i la física:

	iptables -A FORWARD -i tun0 -o enp0s3 -s 10.10.10.0/24 -j ACCEPT
	iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

Per ultim i molt important, s'ha de natejar les ips de la VPN:

	iptables -t nat -A POSTROUTING -s 10.10.10.0/24 -o enp0s3 -j MASQUERADE


# REFERÈNCIES BIBLIOGRÀFIQUES
-----------------------------

- https://linuxize.com/post/how-to-install-and-configure-samba-on-ubuntu-18-04/
- https://www.linode.com/docs/tools-reference/tools/limiting-access-with-sftp-jails-on-debian-and-ubuntu/
- https://unix.stackexchange.com/questions/209770/ssh-console-login-working-but-sftp-does-not-why
- http://furick.com/icbd/2017/08/mount-a-sftp-connection-to-a-folder-in-ubuntu-linux/
- https://blog.mehl.mx/2014/mounting-a-sftp-storage-in-gnu-linux/
- https://www.digitalocean.com/community/tutorials/how-to-use-sshfs-to-mount-remote-file-systems-over-ssh
- https://www.tecmint.com/sshfs-mount-remote-linux-filesystem-directory-using-ssh/
- https://www.cyberciti.biz/faq/how-to-mount-remote-directory-filesystems-with-sshfs-on-linux/
- https://unix.stackexchange.com/questions/124342/mount-error-13-permission-denied
- http://systemadmin.es/2011/07/montar-un-sistema-de-ficheros-por-samba-cifs-en-linux
- https://www.vozidea.com/borg-backup-copias-de-seguridad-linux
- https://wiki.archlinux.org/index.php/Convert_a_single_drive_system_to_RAID_(Espa%C3%B1ol)
- https://blog.desdelinux.net/crear-matriz-de-disco-con-mdadm/
- http://www.sahw.com/wp/archivos/2007/03/04/como-montar-en-diez-comodos-pasos-un-raid-para-debian-gnulinux/
- https://www.howtogeek.com/51873/how-to-setup-software-raid-for-a-simple-file-server-on-ubuntu/
- https://www.mylinuxplace.com/building-raid-over-network-share/
- https://www.linuxquestions.org/questions/linux-software-2/samba-shares-not-accessible-on-raid-array-825924/
- https://ubuntuforums.org/showthread.php?t=1400363
- https://blog.unelink.es/wiki/reconstruir-raid-con-mdadm-cuando-una-particion-ha-fallado-f/
- https://gitlab.com/mrutten/docs/wikis/drbd-on-debian9
- https://wiki.debian.org/DrBd#Prepare_the_Debian_system
- https://www.canarytek.com/2017/09/06/DRBD_NFS_Cluster.html
- https://docs.linbit.com/docs/users-guide-9.0/#ch-features
- https://servidordebian.org/es/squeeze/internet/webdav/apache2_davfs
- https://linuxnimbus.com/2019/02/01/how-to-configure-webdav-with-apache-on-centos/
- https://maslinux.es/como-instalar-webmin-en-debian-9/
- https://linuxconfig.org/how-to-setup-a-vpn-with-openvpn-on-debian-9-stretch-linux
- https://wiki.debian.org/OpenVPN#Configuration
- https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-debian-9
- https://www2.le.ac.uk/offices/itservices/ithelp/my-computer/files-and-security/work-off-campus/webdav/webdav-on-windows-10
- https://www.hiroom2.com/2017/07/31/debian-9-davfs2-en/
- https://blog.sleeplessbeastie.eu/2017/09/04/how-to-mount-webdav-share/
